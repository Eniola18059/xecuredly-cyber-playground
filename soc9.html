<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lesson 9 ‚Äî DoS / DDoS & Session Hijacking (Expanded + TTS + Quiz)</title>
<style>
  :root{
    --bg:#071428; --card:#0f2136; --muted:#9db7d9; --text:#e9f6ff;
    --accent:#57a7ff; --accent2:#7ef0c8; --danger:#ff7a7a; --ok:#9ef0b2;
    --tts-height:96px; /* will be adjusted by JS */
    --header-height:74px;
    --container-pad:18px;
  }
  *{box-sizing:border-box}
  html { scroll-behavior: smooth; scroll-padding-top: calc(var(--header-height) + 18px); scroll-padding-bottom: calc(var(--tts-height) + 20px); }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:linear-gradient(135deg,var(--bg) 0%, #031427 100%);color:var(--text);-webkit-font-smoothing:antialiased}
  .container{max-width:1100px;margin:0 auto;padding:var(--container-pad);padding-bottom: calc(24px + var(--tts-height));}
  header{position:sticky;top:0;background:rgba(3,10,30,0.6);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03);padding:10px 0;z-index:40}
  .hdr{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:nowrap}
  .left{display:flex;align-items:center;gap:12px;min-width:0}
  .badge{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#021024;padding:8px 12px;border-radius:999px;font-weight:800;flex-shrink:0}
  h1{font-size:clamp(20px,3.6vw,34px);margin:6px 0}
  .subtitle{color:var(--muted);font-size:14px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:18px;border-radius:12px;margin-top:16px;box-shadow:0 10px 30px rgba(0,0,0,0.45)}
  .list{padding-left:18px}
  .list li{margin:8px 0}
  .muted{color:var(--muted)}
  .callout{background:linear-gradient(180deg,rgba(126,240,193,0.04),rgba(126,240,193,0.02));border:1px solid rgba(126,240,193,0.08);padding:10px;border-radius:8px}
  .warn{background:linear-gradient(180deg,rgba(255,123,123,0.04),rgba(255,123,123,0.02));border:1px solid rgba(255,123,123,0.06);padding:10px;border-radius:8px}
  .controls{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  .btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#021024;border:none}
  pre{background:rgba(0,0,0,0.15);padding:12px;border-radius:8px;overflow:auto}
  footer{opacity:.9;padding:30px 0 60px;font-size:13px;color:var(--muted)}
  .section-sub{color:var(--muted);margin-top:6px;font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 350px;gap:18px;align-items:start}
  @media (max-width:1100px){ .grid{grid-template-columns:1fr} }
  .quiz .q{margin:12px 0;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .result{margin-top:12px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .small{font-size:13px;color:var(--muted)}
  code{background:rgba(255,255,255,0.02);padding:2px 6px;border-radius:6px}
  /* TTS bar */
  .tts-bar{
    position:fixed;right:18px;bottom:18px;z-index:9999;background:rgba(1,6,12,0.88);color:#00ffcc;padding:10px 12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6);font-family:'Share Tech Mono',monospace;display:flex;gap:8px;align-items:center;backdrop-filter:blur(6px);min-width:320px;transition:all .14s ease;
  }
  .tts-bar button{background:linear-gradient(45deg,#ff0080,#7928ca);border:none;color:#fff;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer;min-width:44px}
  .tts-bar .small{padding:6px 8px;min-width:36px}
  .tts-bar select,.tts-bar input[type="range"]{background:rgba(255,255,255,0.06);color:#00ffcc;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:8px;font-family:inherit}
  .tts-highlight{background:rgba(0,255,200,0.15);transition:background 0.2s;padding:0 2px;border-radius:3px}
  @media (max-width:600px){.tts-bar{left:50%;transform:translateX(-50%);right:auto;bottom:12px;min-width:88%}}
  /* compact mode */
  .tts-bar[data-compact="true"]{min-width:58px;max-width:58px;padding:6px;border-radius:999px;gap:0;overflow:hidden}
  .tts-bar[data-compact="true"] .tts-controls{display:none}
  .tts-bar[data-compact="true"] #ttsCollapse{border-radius:999px;padding:8px;width:38px;height:38px}
  /* mobile back btn */
  .mobile-back-btn{display:none}
  @media (max-width:1024px){
    .mobile-back-btn{
      display:inline-flex;align-items:center;gap:8px;position:fixed;left:12px;bottom:calc(12px + env(safe-area-inset-bottom));z-index:9998;text-decoration:none;padding:9px 12px;border-radius:999px;background:rgba(255,255,255,0.98);color:#021024;font-weight:700;box-shadow:0 8px 28px rgba(2,6,23,0.36);-webkit-tap-highlight-color:transparent;transition:transform .12s ease,box-shadow .12s ease;border:1px solid rgba(0,0,0,0.06);backdrop-filter:blur(6px)
    }
    .mobile-back-btn:active{transform:translateY(1px)}
    .mobile-back-btn:focus{outline:3px solid rgba(110,168,255,0.12);outline-offset:2px}
  }
  /* small layout tweaks */
  @media (max-width:900px){
    :root{--container-pad:12px;--header-height:68px}
    .hdr{flex-wrap:wrap;align-items:flex-start;padding:10px}
    .subtitle{display:block}
    .badge{padding:6px 10px}
    .container{padding-left:12px;padding-right:12px}
    .card{padding:14px}
  }
  @media (max-width:600px){
    :root{--container-pad:10px;--header-height:64px}
    .subtitle{display:none}
    .hdr{gap:8px}
    .container{padding-left:10px;padding-right:10px}
    .tts-bar{min-width:88%}
  }
  /* mark tag styling (used for highlighting) */
  mark.tts-mark{background:rgba(0,255,200,0.15);padding:0 2px;border-radius:3px;color:inherit}
  /* small focus outline improvements */
  :focus{outline:3px solid rgba(110,168,255,0.12);outline-offset:2px}
  .sidebar{position:sticky;top:calc(var(--header-height) + 10px)}
  .sidebar .card{margin-top:0}
  .sidebar .list a{display:block;padding:8px;border-radius:6px}
  .sidebar .list a:focus{outline:3px solid rgba(99,166,255,0.12);outline-offset:2px}
</style>
</head>
<body>
  <header>
    <div class="container hdr" role="banner">
      <div class="left">
        <span class="badge">Lesson 9</span>
        <div style="min-width:0;overflow:hidden">
          <strong style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">DoS / DDoS & Session Hijacking ‚Äî Expanded</strong>
          <div class="subtitle">Includes 10-question quiz and TTS controls</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
        <button class="btn" id="downloadNotes">üì• Download Notes</button>
        <button class="btn primary" id="copyMd">üìã Copy as Markdown</button>
        <button class="btn" id="toggleTheme" aria-pressed="false" title="Toggle theme">üåó Theme</button>
      </div>
    </div>
  </header>

  <main class="container grid" role="main" aria-live="polite">
    <article class="card lesson-content" aria-live="polite">
      <h1>DoS / DDoS Attacks & Session Hijacking ‚Äî Expanded</h1>
      <p class="section-sub">Concepts, detection, mitigation, incident playbook, safe labs, honeypots, and a 10-question quiz with explanations.</p>

      <section class="card">
        <h2>Table of Contents</h2>
        <ul class="list">
          <li>DDoS/DoS Attacks</li>
          <li>Signs of a DDoS/DoS Attack</li>
          <li>Types of DDoS Attacks & Detection Techniques</li>
          <li>What is a Session?</li>
          <li>Session Hijacking ‚Äî techniques & types</li>
          <li>Session hijacking using XSS & sniffing</li>
          <li>Prevention & Incident Playbook</li>
          <li>Intrusion Detection Systems (IDS) & Types</li>
          <li>Honeypots ‚Äî concepts and use</li>
          <li>Safe lab ideas and further reading</li>
        </ul>
      </section>

      <section class="card">
        <h2>DoS Attack ‚Äî definition & context</h2>
        <p>
          A <strong>denial-of-service (DoS) attack</strong> aims to make a device, service, or network resource unavailable to legitimate users. Attackers accomplish this by exhausting resources (CPU, memory, bandwidth, file descriptors, connection tables), exploiting vulnerabilities, or otherwise preventing normal operation.
        </p>
        <p class="small muted">
          In practice, DoS attacks can be carried out for disruption, profit (ransom), political motives (hacktivism), or simply as a smokescreen for other malicious activity.
        </p>
      </section>

      <section class="card">
        <h2>Distributed Denial-of-Service (DDoS)</h2>
        <p>
          A <strong>DDoS</strong> attack follows the same goal as DoS but uses many distributed sources ‚Äî often compromised or coerced devices (a botnet) ‚Äî to magnify attack volume and complicate mitigation.
        </p>
        <p>
          Typical DDoS architecture: attacker ‚Üí command-and-control (handlers) ‚Üí zombies/bots ‚Üí victim. Modern botnets may include IoT devices, cloud instances, or compromised servers.
        </p>
      </section>

      <section class="card">
        <h2>DDoS vs DoS ‚Äî quick comparison</h2>
        <table style="width:100%;border-collapse:collapse">
          <thead><tr><th style="text-align:left">DoS</th><th style="text-align:left">DDoS</th></tr></thead>
          <tbody>
            <tr><td>Single attacking source</td><td>Multiple distributed sources</td></tr>
            <tr><td>Generally lower capacity</td><td>Often high capacity and harder to block</td></tr>
            <tr><td>Can be traced to one host (easier to block)</td><td>Requires coordination with ISPs/CDNs to defend</td></tr>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Signs of a DDoS/DoS Attack</h2>
        <ul class="list">
          <li>Slow network or application performance.</li>
          <li>Partial or full unavailability of a website/service.</li>
          <li>Spikes in traffic volume (packets/sec or bits/sec) without corresponding business activity.</li>
          <li>Increased server errors (HTTP 500/503) and resource exhaustion.</li>
          <li>Unusual traffic patterns or many connections from a single IP range or many source IPs with similar signatures.</li>
        </ul>
      </section>

      <section class="card">
        <h2>Types of DDoS Attacks</h2>
        <p>Attacks are commonly grouped by technique and the layer they target:</p>
        <ul class="list">
          <li><strong>Volumetric attacks</strong> ‚Äî saturate bandwidth (UDP flood, DNS/NTP amplification).</li>
          <li><strong>Protocol attacks</strong> ‚Äî exhaust protocol state (SYN flood, fragment attacks).</li>
          <li><strong>Application-layer attacks</strong> ‚Äî target application logic and resources (HTTP flood, Slowloris).</li>
        </ul>
        <p class="small muted">Zero-day DDoS techniques may combine methods or exploit unpatched software for greater effect.</p>
      </section>

      <section class="card">
        <h3>Volumetric attack examples</h3>
        <ul class="list">
          <li><strong>UDP flood</strong> ‚Äî forged packets to random/targeted ports; victims respond or are overloaded.</li>
          <li><strong>Amplification (DNS/NTP)</strong> ‚Äî small spoofed request causes large response from misconfigured public servers, amplifying traffic to victim.</li>
        </ul>
      </section>

      <section class="card">
        <h3>Protocol attack examples</h3>
        <ul class="list">
          <li><strong>SYN flood</strong> ‚Äî incomplete TCP handshakes leave server connection state filled.</li>
          <li><strong>Ping of Death / ICMP floods</strong> ‚Äî oversized or numerous ICMP messages.</li>
        </ul>
      </section>

      <section class="card">
        <h3>Application-layer attacks</h3>
        <ul class="list">
          <li><strong>HTTP flood</strong> ‚Äî many seemingly-legitimate HTTP requests (GET/POST), often generated by botnets, overwhelming app servers.</li>
          <li><strong>Slowloris</strong> ‚Äî many partial HTTP requests kept open to exhaust server resources.</li>
        </ul>
      </section>

      <section class="card">
        <h2>Detection Techniques</h2>
        <ul class="list">
          <li><strong>Traffic monitoring:</strong> use NetFlow/IPFIX, packet captures and edge logs to detect spikes and anomalies.</li>
          <li><strong>Behavioral analysis:</strong> baseline normal traffic patterns then detect deviations (rate, geo-distribution, protocol mix).</li>
          <li><strong>Signature-based detection:</strong> known attack patterns identified via IDS/IPS rules (e.g., Suricata, Snort).</li>
          <li><strong>Rate limiting & challenge-response:</strong> throttle excessive requests, present CAPTCHAs where appropriate.</li>
          <li><strong>Network flow analysis:</strong> aggregate and analyze flows for volumetric anomalies.</li>
          <li><strong>Anomaly detection (ML-based):</strong> systems that learn normal operation and alert on unusual signals.</li>
        </ul>
      </section>

      <section class="card">
        <h2>What is a Session?</h2>
        <p>
          A web session is a logical, continuous interaction between a user and an application that persists across multiple HTTP requests. Sessions are typically implemented using session tokens (cookies, JWTs, etc.) that the server issues to authenticated users to avoid re-authentication for every request.
        </p>
        <p class="small muted">Since HTTP is stateless, session tokens are the mechanism that provides continuity of identity and permissions.</p>
      </section>

      <section class="card">
        <h2>Session Hijacking ‚Äî overview</h2>
        <p>
          <strong>Session hijacking</strong> occurs when an attacker obtains or predicts a valid session token and uses it to impersonate a legitimate user. The attacker then performs actions with the same privileges as that user (read data, perform transactions, change settings).
        </p>
      </section>

      <section class="card">
        <h3>How session hijacking works ‚Äî primary techniques</h3>
        <ul class="list">
          <li><strong>Steal:</strong> capture session IDs via XSS, packet sniffing (on insecure networks), or malware.</li>
          <li><strong>Predict:</strong> weak or predictable token generation allows brute-force or calculation-based hijack.</li>
          <li><strong>Fixate:</strong> attacker sets a session ID for the victim (session fixation) then waits for the victim to authenticate.</li>
          <li><strong>Man-in-the-middle:</strong> intercepting traffic (e.g., through ARP spoofing) to capture tokens or credentials.</li>
        </ul>
      </section>

      <section class="card">
        <h3>Types of session hijacking attacks</h3>
        <ul class="list">
          <li>Cross-site scripting (XSS) theft of cookies</li>
          <li>Session sidejacking (sniffing session cookies on insecure networks)</li>
          <li>Session fixation</li>
          <li>Man-in-the-browser attacks (malicious browser extensions or malware)</li>
        </ul>
      </section>

      <section class="card">
        <h3>Session hijacking using XSS (flow)</h3>
        <ol class="list">
          <li>Attacker finds XSS vulnerability and injects script into a page.</li>
          <li>Victim visits the vulnerable page and executes injected script in their browser.</li>
          <li>The script reads document.cookie (unless HttpOnly) or sends the token to attacker.</li>
          <li>Attacker uses the stolen token to impersonate the user.</li>
        </ol>
        <p class="small muted">Mitigation: sanitize inputs, use Content Security Policy, and store tokens in HttpOnly cookies rather than accessible storage.</p>
      </section>

      <section class="card">
        <h3>Session hijacking using packet sniffing</h3>
        <p>
          On insecure networks (open Wi-Fi), an attacker can capture unencrypted HTTP traffic and extract session cookies or tokens. Using HTTPS prevents easy interception because the session is encrypted in transit.
        </p>
      </section>

      <section class="card">
        <h2>How to prevent session hijacking</h2>
        <ul class="list">
          <li><strong>Enforce TLS everywhere:</strong> use HTTPS on all pages (including non-sensitive ones) and HSTS to prevent protocol downgrade.</li>
          <li><strong>HttpOnly cookie flag:</strong> prevents JavaScript from reading cookie values.</li>
          <li><strong>Secure cookie flag:</strong> ensures cookies are only sent over TLS.</li>
          <li><strong>SameSite cookie flag:</strong> helps reduce CSRF and cross-site leakage.</li>
          <li><strong>Short lifetimes & rotation:</strong> regenerate session IDs after privilege changes (login) and use short expirations for tokens.</li>
          <li><strong>Use strong random token generators:</strong> ensure session IDs are cryptographically strong and unpredictable.</li>
          <li><strong>MFA & reauthentication:</strong> require step-up authentication for sensitive operations.</li>
          <li><strong>IP / user-agent binding and anomaly detection:</strong> monitor for unusual session behavior and revalidate when anomalies occur.</li>
        </ul>
      </section>

      <section class="card">
        <h2>Incident response playbook (high-level)</h2>
        <ol class="list">
          <li><strong>Detect:</strong> monitor anomalies, WAF triggers, IDS alerts.</li>
          <li><strong>Contain:</strong> redirect or rate-limit traffic, apply access controls, bring in CDN scrubbing.</li>
          <li><strong>Eradicate:</strong> remove malicious artifacts, patch exploited vulnerabilities.</li>
          <li><strong>Recover:</strong> restore services, validate integrity, rotate credentials and tokens.</li>
          <li><strong>Post-incident:</strong> review logs, strengthen defenses, update playbooks.</li>
        </ol>
      </section>

      <section class="card">
        <h2>Intrusion Detection Systems (IDS)</h2>
        <p>
          IDS monitor network or host activity for malicious behavior and alert administrators. They do not (usually) block traffic themselves ‚Äî that is Intrusion Prevention System (IPS) territory ‚Äî but integration with blocking systems is common.
        </p>
        <h3>Types of IDS:</h3>
        <ul class="list">
          <li><strong>Network-based (NIDS):</strong> monitor packet streams on networks (examples: Zeek, Suricata).</li>
          <li><strong>Host-based (HIDS):</strong> monitor activity on servers/endpoints (file integrity, logs).</li>
        </ul>
        <p class="small muted">IDS effectiveness depends on good baseline data, well-tuned rules, and integration with SIEM for correlation & context.</p>
      </section>

      <section class="card">
        <h2>Honeypots ‚Äî concept & uses</h2>
        <p>
          A <strong>honeypot</strong> is a deliberately exposed resource designed to attract attackers and monitor their behavior. Honeypots can be <em>low-interaction</em> (simulate services) or <em>high-interaction</em> (real systems instrumented for monitoring).
        </p>
        <ul class="list">
          <li><strong>Detection:</strong> early signals of active attacks.</li>
          <li><strong>Research:</strong> learn new attacker TTPs (tools, techniques, procedures).</li>
          <li><strong>Diversion:</strong> keep attackers busy away from production systems.</li>
        </ul>
        <p class="small muted">Important: isolate honeypots from production networks to avoid them being pivot points for attackers.</p>
      </section>

      <section class="card">
        <h2>Safe lab ideas</h2>
        <ul class="list">
          <li>Mirror a small lab network and generate synthetic traffic to learn baseline and anomalies.</li>
          <li>Deploy Zeek + Suricata in the lab and simulate DoS conditions to see alerting behavior (do NOT run real attacks on production or public networks).</li>
          <li>Test session management practices: build a small web app and experiment with cookie flags, token rotation, and session fixation tests in a controlled environment.</li>
          <li>Set up a low-interaction honeypot and analyze the logs to see reconnaissance and automated attack patterns.</li>
        </ul>
      </section>

      <section class="card">
        <h2>Tools & references</h2>
        <ul class="list">
          <li>Zeek, Suricata, Wireshark ‚Äî network monitoring and analysis</li>
          <li>Cloudflare, Akamai, AWS Shield ‚Äî DDoS mitigation services (commercial)</li>
          <li>OWASP ‚Äî Session Management Cheat Sheet</li>
          <li>NIST SP 800-series ‚Äî incident response and best practices</li>
        </ul>
      </section>

      <!-- Quiz: 10 questions -->
      <section class="card quiz" aria-labelledby="quiz">
        <h2 id="quiz">10-question Quiz (self-check) ‚Äî Defensive focus</h2>

        <div class="q">
          <strong>1.</strong> Which mitigation is most effective for large volumetric DDoS attacks?<br>
          <label><input type="radio" name="q1" value="a"> Increasing application logging</label><br>
          <label><input type="radio" name="q1" value="b"> Engaging a CDN/scrubbing provider</label><br>
          <label><input type="radio" name="q1" value="c"> Disabling TLS</label>
        </div>

        <div class="q">
          <strong>2.</strong> Which cookie flag helps prevent JavaScript access to a session cookie?<br>
          <label><input type="radio" name="q2" value="a"> Secure</label><br>
          <label><input type="radio" name="q2" value="b"> HttpOnly</label><br>
          <label><input type="radio" name="q2" value="c"> Expires</label>
        </div>

        <div class="q">
          <strong>3.</strong> A SYN flood is best described as which sort of attack?<br>
          <label><input type="radio" name="q3" value="a"> Volumetric</label><br>
          <label><input type="radio" name="q3" value="b"> Protocol (state-exhaustion)</label><br>
          <label><input type="radio" name="q3" value="c"> Application layer</label>
        </div>

        <div class="q">
          <strong>4.</strong> Which of the following helps prevent session fixation?<br>
          <label><input type="radio" name="q4" value="a"> Regenerate session ID after login</label><br>
          <label><input type="radio" name="q4" value="b"> Longer session lifetime</label><br>
          <label><input type="radio" name="q4" value="c"> Store session in localStorage</label>
        </div>

        <div class="q">
          <strong>5.</strong> Which detection technique uses historical baselines and ML to spot anomalies?<br>
          <label><input type="radio" name="q5" value="a"> Signature-based detection</label><br>
          <label><input type="radio" name="q5" value="b"> Behavioral/Anomaly detection</label><br>
          <label><input type="radio" name="q5" value="c"> Manual packet captures only</label>
        </div>

        <div class="q">
          <strong>6.</strong> What does a honeypot primarily provide?<br>
          <label><input type="radio" name="q6" value="a"> Production traffic acceleration</label><br>
          <label><input type="radio" name="q6" value="b"> Decoy to observe attacker behavior and early warning</label><br>
          <label><input type="radio" name="q6" value="c"> Automatic removal of malicious IPs from the internet</label>
        </div>

        <div class="q">
          <strong>7.</strong> Which is a safe way to protect session tokens from network interception?<br>
          <label><input type="radio" name="q7" value="a"> Always use HTTPS/TLS everywhere</label><br>
          <label><input type="radio" name="q7" value="b"> Send tokens over HTTP but obfuscate with JS</label><br>
          <label><input type="radio" name="q7" value="c"> Publish session tokens in CSS files</label>
        </div>

        <div class="q">
          <strong>8.</strong> An application shows many long-running open HTTP connections from the same IP, slowly sending headers. Which attack does this resemble?<br>
          <label><input type="radio" name="q8" value="a"> Slowloris / Slow POST (application-layer)</label><br>
          <label><input type="radio" name="q8" value="b"> DNS amplification (volumetric)</label><br>
          <label><input type="radio" name="q8" value="c"> SYN flood (protocol)</label>
        </div>

        <div class="q">
          <strong>9.</strong> Which response is an appropriate immediate step when your monitoring shows a DDoS impacting availability?<br>
          <label><input type="radio" name="q9" value="a"> Activate the incident playbook and contact your CDN/ISP</label><br>
          <label><input type="radio" name="q9" value="b"> Immediately rotate all database passwords</label><br>
          <label><input type="radio" name="q9" value="c"> Publish credentials for employees to share</label>
        </div>

        <div class="q">
          <strong>10.</strong> Which of these best reduces the risk from XSS-based session hijacking?<br>
          <label><input type="radio" name="q10" value="a"> Storing session tokens in HttpOnly cookies and sanitizing inputs</label><br>
          <label><input type="radio" name="q10" value="b"> Allowing inline scripts from any origin</label><br>
          <label><input type="radio" name="q10" value="c"> Using predictable numeric session IDs</label>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <button class="btn primary" id="grade">Grade Quiz</button>
          <button class="btn" id="showAnswers">Show Answers & Explanations</button>
          <span id="quizResult" class="small" aria-live="polite" style="margin-left:8px"></span>
        </div>

        <div id="result" class="result" role="region" aria-live="polite" tabindex="-1"></div>
      </section>

      <section class="card">
        <h2>Further reading & next steps</h2>
        <ul class="list">
          <li>OWASP ‚Äî Session Management Cheat Sheet (practical guidance)</li>
          <li>Cloudflare, Akamai, AWS Shield ‚Äî vendor docs on DDoS mitigation</li>
          <li>Zeek (Bro) & Suricata ‚Äî network monitoring & IDS tools</li>
          <li>NIST SP 800-61 (Computer Security Incident Handling Guide)</li>
        </ul>
      </section>

      <footer class="container" style="margin-top:20px">
        <p>¬© Defensive Training ‚Äî DoS/DDoS & Session Hijacking</p>
      </footer>
    </article>

    <aside class="sidebar" aria-label="Sidebar">
      <div class="card">
        <h3>Quick Links</h3>
        <ul class="list">
          <li><a href="#quiz">Quiz</a></li>
          <li><a href="#what">What is a Session?</a></li>
          <li><a href="#types">Types of DDoS Attacks</a></li>
          <li><a href="#prevention">Prevention</a></li>
        </ul>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>Cheat Sheet</h3>
        <div class="small" style="margin-bottom:8px"><strong>Protect:</strong> TLS, WAF, CDN, rate-limits</div>
        <div class="small"><strong>Detect:</strong> NetFlow, IDS, behavioral analytics</div>
      </div>
    </aside>
  </main>

  <!-- Mobile Back button visible on tablet/phone -->
  <a href="cyber-index.html" class="mobile-back-btn" aria-label="Back to lessons (mobile)">
    <span aria-hidden="true">‚óÄ</span>
    <span>Lessons</span>
  </a>

  <!-- TTS bar -->
  <div id="ttsBar" class="tts-bar" aria-hidden="false" role="region" aria-label="Text to Speech Controls" data-compact="false">
    <button id="ttsCollapse" title="Collapse/Expand TTS">‚â°</button>

    <div class="tts-controls" aria-hidden="false" style="display:flex;gap:8px;align-items:center;flex-wrap:nowrap">
      <button id="ttsPlay" title="Play">‚ñ∂</button>
      <button id="ttsPause" title="Pause">‚è∏</button>
      <button id="ttsStop" title="Stop">‚èπ</button>

      <span class="small">Voice</span>
      <select id="ttsVoices" aria-label="Select voice"></select>

      <span class="small">Rate</span>
      <input id="ttsRate" type="range" min="0.6" max="2" step="0.1" value="1" />

      <span class="small">Pitch</span>
      <input id="ttsPitch" type="range" min="0.6" max="2" step="0.1" value="1" />

      <button id="ttsToggleAuto" class="btn" title="Auto-read on load">A</button>
    </div>
  </div>

<script>
/* -----------------------------
   Theme, Download, Copy Markdown
   ----------------------------- */
(function(){
  const themeBtn = document.getElementById('toggleTheme');
  const themeKey = 'lesson9.theme';
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

  function applyTheme(mode){
    if (mode === 'light'){
      document.documentElement.style.setProperty('--bg','#f4f7fb');
      document.documentElement.style.setProperty('--card','#ffffff');
      document.documentElement.style.setProperty('--text','#072033');
      document.documentElement.style.setProperty('--muted','#4a5875');
      document.documentElement.style.setProperty('--accent','#3b82f6');
      document.documentElement.style.setProperty('--accent2','#34d399');
    } else {
      document.documentElement.style.setProperty('--bg','#071428');
      document.documentElement.style.setProperty('--card','#0f2136');
      document.documentElement.style.setProperty('--text','#e9f6ff');
      document.documentElement.style.setProperty('--muted','#9db7d9');
      document.documentElement.style.setProperty('--accent','#57a7ff');
      document.documentElement.style.setProperty('--accent2','#7ef0c8');
    }
  }

  const stored = localStorage.getItem(themeKey);
  const initial = stored || (prefersDark ? 'dark' : 'dark');
  applyTheme(initial);
  if (themeBtn){
    themeBtn.setAttribute('aria-pressed', initial === 'dark' ? 'true' : 'false');
    themeBtn.addEventListener('click', () => {
      const cur = localStorage.getItem(themeKey) || initial;
      const next = cur === 'dark' ? 'light' : 'dark';
      localStorage.setItem(themeKey, next);
      applyTheme(next);
      themeBtn.setAttribute('aria-pressed', next === 'dark' ? 'true' : 'false');
    });
  }

  /* Download notes */
  const downloadBtn = document.getElementById('downloadNotes');
  if (downloadBtn) downloadBtn.addEventListener('click', () => {
    const nodes = document.querySelectorAll('main article h1, main article h2, main article h3, main article p, main article li, main article pre');
    const lines = [];
    nodes.forEach(n => {
      const tag = n.tagName.toLowerCase();
      const txt = n.innerText.trim();
      if (!txt) return;
      if (tag === 'h1') lines.push('# ' + txt + '\n');
      else if (tag === 'h2') lines.push('## ' + txt + '\n');
      else if (tag === 'h3') lines.push('### ' + txt + '\n');
      else if (tag === 'li') lines.push('- ' + txt);
      else if (tag === 'pre') lines.push('```\n' + txt + '\n```');
      else lines.push(txt);
    });
    const blob = new Blob([lines.join('\n\n')], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'Lesson9_DDoS_SessionHijack_Notes.txt'; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 700);
  });

  /* Copy Markdown */
  const copyBtn = document.getElementById('copyMd');
  if (copyBtn) copyBtn.addEventListener('click', async () => {
    const nodes = document.querySelectorAll('main article h1, main article h2, main article h3, main article p, main article li, main article pre');
    let md = '';
    nodes.forEach(n => {
      const tag = n.tagName.toLowerCase();
      const txt = n.innerText.trim();
      if (!txt) return;
      if (tag === 'h1') md += '# ' + txt + '\n\n';
      else if (tag === 'h2') md += '## ' + txt + '\n\n';
      else if (tag === 'h3') md += '### ' + txt + '\n\n';
      else if (tag === 'li') md += '- ' + txt + '\n';
      else if (tag === 'pre') md += '```\n' + txt + '\n```\n\n';
      else md += txt + '\n\n';
    });
    try { await navigator.clipboard.writeText(md); alert('Copied notes as Markdown.'); }
    catch(e){ alert('Could not copy to clipboard.'); }
  });

})();

/* -----------------------------
   Quiz logic
   ----------------------------- */
(function(){
  const answers = {
    q1: {a:false,b:true,c:false, explain:"Large volumetric attacks are best mitigated by CDN/scrubbing providers that filter or absorb traffic upstream."},
    q2: {a:false,b:true,c:false, explain:"HttpOnly prevents JavaScript from accessing the cookie; Secure ensures cookies are only sent over TLS."},
    q3: {a:false,b:true,c:false, explain:"SYN flood uses incomplete TCP handshakes to exhaust server state ‚Äî a protocol/state exhaustion attack."},
    q4: {a:true,b:false,c:false, explain:"Regenerating the session ID after authentication prevents session fixation."},
    q5: {a:false,b:true,c:false, explain:"Behavioral/anomaly detection uses baselines and ML to spotlight deviations."},
    q6: {a:false,b:true,c:false, explain:"Honeypots are decoys used to observe attackers and provide early warning; they don't speed production traffic."},
    q7: {a:true,b:false,c:false, explain:"Always use HTTPS/TLS so session tokens are encrypted in transit."},
    q8: {a:true,b:false,c:false, explain:"Long-running partial HTTP connections are characteristic of Slowloris-style application-layer attacks."},
    q9: {a:true,b:false,c:false, explain:"Invoke your incident playbook and contact CDN/ISP to coordinate mitigation."},
    q10:{a:true,b:false,c:false, explain:"HttpOnly-cookies + input sanitization (and CSP) greatly reduce XSS session theft risk."}
  };

  const gradeBtn = document.getElementById('grade');
  const showBtn = document.getElementById('showAnswers');
  const out = document.getElementById('result');
  const quizResult = document.getElementById('quizResult');

  if (gradeBtn) gradeBtn.addEventListener('click', () => {
    let score = 0;
    const parts = [];
    for (let i=1;i<=10;i++){
      const q = 'q'+i;
      const sel = document.querySelector(`input[name="${q}"]:checked`);
      const user = sel ? sel.value : '(no answer)';
      const correct = Object.keys(answers[q]).find(k => k!=='explain' && answers[q][k] === true);
      const isCorrect = sel && answers[q][sel.value] === true;
      if (isCorrect) score++;
      parts.push(`<strong>Q${i}</strong> ‚Äî Your answer: ${user} ‚Äî ${isCorrect?'<span style="color:var(--ok)">Correct</span>':'<span style="color:var(--danger)">Incorrect</span>'}<br><em>Explanation:</em> ${answers[q].explain}`);
    }
    out.innerHTML = `<div><strong>Score:</strong> ${score} / 10</div><div style="margin-top:10px">${parts.join('<hr>')}</div>`;
    quizResult.textContent = `Score: ${score}/10`;
    quizResult.style.color = score >= 8 ? 'var(--ok)' : score >= 6 ? 'var(--accent2)' : 'var(--danger)';
    out.focus();
    out.scrollIntoView({behavior:'smooth', block:'center'});
    // store last result
    try { localStorage.setItem('lesson9-quiz', JSON.stringify({ score, ts: Date.now() })); } catch(e){}
  });

  if (showBtn) showBtn.addEventListener('click', () => {
    const lines = [];
    for (let i=1;i<=10;i++){
      const q = 'q'+i;
      const correct = Object.keys(answers[q]).find(k => k!=='explain' && answers[q][k]===true);
      lines.push(`<strong>Q${i}</strong> ‚Äî Correct: ${correct.toUpperCase()} ‚Äî ${answers[q].explain}`);
    }
    out.innerHTML = lines.join('<hr>');
    out.scrollIntoView({behavior:'smooth', block:'center'});
  });

  // restore previous score if present
  (function restore(){
    try{
      const raw = localStorage.getItem('lesson9-quiz');
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (obj && obj.score !== undefined) {
        quizResult.textContent = `Previous Score: ${obj.score}/10`;
        quizResult.style.color = obj.score >= 8 ? 'var(--ok)' : obj.score >= 6 ? 'var(--accent2)' : 'var(--danger)';
      }
    } catch(e){}
  })();
})();

/* -----------------------------
   TTS module (responsive + highlighting)
   ----------------------------- */
(function(){
  const bar = document.getElementById('ttsBar');
  if (!bar) return;

  // if TTS API not available, hide bar and adjust spacing
  if (!('speechSynthesis' in window)) { bar.style.display='none'; adjustForTTS(); return; }

  // UI elements
  const playBtn = document.getElementById('ttsPlay');
  const pauseBtn = document.getElementById('ttsPause');
  const stopBtn = document.getElementById('ttsStop');
  const voicesSelect = document.getElementById('ttsVoices');
  const rateInput = document.getElementById('ttsRate');
  const pitchInput = document.getElementById('ttsPitch');
  const autoBtn = document.getElementById('ttsToggleAuto');
  const collapseBtn = document.getElementById('ttsCollapse');
  const lessonRoot = document.querySelector('.lesson-content') || document.body;
  const HOME = 'cyber-index.html';

  // inject desktop back button for wide screens
  (function injectDesktopBack(){
    if (document.querySelector('.desktop-back-btn')) return;
    const btn = document.createElement('button');
    btn.className = 'desktop-back-btn';
    btn.type = 'button';
    btn.title = 'Back to lessons';
    btn.setAttribute('aria-label','Back to lessons');
    btn.innerText = '‚óÄ Lessons';
    Object.assign(btn.style, {
      position: 'fixed',
      left: '18px',
      top: '18px',
      zIndex: 9999,
      padding: '8px 12px',
      borderRadius: '10px',
      border: '1px solid rgba(255,255,255,0.06)',
      background: 'rgba(255,255,255,0.02)',
      color: 'var(--text)',
      fontWeight: 700,
      cursor: 'pointer',
      backdropFilter: 'blur(6px)'
    });
    document.body.appendChild(btn);
    function update(){ btn.style.display = window.innerWidth <= 980 ? 'none' : 'inline-flex'; }
    update();
    window.addEventListener('resize', update);
    btn.addEventListener('click', ()=>{ window.location.href = HOME; });
  })();

  // state
  const KEYS = {
    voice: 'lesson9.voice',
    rate: 'lesson9.rate',
    pitch: 'lesson9.pitch',
    auto: 'lesson9.auto',
    compact: 'lesson9.compact',
    resume: 'lesson9.resume'
  };

  const S = {
    voices: [],
    sentences: [],
    idx: parseInt(localStorage.getItem(KEYS.resume) || '0', 10) || 0,
    utterance: null,
    auto: localStorage.getItem(KEYS.auto) === 'true',
    compact: (localStorage.getItem(KEYS.compact) === 'true') || (window.matchMedia('(max-width:820px)').matches),
    muted: false
  };

  function loadVoices(){
    return new Promise((resolve) => {
      let v = speechSynthesis.getVoices();
      if (v.length){ S.voices = v; resolve(v); return; }
      speechSynthesis.onvoiceschanged = ()=>{ v = speechSynthesis.getVoices(); S.voices = v; resolve(v); };
      setTimeout(()=>{ v = speechSynthesis.getVoices(); S.voices = v; resolve(v); }, 1200);
    });
  }

  async function populateVoices(){
    const voices = await loadVoices();
    if (!voicesSelect) return;
    voicesSelect.innerHTML = '';
    voices.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v.voiceURI || v.name;
      opt.textContent = `${v.name} (${v.lang})${v.default ? ' ‚Äî default' : ''}`;
      voicesSelect.appendChild(opt);
    });
    const stored = localStorage.getItem(KEYS.voice);
    if (stored) try { voicesSelect.value = stored; } catch(e){}
    setTimeout(adjustForTTS, 150);
  }
  populateVoices();

  // build sentence objects pointing to nodes
  function buildSentences(){
    const nodes = lessonRoot.querySelectorAll('h1,h2,h3,p,li,pre');
    const arr = [];
    nodes.forEach(n => {
      const txt = n.innerText.trim();
      if (!txt) return;
      const parts = txt.split(/(?<=[.?!])\s+/);
      parts.forEach(p => { if (p && p.trim()) arr.push({ text: p.trim(), node: n }); });
    });
    S.sentences = arr;
  }

  // highlighting helpers using mark wrapper
  function removeAllMarks(){
    const marks = lessonRoot.querySelectorAll('mark.tts-mark');
    marks.forEach(m => {
      const parent = m.parentNode;
      while (m.firstChild) parent.insertBefore(m.firstChild, m);
      parent.removeChild(m);
      parent.normalize();
    });
  }

  function safeScrollIntoView(node){
    if (!node) return;
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    try { node.scrollIntoView({ behavior: prefersReduced ? 'auto' : 'smooth', block: 'center' }); }
    catch(e){ node.scrollIntoView(); }
  }

  function markSentenceInNode(node, sentence){
    if (!node || !sentence) return false;
    // try to find sentence in node text (exact match)
    const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null, false);
    let n;
    while (n = walker.nextNode()){
      const idx = n.nodeValue.indexOf(sentence);
      if (idx >= 0){
        const range = document.createRange();
        range.setStart(n, idx);
        range.setEnd(n, idx + sentence.length);
        const mark = document.createElement('mark');
        mark.className = 'tts-mark';
        try { range.surroundContents(mark); safeScrollIntoView(mark); } catch(e){ /* DOM structures can vary */ }
        return true;
      }
    }
    return false;
  }

  function highlightNode(node){
    removeAllMarks();
    if (!node) return;
    node.classList.add('tts-highlight');
    safeScrollIntoView(node);
    // remove highlight after small delay to keep visual tidy
    setTimeout(()=> node.classList.remove('tts-highlight'), 1200);
  }

  function pickVoiceByValue(val){
    return S.voices.find(v => (v.voiceURI && v.voiceURI === val) || v.name === val || v.name.includes(val)) || S.voices.find(v => v.default) || S.voices[0];
  }

  function deviceDefaultRate(){
    const w = window.innerWidth;
    if (w <= 420) return 0.95;
    if (w <= 820) return 1.0;
    return 1.08;
  }

  function speakObj(obj){
    if (!obj || !obj.text){ S.idx++; return; }
    if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(obj.text);
    const voiceURI = (voicesSelect && voicesSelect.value) || localStorage.getItem(KEYS.voice) || '';
    const selected = pickVoiceByValue(voiceURI);
    if (selected) u.voice = selected;
    u.rate = rateInput ? parseFloat(rateInput.value) : deviceDefaultRate();
    u.pitch = pitchInput ? parseFloat(pitchInput.value) : 1.0;
    u.volume = S.muted ? 0 : 1;
    u.onstart = () => {
      // try to highlight within the referenced node
      removeAllMarks();
      const placed = markSentenceInNode(obj.node, obj.text) || markSentenceInNode(document.body, obj.text);
      if (!placed) highlightNode(obj.node);
    };
    u.onend = () => {
      S.idx++;
      localStorage.setItem(KEYS.resume, String(S.idx));
      if (S.idx < S.sentences.length) setTimeout(()=> speakObj(S.sentences[S.idx]), 110);
      else { S.idx = 0; localStorage.setItem(KEYS.resume, '0'); removeAllMarks(); }
    };
    S.utterance = u;
    speechSynthesis.speak(u);
  }

  function play(index){
    if (!S.sentences.length) buildSentences();
    if (typeof index === 'number') S.idx = index;
    if (S.idx >= S.sentences.length) S.idx = 0;
    if (speechSynthesis.paused) return speechSynthesis.resume();
    speakObj(S.sentences[S.idx]);
  }
  function pauseToggle(){
    if (speechSynthesis.speaking && !speechSynthesis.paused) speechSynthesis.pause();
    else if (speechSynthesis.paused) speechSynthesis.resume();
  }
  function stop(){
    if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
    S.idx = 0;
    localStorage.setItem(KEYS.resume, '0');
    removeAllMarks();
  }
  function speakText(text){
    if (!text || !text.trim()) return;
    if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const voiceURI = (voicesSelect && voicesSelect.value) || localStorage.getItem(KEYS.voice) || '';
    const selected = pickVoiceByValue(voiceURI);
    if (selected) u.voice = selected;
    u.rate = rateInput ? parseFloat(rateInput.value) : deviceDefaultRate();
    u.pitch = pitchInput ? parseFloat(pitchInput.value) : 1.0;
    speechSynthesis.speak(u);
  }

  function toggleAuto(){
    S.auto = !S.auto;
    localStorage.setItem(KEYS.auto, S.auto ? 'true' : 'false');
    if (autoBtn) autoBtn.style.opacity = S.auto ? '1' : '0.6';
    if (autoBtn) autoBtn.setAttribute('aria-pressed', S.auto ? 'true' : 'false');
  }

  function setCompact(flag){
    if (!bar) return;
    bar.setAttribute('data-compact', flag ? 'true' : 'false');
    localStorage.setItem(KEYS.compact, flag ? 'true' : 'false');
    if (collapseBtn) collapseBtn.setAttribute('aria-expanded', flag ? 'false' : 'true');
  }

  // attach UI events
  playBtn && playBtn.addEventListener('click', ()=> { play(0); });
  pauseBtn && pauseBtn.addEventListener('click', pauseToggle);
  stopBtn && stopBtn.addEventListener('click', stop);
  voicesSelect && voicesSelect.addEventListener('change', ()=> localStorage.setItem(KEYS.voice, voicesSelect.value));
  rateInput && rateInput.addEventListener('input', ()=> localStorage.setItem(KEYS.rate, rateInput.value));
  pitchInput && pitchInput.addEventListener('input', ()=> localStorage.setItem(KEYS.pitch, pitchInput.value));
  if (autoBtn){ autoBtn.style.opacity = S.auto ? '1' : '0.6'; autoBtn.setAttribute('aria-pressed', S.auto ? 'true' : 'false'); autoBtn.addEventListener('click', toggleAuto); }
  if (collapseBtn) collapseBtn.addEventListener('click', ()=> { const cur = bar.getAttribute('data-compact') === 'true'; setCompact(!cur); });

  // initialization
  (function init(){
    const storedCompact = localStorage.getItem(KEYS.compact);
    const shouldDefault = window.matchMedia('(max-width:820px)').matches;
    const compact = storedCompact === null ? shouldDefault : (storedCompact === 'true');
    setCompact(compact);

    const r = localStorage.getItem(KEYS.rate);
    const p = localStorage.getItem(KEYS.pitch);
    const v = localStorage.getItem(KEYS.voice);
    if (r && rateInput) rateInput.value = r;
    if (p && pitchInput) pitchInput.value = p;
    if (v && voicesSelect) setTimeout(()=> { try { voicesSelect.value = v; } catch(e){} }, 600);
  })();

  // responsive adjustments
  function handleResize(){
    const narrow = window.matchMedia('(max-width:420px)').matches;
    const tablet = window.matchMedia('(max-width:820px)').matches && !narrow;
    const userSet = localStorage.getItem(KEYS.compact);
    if (userSet === null){
      if (narrow) setCompact(true);
      else setCompact(false);
    }
    if (voicesSelect){
      if (narrow) voicesSelect.style.maxWidth = '120px';
      else if (tablet) voicesSelect.style.maxWidth = '180px';
      else voicesSelect.style.maxWidth = '240px';
    }
    const desktopBtn = document.querySelector('.desktop-back-btn');
    if (desktopBtn) desktopBtn.style.display = window.innerWidth <= 980 ? 'none' : 'inline-flex';
  }
  window.addEventListener('resize', handleResize);
  window.addEventListener('orientationchange', ()=> setTimeout(handleResize, 260));
  handleResize();

  // keyboard shortcuts
  window.addEventListener('keydown', (e) => {
    const tag = (e.target && e.target.tagName || '').toLowerCase();
    if (tag === 'input' || tag === 'textarea' || e.target.isContentEditable) return;
    if (e.code === 'Space') { e.preventDefault(); if (speechSynthesis.speaking && !speechSynthesis.paused) pauseToggle(); else if (speechSynthesis.paused) pauseToggle(); else play(S.idx || 0); }
    else if (e.key === 's' || e.key === 'S') stop();
    else if (e.key === 'b' || e.key === 'B') window.location.href = HOME;
    else if (e.key === '+' || e.key === '=') { if (rateInput) { rateInput.value = Math.min(parseFloat(rateInput.value) + 0.1, parseFloat(rateInput.max)); localStorage.setItem(KEYS.rate, rateInput.value); } }
    else if (e.key === '-') { if (rateInput) { rateInput.value = Math.max(parseFloat(rateInput.value) - 0.1, parseFloat(rateInput.min)); localStorage.setItem(KEYS.rate, rateInput.value); } }
    else if (e.key === 'm' || e.key === 'M') { S.muted = !S.muted; }
    else if (e.key === 'r' || e.key === 'R') { const sel = window.getSelection().toString().trim(); if (sel) speakText(sel); }
    else if (e.key === 'a' || e.key === 'A') toggleAuto();
  });

  // double-tap to toggle play/pause on mobile
  (function doubleTap(){
    let last = 0;
    lessonRoot.addEventListener('touchend', (ev) => {
      const now = Date.now();
      if (now - last < 350) {
        if (speechSynthesis.speaking && !speechSynthesis.paused) pauseToggle();
        else play(S.idx || 0);
        last = 0;
        return;
      }
      last = now;
    }, { passive: true });
  })();

  // read-on-scroll (optional)
  (function readOnScroll(){
    if (!('IntersectionObserver' in window)) return;
    const io = new IntersectionObserver((entries) => {
      // not enabled by default, toggle using keyboard shortcut 't' (not persistent)
      // if desired, you can enable via S.readingOnScroll = true
      if (!S.readingOnScroll) return;
      entries.forEach(en => {
        if (en.isIntersecting && en.intersectionRatio > 0.6) {
          const node = en.target;
          const idx = S.sentences.findIndex(s => s.node === node);
          if (idx >= 0) { S.idx = idx; play(idx); }
        }
      });
    }, { threshold: [0.6] });
    function observe(){
      const nodes = lessonRoot.querySelectorAll('h1,h2,h3,p,li,pre');
      nodes.forEach(n => io.observe(n));
    }
    observe();
    const mo = new MutationObserver(observe);
    mo.observe(lessonRoot, { childList:true, subtree:true });
  })();

  // API for automation
  window.Lesson9TTS = {
    play: ()=> play(0),
    pause: ()=> pauseToggle(),
    stop: ()=> stop(),
    speakText: (t)=> speakText(t),
    toggleAuto: ()=> toggleAuto(),
    selectVoice: (nameOrURI)=> {
      if (!voicesSelect || !nameOrURI) return;
      const opt = Array.from(voicesSelect.options).find(o => o.value===nameOrURI || o.textContent.includes(nameOrURI));
      if (opt) { voicesSelect.value = opt.value; localStorage.setItem(KEYS.voice, opt.value); }
    },
    getState: ()=> ({ idx: S.idx, auto: S.auto, compact: S.compact, muted: S.muted })
  };

  // auto-play if allowed
  window.addEventListener('load', ()=> {
    buildSentences();
    if (S.auto){
      try { play(S.idx || 0); } catch(e) { console.warn('Auto TTS blocked by browser'); }
    }
  });

  // initial voices ready handling
  let tries = 0;
  const iv = setInterval(()=> {
    if (speechSynthesis.getVoices().length) { populateVoices(); clearInterval(iv); adjustForTTS(); }
    else if (++tries > 30){ clearInterval(iv); adjustForTTS(); }
  }, 200);

  // observe TTS bar size for layout
  const ro = new ResizeObserver(entries => adjustForTTS());
  ro.observe(bar);

  // hint
  if (!localStorage.getItem('lesson9.tts.hint')) {
    setTimeout(()=> console.info('TTS shortcuts: Space play/pause ‚Ä¢ S stop ‚Ä¢ B back ‚Ä¢ +/- speed ‚Ä¢ R read selection ‚Ä¢ A toggle auto'), 1000);
    localStorage.setItem('lesson9.tts.hint','1');
  }
})();

/* adjust for TTS bar so anchors not covered */
function adjustForTTS(){
  const bar = document.getElementById('ttsBar');
  if (!bar) return;
  const rect = bar.getBoundingClientRect();
  const cs = window.getComputedStyle(bar);
  const marginTop = parseFloat(cs.marginTop || 0) || 0;
  const marginBottom = parseFloat(cs.marginBottom || 0) || 0;
  const total = Math.ceil(rect.height + marginTop + marginBottom);
  document.documentElement.style.setProperty('--tts-height', total + 'px');
  document.querySelectorAll('.container').forEach(c => { const base = 24; c.style.paddingBottom = (base + total) + 'px'; });
}
window.addEventListener('load', ()=> { setTimeout(adjustForTTS, 300); setTimeout(adjustForTTS, 900); });
window.addEventListener('resize', ()=> { setTimeout(adjustForTTS, 120); });

/* small console safety note */
console.warn('SAFETY: Examples and commands are for authorized lab use only. Do not run attacks on networks or systems you do not have permission to test.');
</script>
</body>
</html>
