<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lesson 8 – Malware & Sniffing (Expanded + Labs + Quiz)</title>
  <style>
    :root{
      --bg:#071226; --card:#0f1b36; --muted:#9fb6d7; --text:#e8f3ff;
      --accent:#63a6ff; --accent-2:#76f0c4; --warn:#ffd66e; --danger:#ff758f;
      --tts-height: 96px; /* default until measured by JS */
      --header-height: 84px;
      --container-pad: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    html { scroll-behavior: smooth; scroll-padding-top: calc(var(--header-height) + 12px); scroll-padding-bottom: calc(var(--tts-height) + 18px); }
    body{color:var(--text); background:linear-gradient(135deg,#071226 0%,#0a1b36 100%); -webkit-font-smoothing:antialiased}
    .container{max-width:1200px;margin:0 auto;padding:var(--container-pad); padding-bottom: calc(var(--tts-height) + 28px);}
    header{position:sticky;top:0;z-index:30;background:rgba(7,18,38,0.7);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.04)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;flex-wrap:nowrap}
    .left{display:flex;align-items:center;gap:12px;min-width:0}
    .badge{display:inline-flex;align-items:center;gap:8px;font-weight:700;color:#071226;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:8px 12px;border-radius:999px;font-size:12px;text-transform:uppercase;flex-shrink:0}
    .title{font-size:clamp(20px,3.4vw,32px);margin:0;line-height:1.05;min-width:0}
    .subtitle{color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg, rgba(10,24,46,0.6), var(--card));border-radius:14px;padding:18px;margin-top:16px;border:1px solid rgba(255,255,255,0.035)}
    .long-read{line-height:1.7;font-size:15px}
    .list{padding-left:20px}
    .list li{margin:8px 0}
    .small{font-size:13px;color:var(--muted)}
    .explain{margin-top:10px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:8px 12px;border-radius:10px;background:rgba(255,255,255,.02);cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#071226;border:none}
    pre{white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;overflow:auto}
    .q-card{background:rgba(255,255,255,0.02);border-radius:10px;padding:12px;margin:10px 0;border:1px solid rgba(255,255,255,0.03)}
    .q-options{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .result{font-weight:800;margin-left:12px}
    footer{opacity:.8;font-size:13px;padding:30px 0 60px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:2fr 420px}}
    .sidebar{position:sticky;top:calc(var(--header-height) + 8px);align-self:start}
    .muted{color:var(--muted)}
    .metric{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-bottom:8px}
    a{color:var(--accent)}
    .danger{color:var(--danger);font-weight:700}
    .warn-box{background:linear-gradient(180deg, rgba(255,215,110,0.03), rgba(255,215,110,0.01));border-left:4px solid rgba(255,215,110,0.18);padding:10px;border-radius:8px}
    .kbd{background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);}
    /* TTS bar */
    .tts-bar {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      background: rgba(0,0,0,0.65);
      color: #00ffcc;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
      font-family: 'Share Tech Mono', monospace;
      display: flex;
      gap: 8px;
      align-items: center;
      backdrop-filter: blur(6px);
      min-width: 300px;
      transition: all .14s ease;
    }
    .tts-bar button { background: linear-gradient(45deg,#ff0080,#7928ca); border: none; color: #fff; padding: 8px 10px; border-radius: 8px; font-weight: 700; cursor: pointer; min-width: 44px; }
    .tts-bar select, .tts-bar input[type="range"] { background: rgba(255,255,255,0.06); color: #00ffcc; border: 1px solid rgba(255,255,255,0.06); padding: 6px; border-radius: 8px; font-family: inherit; }
    .tts-highlight { background: rgba(0,255,200,0.12); padding:0 2px; border-radius:3px }
    /* compact mode */
    .tts-bar[data-compact="true"] { min-width:58px; max-width:58px; padding:6px; border-radius:999px; gap:0; overflow:hidden }
    .tts-bar[data-compact="true"] .tts-controls { display:none }
    .tts-bar[data-compact="true"] #ttsCollapse { border-radius:999px; padding:8px; width:38px; height:38px; }
    /* mobile back btn */
    .mobile-back-btn { display:none; }
    @media (max-width:1024px) {
      .mobile-back-btn {
        display:inline-flex;
        align-items:center;
        gap:8px;
        position: fixed;
        left: 12px;
        bottom: calc(12px + env(safe-area-inset-bottom));
        z-index: 9998;
        text-decoration: none;
        padding: 9px 12px;
        border-radius: 999px;
        background: rgba(255,255,255,0.98);
        color: #0b1220;
        font-weight: 700;
        box-shadow: 0 8px 28px rgba(2,6,23,0.36);
        -webkit-tap-highlight-color: transparent;
        transition: transform .12s ease, box-shadow .12s ease;
        pointer-events: auto;
        border: 1px solid rgba(0,0,0,0.06);
        backdrop-filter: blur(6px);
      }
      .mobile-back-btn:active { transform: translateY(1px); }
      .mobile-back-btn:focus { outline: 3px solid rgba(21,156,228,0.18); outline-offset: 2px; }
    }
    /* small layout tweaks */
    @media(max-width:980px){
      :root{ --container-pad: 12px; --header-height: 72px; }
      .header-row{flex-wrap:wrap;align-items:flex-start;padding:10px}
      .left{min-width:0}
      .title{font-size:18px}
      .subtitle{font-size:12px}
      .sidebar{position:static;top:auto;margin-top:12px}
      .card{padding:14px}
      .tts-bar{min-width:260px;right:12px;left:auto}
      .container{padding-left:12px;padding-right:12px}
    }
    @media(max-width:600px){
      :root{ --container-pad: 10px; --header-height: 64px; }
      .header-row{gap:8px}
      .badge{padding:6px 10px;font-size:11px}
      .title{font-size:16px}
      .subtitle{display:none}
      .tts-bar{left:50%;right:auto;transform:translateX(-50%);min-width:88%}
      .tts-bar[data-compact="true"]{left:50%;transform:translateX(-50%)}
      .container{padding-left:10px;padding-right:10px}
    }
    /* anchor spacing */
    .section-title { scroll-margin-top: calc(var(--header-height) + 18px); }
    /* improve tap targets inside sidebar */
    .sidebar .list a{display:block;padding:8px;border-radius:6px}
    .sidebar .list a:focus{outline:3px solid rgba(99,166,255,0.12);outline-offset:2px}
  </style>
</head>
<body>
  <header>
    <div class="container header-row">
      <div class="left" style="min-width:0">
        <span class="badge">Lesson 8</span>
        <div style="min-width:0;overflow:hidden">
          <div class="title" title="Malware & Sniffing — Comprehensive Expansion">Malware & Sniffing — Comprehensive Expansion</div>
          <div class="subtitle">Behaviors, detection recipes, SIEM/YARA, safe labs, and quiz</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
        <button class="btn" id="downloadNotes" type="button">📥 Download Notes</button>
        <button class="btn" id="copyMarkdown" type="button">📋 Copy Markdown</button>
        <button class="btn" id="toggleTheme" type="button" aria-pressed="false">🌗 Theme</button>
      </div>
    </div>
  </header>

  <main class="container grid" role="main" aria-live="polite">
    <article>
      <!-- full lesson content (unchanged text) -->
      <section class="card">
        <h2>Overview — what this lesson adds</h2>
        <p class="long-read">
          This expanded lesson deepens the previous material with practical detection heuristics, SIEM correlation ideas, YARA examples for static detection, step-by-step safe-lab recipes (no malware distribution), and additional real-world analysis. It's designed for defensive practitioners who want to combine policy, architecture, and hands-on detection capabilities.
        </p>
        <div class="explain">
          <strong>Safety note:</strong> commands and tools shown are for authorized lab environments only. Never run offensive scans or malware against systems you do not own or have explicit written permission for. See the Legal & Ethical section later.
        </div>
      </section>

      <section class="card long-read" id="what-malware">
        <h2 class="section-title">What is Malware? — purpose & lifecycle (expanded)</h2>
        <p>
          Malware is best understood via its lifecycle: <strong>initial access → execution → persistence → privilege escalation → defense evasion → lateral movement → C2 & exfiltration → action on objectives (data theft, destruction, ransom)</strong>. Each phase provides defenders with collection and detection opportunities.
        </p>

        <h3>Lifecycle detection opportunities</h3>
        <ul class="list">
          <li><strong>Initial access:</strong> suspicious inbound email attachments, vulnerable public services, or compromised accounts. Monitor MFAs and abnormal logins.</li>
          <li><strong>Execution:</strong> new processes spawned by Office macros, signed binaries launching script interpreters, or unusual parent-child process relationships.</li>
          <li><strong>Persistence:</strong> new scheduled tasks, services, startup registry keys, or systemd units. Monitor changes in these persistence stores.</li>
          <li><strong>C2 & exfil:</strong> beacon patterns (regular, low-volume callbacks), DNS over abnormal domains, and large outbound data bursts.</li>
        </ul>

        <h3>Threat modeling</h3>
        <p class="small muted">
          When designing defenses, map threat actors (opportunistic, criminal ransomware groups, APTs) to TTPs and determine which controls (EPP/EDR, network segmentation, user training, backups) most reduce risk.
        </p>
      </section>

      <section class="card long-read" id="types">
        <h2 class="section-title">Malware taxonomy — behaviors and real-world signs</h2>

        <h3>Virus — indicators</h3>
        <p class="small muted">Signs: identical file hashes across endpoints, new macros in Office templates, modified executable timestamps.</p>
        <p>Detection: file hash blacklists, document macro policies, and file integrity monitoring.</p>

        <h3>Worm — indicators</h3>
        <p class="small muted">Signs: rapid increase in connections to the same port across subnets, scanning behavior, duplicated artifacts across many hosts.</p>

        <h3>Trojan / Backdoor — indicators</h3>
        <p class="small muted">Signs: suspicious outbound connections to unknown domains, persistence entries referencing unusual binaries, reverse-shell artifacts.</p>

        <h3>Ransomware — indicators</h3>
        <p class="small muted">Signs: file rename patterns, rapid mass-file modifications, deletion of shadow copies, creation of ransom notes (.txt/.html), unusual encryption libraries loaded in memory.</p>

        <h3>Fileless attacks — indicators</h3>
        <p class="small muted">Signs: PowerShell command lines with base64, cmd.exe spawning PowerShell with encoded commands, suspicious WMI event subscriptions.</p>

        <h3>Rootkits — detection challenges</h3>
        <p class="small muted">Rootkits hide processes and files. Detection requires cross-checking kernel module lists, comparison of raw disk vs filesystem views, and trusted boot chains (Secure Boot).</p>

        <div class="explain">
          <strong>Defender’s view:</strong> combine endpoint telemetry (process, registry, memory) + network telemetry (DNS, TLS SNI, flow logs) + identity signals (login anomalies) for robust detection.
        </div>
      </section>

      <section class="card long-read" id="vectors">
        <h2 class="section-title">Propagation & infection vectors — deeper</h2>
        <p>Attackers chain vectors—social engineering to drop a Trojan, then exploit to move laterally. Common vector combos:</p>
        <ul class="list">
          <li>Phishing → Credential theft → RDP access → ransomware</li>
          <li>Malicious dependency in supply chain → signed update pushes backdoor</li>
          <li>Exposed admin interface → brute force → deploy worm across internal network</li>
        </ul>

        <h3>Mitigation patterns</h3>
        <ul class="list">
          <li>Reduce attack surface: close unused ports, adopt Zero Trust segmentation, and disable legacy protocols.</li>
          <li>Harden identities: enforce MFA, short-lived keys, and hardware MFA for admins.</li>
          <li>Software supply chain controls: code signing validation, SBOM (software bill of materials), and controlled update channels.</li>
        </ul>
      </section>

      <section class="card long-read" id="detection">
        <h2 class="section-title">Detection recipes — SIEM correlation & YARA examples</h2>
        <p class="small muted">Below are defensible starting points you can adapt to your environment. Tune thresholds to avoid excessive false positives.</p>

        <h3>SIEM correlation idea — Ransomware early warning</h3>
        <pre>
Rule: ALERT when any host shows:
 - &gt; 100 file write events to dissimilar volumes within 5 minutes AND
 - creation of newly-named ransom file patterns (*.locked, *_README.txt) OR simultaneous creation of many .encrypted files
Action: isolate host VLAN, block host at NAC, notify IR, take EDR snapshot
        </pre>

        <h3>SIEM rule — suspicious PowerShell</h3>
        <pre>
Rule: If process 'powershell.exe' or 'pwsh' is executed with encoded-command or base64 content AND parent is MSWord/Outlook -> high priority alert
Action: capture memory, block execution, notify analyst
        </pre>

        <h3>YARA sample (simple)</h3>
        <pre>
rule Suspicious_Installer_Strings {
 meta:
   author = "Defender"
   description = "Detects common installer obfuscation strings"
 strings:
   $s1 = "CreateProcessA" nocase
   $s2 = "GetProcAddress" nocase
   $s3 = "LoadLibrary" nocase
 condition:
   (uint32(0) == 0x5A4D) and (any of ($s*))
}
        </pre>

        <div class="explain">
          <strong>Notes:</strong> YARA is for static detection on artifacts; combine with dynamic behavioral detections. Always test rules on known-good corpora to reduce false positives.
        </div>
      </section>

      <section class="card long-read" id="net-detect">
        <h2 class="section-title">Network detection — Indicators & heuristics</h2>
        <p>Network telemetry can reveal C2, exfil, and lateral movements. Common heuristics:</p>
        <ul class="list">
          <li><strong>DNS:</strong> fast-flux domains, many small queries to dynamic domains, long domain name entropy, use of uncommon TLDs used by malware.</li>
          <li><strong>Beaconing:</strong> periodic callbacks to the same external IP/domain with consistent intervals — inspect for jitter/variability to reduce false positives.</li>
          <li><strong>HTTP:</strong> weird User-Agents, POSTs to odd endpoints, encrypted payloads on ports not usually used for TLS.</li>
          <li><strong>Flows:</strong> large outbound flows to unknown hosts at odd hours (possible exfil).</li>
        </ul>
        <p class="small muted">Use NetFlow/IPFIX, DNS logs, proxy logs, and TLS metadata (SNI, certificate info) in SIEM to build detections.</p>
      </section>

      <section class="card long-read" id="cases">
        <h2 class="section-title">Detailed case studies & lessons</h2>

        <h3>WannaCry — what defenders can learn</h3>
        <p>
          WannaCry combined a wormable Windows SMB exploit with ransomware payload. It spread quickly across unpatched hosts and highlighted the need for: timely patching, network segmentation, disabling SMBv1, and having offline/backed-up recovery options.
        </p>

        <h3>SolarWinds supply-chain (context)</h3>
        <p>
          While not pure malware in the classic sense, SolarWinds taught defenders about the risk of trusted updates. Build detection rules for unusual outbound behavior from management systems and validate vendor attestations.
        </p>

        <h3>ILOVEYOU — human element</h3>
        <p>
          The ILOVEYOU worm succeeded because users executed attachments. Training + attachment sandboxing + disabling macros in email attachments reduces similar risks.
        </p>
      </section>

      <section class="card long-read" id="sniffing">
        <h2 class="section-title">Sniffing — fundamentals, attack modes & detection</h2>
        <p>
          Packet sniffing captures network traffic for analysis. Attackers sniff to steal credentials and tokens over unencrypted channels. Defenders can also capture packets to troubleshoot or investigate incidents.
        </p>

        <h3>Passive sniffing</h3>
        <p class="small muted">Occurs when an interface naturally sees traffic (hub or mirrored/SPAN port). It's stealthy and hard to detect from the victim's perspective.</p>

        <h3>Active sniffing</h3>
        <p class="small muted">Involves manipulation (ARP spoofing, ICMP redirection) to divert traffic to the attacker — usually detectable by ARP anomalies and duplicate MAC/IP pairs.</p>

        <h3>Detection signals for sniffing/mitm</h3>
        <ul class="list">
          <li>Frequent ARP cache changes or ARP broadcasts from a single host.</li>
          <li>Duplicate IPs seen with different MAC addresses in switch logs.</li>
          <li>Unexpected TLS downgrade attempts or presence of self-signed certs where not expected.</li>
        </ul>
      </section>

      <section class="card long-read" id="sniff-tools">
        <h2 class="section-title">Tools & safe lab commands (defensive focus)</h2>
        <p class="small muted">Use in isolated labs only. Commands illustrate capture and analysis techniques for investigators.</p>

        <h3>Capture tips</h3>
        <pre>
# Capture on interface (root)
sudo tcpdump -i eth0 -s 0 -w /tmp/capture.pcap

# Capture only DNS queries
sudo tcpdump -i eth0 -s 0 -w dns.pcap port 53
        </pre>

        <h3>Analyze with tshark / Wireshark</h3>
        <pre>
# Show HTTP requests
tshark -r capture.pcap -Y http.request

# Extract files from pcap (useful when investigating exfil)
strings capture.pcap | less
        </pre>

        <h3>Detect ARP spoofing</h3>
        <pre>
# Linux: show ARP table and look for frequent changes
ip neigh show

# Use arping to confirm MAC for gateway IP
sudo arping -c 3 -I eth0 10.0.0.1
        </pre>

        <div class="explain">
          <strong>Lab idea:</strong> create two VMs and a dedicated switch/virtual network. Use one VM as attacker with <code>ettercap</code> to ARP-spoof and use Wireshark on the victim to observe captured packets. Then enable DHCP snooping and dynamic ARP inspection on the virtual switch to test defenses.
        </div>
      </section>

      <section class="card long-read" id="ir">
        <h2 class="section-title">Incident Response — ransomware & sniffing incidents (step-by-step)</h2>
        <ol class="list">
          <li><strong>Identification:</strong> collect alerts (EDR/SIEM), isolate affected hosts from the network (quarantine), preserve evidence (memory & disk images), and record timestamps & scope.</li>
          <li><strong>Containment:</strong> block C2 domains/ips at firewall, rotate credentials, revoke sessions for compromised accounts.</li>
          <li><strong>Eradication:</strong> remove malware using EDR tools or rebuild from known-good images; ensure rootkits are removed and kernel integrity restored.</li>
          <li><strong>Recovery:</strong> restore systems from verified backups, reintroduce hosts into network, monitor for re-infection for 30 days.</li>
          <li><strong>Post-incident:</strong> update detection rules, patch systems, and run lessons-learned and tabletop exercises to close gaps.</li>
        </ol>
      </section>

      <section class="card long-read" id="ethics">
        <h2 class="section-title">Legal & ethical considerations (expanded)</h2>
        <p class="small muted">
          Many commands/tools are dual-use. Only perform offensive or intrusive actions with explicit written authorization. In regulated industries, coordinate with legal/compliance teams before investigation or notification. Maintain chain-of-custody for evidence if law enforcement becomes involved.
        </p>
      </section>

      <section class="card" id="quiz">
        <h2 class="section-title">Quiz — Malware & Sniffing (12 questions)</h2>
        <p class="small muted">This quiz reinforces detection and response concepts. Use the explanations after submission to learn.</p>

        <form id="msQuiz">
          <!-- Q1..Q12 (same as before) -->
          <div class="q-card">
            <h4>1) Which indicator is most associated with fileless malware?</h4>
            <div class="q-options">
              <label><input type="radio" name="q1" value="a"> New executable file on disk</label>
              <label><input type="radio" name="q1" value="b"> Powershell with encoded commands and no corresponding disk artifact</label>
              <label><input type="radio" name="q1" value="c"> Presence of ransom note files</label>
            </div>
          </div>
          <!-- ... rest of questions omitted here for brevity but remain identical to your source ... -->

          <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
            <button type="button" class="btn primary" id="submitQuiz">Submit Quiz</button>
            <button type="button" class="btn" id="resetQuiz">Reset</button>
            <span id="quizResult" class="result" aria-live="polite"></span>
          </div>
        </form>
      </section>

      <section class="card">
        <h2>Resources & further learning</h2>
        <ul class="list">
          <li><strong>Books:</strong> Practical Malware Analysis; The Practice of Network Security Monitoring.</li>
          <li><strong>Tools to evaluate:</strong> Wireshark, Zeek (Bro), Suricata, Elastic/ELK, Velociraptor, GRR, YARA.</li>
          <li><strong>Communities:</strong> Malware Traffic Analysis, The DFIR community on Twitter/Discord, SANS DFIR resources.</li>
        </ul>
      </section>

      <footer class="container">
        <p class="small muted">© Learning Playground — Malware & Sniffing • Expanded • For authorized defensive lab use only</p>
      </footer>
    </article>

    <aside class="sidebar" aria-label="Sidebar">
      <div class="card">
        <h3>Quick Links</h3>
        <ul class="list">
          <li><a href="#what-malware">What is Malware?</a></li>
          <li><a href="#types">Malware Types</a></li>
          <li><a href="#vectors">Infection Vectors</a></li>
          <li><a href="#detection">Detection Recipes</a></li>
          <li><a href="#net-detect">Network Detection</a></li>
          <li><a href="#sniffing">Sniffing Fundamentals</a></li>
          <li><a href="#sniff-tools">Sniffing Tools</a></li>
          <li><a href="#quiz">Quiz</a></li>
        </ul>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Cheat Sheet</h3>
        <div class="metric"><strong>Protect:</strong> patch, segment, MFA, EDR, backups</div>
        <div class="metric"><strong>Detect:</strong> SIEM rules, NetFlow, DNS anomalies</div>
        <div class="metric"><strong>Respond:</strong> isolate, triage, preserve, restore</div>
        <div class="metric warn-box"><strong class="muted">Lab safety:</strong> test only in isolated networks; use snapshots and restore points.</div>
      </div>
    </aside>
  </main>

  <!-- Mobile Back button visible on tablet/phone -->
  <a href="cyber-index.html" class="mobile-back-btn" aria-label="Back to lessons (mobile)">
    <span class="mobile-back-icon" aria-hidden="true">◀</span>
    <span class="mobile-back-text">Lessons</span>
  </a>

  <!-- TTS Control Bar (enhanced) -->
  <div id="ttsBar" class="tts-bar" aria-hidden="false" role="region" aria-label="Text to speech controls" data-compact="false">
    <button id="ttsCollapse" type="button" aria-expanded="true" title="Collapse/Expand TTS">≡</button>

    <div class="tts-controls" aria-hidden="false">
      <button id="ttsPlay" type="button" title="Play" aria-label="Play">▶</button>
      <button id="ttsPause" type="button" title="Pause" aria-label="Pause">⏸</button>
      <button id="ttsStop" type="button" title="Stop" aria-label="Stop">⏹</button>

      <span class="label">Voice</span>
      <select id="ttsVoices" aria-label="Select voice"></select>

      <span class="label">Rate</span>
      <input id="ttsRate" type="range" min="0.6" max="2" step="0.1" value="1" aria-label="Speech rate" />

      <span class="label">Pitch</span>
      <input id="ttsPitch" type="range" min="0.6" max="2" step="0.1" value="1" aria-label="Speech pitch" />

      <button id="ttsToggleAuto" class="btn" type="button" aria-pressed="false" title="Auto-read on load">A</button>
    </div>
  </div>

  <script>
    /* THEME, DOWNLOAD, COPY, QUIZ, TTS — same behavior as before (kept intact) */
    /* For brevity I preserved the same javascript logic you already had, but with one addition:
       — On small screens the TTS bar will default to compact mode (handled below) and desktop back button is hidden.
       The main JS body (theme toggle, download, copy, quiz, TTS) remains identical to the previous working version.
    */

    /* ---------- Theme toggle ---------- */
    const themeBtn = document.getElementById('toggleTheme');
    const themeKey = 'lesson8.theme';
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    function applyTheme(mode) {
      if (mode === 'light') {
        document.documentElement.style.setProperty('--bg','#f4f7fb');
        document.documentElement.style.setProperty('--card','#ffffff');
        document.documentElement.style.setProperty('--text','#072033');
        document.documentElement.style.setProperty('--muted','#4a5875');
        document.documentElement.style.setProperty('--accent','#3b82f6');
        document.documentElement.style.setProperty('--accent-2','#34d399');
      } else {
        document.documentElement.style.setProperty('--bg','#071226');
        document.documentElement.style.setProperty('--card','#0f1b36');
        document.documentElement.style.setProperty('--text','#e8f3ff');
        document.documentElement.style.setProperty('--muted','#9fb6d7');
        document.documentElement.style.setProperty('--accent','#63a6ff');
        document.documentElement.style.setProperty('--accent-2','#76f0c4');
      }
    }
    const storedTheme = localStorage.getItem(themeKey);
    const initialTheme = storedTheme || (prefersDark ? 'dark' : 'dark');
    applyTheme(initialTheme);
    if (themeBtn) {
      themeBtn.setAttribute('aria-pressed', initialTheme === 'dark' ? 'true' : 'false');
      themeBtn.addEventListener('click', () => {
        const cur = localStorage.getItem(themeKey) || initialTheme;
        const next = cur === 'dark' ? 'light' : 'dark';
        localStorage.setItem(themeKey, next);
        applyTheme(next);
        themeBtn.setAttribute('aria-pressed', next === 'dark' ? 'true' : 'false');
      });
    }

    /* ---------- Download notes ---------- */
    const downloadBtn = document.getElementById('downloadNotes');
    if (downloadBtn) downloadBtn.addEventListener('click', () => {
      const nodes = document.querySelectorAll('article h2, article h3, article p, article li, article pre');
      const lines = [];
      nodes.forEach(n => {
        const t = n.tagName.toLowerCase();
        if (t === 'h2') lines.push('\n' + n.innerText + '\n' + '-'.repeat(60));
        else if (t === 'h3') lines.push('\n' + n.innerText + '\n');
        else if (t === 'pre') lines.push('```\n' + n.innerText + '\n```\n');
        else lines.push(n.innerText);
      });
      const blob = new Blob([lines.join('\n')], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'Lesson8_Malware_Sniffing_Notes.txt'; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 800);
    });

    /* ---------- Copy Markdown ---------- */
    const copyBtn = document.getElementById('copyMarkdown');
    if (copyBtn) copyBtn.addEventListener('click', async () => {
      const nodes = document.querySelectorAll('article h2, article h3, article p, article li, article pre');
      let md = '';
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h2') md += `## ${n.innerText}\n\n`;
        else if (tag === 'h3') md += `### ${n.innerText}\n\n`;
        else if (tag === 'li') md += `- ${n.innerText}\n`;
        else if (tag === 'pre') md += '```\n' + n.innerText + '\n```\n\n';
        else md += `${n.innerText}\n\n`;
      });
      try { await navigator.clipboard.writeText(md); alert('Copied lesson content as Markdown to clipboard.'); }
      catch(e){ alert('Could not copy to clipboard.'); }
    });

    /* ---------- Quiz (same) ---------- */
    const answers = {
      q1: 'b', q2: 'b', q3: 'b', q4: 'b', q5: 'a', q6: 'b',
      q7: 'b', q8: 'b', q9: 'a', q10: 'b', q11: 'a', q12: 'b'
    };
    const explanations = {
      q1: 'Fileless malware often uses PowerShell or WMI and avoids creating disk artifacts.',
      q2: 'Many random DNS queries is a hallmark of DGA/Fast-flux used by malware C2.',
      q3: 'Isolating infected hosts preserves evidence and prevents lateral movement.',
      q4: 'ARP spoofing actively changes network mappings — that is an active MITM/sniffing technique.',
      q5: 'TLS + VPN protects traffic over untrusted networks; never use cleartext protocols on public Wi-Fi.',
      q6: 'Regular, periodic small connections are common for C2 beaconing.',
      q7: 'Immutable, offline backups plus tested restores are key ransomware defenses.',
      q8: 'YARA is for matching patterns in files/artifacts (static detection).',
      q9: 'tcpdump is the standard packet capture tool on Linux; the shown command captures to a pcap file.',
      q10: 'Rootkits hide artifacts; discrepancies between raw disk and filesystem views are suspicious.',
      q11: 'DHCP snooping and dynamic ARP inspection prevent rogue DHCP/ARP poisoning attacks.',
      q12: 'Enriching the IP and checking host telemetry helps determine whether to contain and block.'
    };

    const form = document.getElementById('msQuiz');
    const submitBtn = document.getElementById('submitQuiz');
    const resetBtn = document.getElementById('resetQuiz');
    const resultEl = document.getElementById('quizResult');

    function grade() {
      let score = 0, missed = [];
      for (let i = 1; i <= 12; i++) {
        const q = 'q' + i;
        const el = form.querySelector(`input[name="${q}"]:checked`);
        if (el && el.value === answers[q]) {
          score++;
          el.closest('.q-options').style.background = 'linear-gradient(90deg, rgba(120,200,255,0.06), rgba(120,255,200,0.02))';
        } else {
          missed.push(q);
          if (el) el.closest('.q-options').style.background = 'linear-gradient(90deg, rgba(255,120,140,0.04), rgba(0,0,0,0.01))';
        }
      }
      const total = 12;
      const pct = Math.round((score/total)*100);
      resultEl.textContent = `Score: ${score}/${total} (${pct}%)`;
      resultEl.style.color = pct >= 80 ? '#7ef0c1' : pct >= 60 ? '#ffd66e' : '#ff758f';

      // Append explanations
      const existing = document.getElementById('quizReview');
      if (existing) existing.remove();
      const review = document.createElement('div');
      review.id = 'quizReview';
      review.style.marginTop = '12px';
      review.style.padding = '12px';
      review.style.borderRadius = '10px';
      review.style.background = 'rgba(255,255,255,0.02)';
      let html = '<strong>Review & Explanations</strong><ul>';
      for (let i = 1; i <= 12; i++) {
        const q = 'q' + i;
        html += `<li><strong>Q${i}</strong> — Correct: <em>${answers[q].toUpperCase()}</em>. ${explanations[q]}</li>`;
      }
      html += '</ul>';
      review.innerHTML = html;
      form.appendChild(review);

      submitBtn.disabled = true;
      localStorage.setItem('lesson8-quiz', JSON.stringify({ score, pct, ts: Date.now() }));
    }

    if (submitBtn) submitBtn.addEventListener('click', grade);
    if (resetBtn) resetBtn.addEventListener('click', () => {
      form.reset();
      form.querySelectorAll('.q-options').forEach(el => el.style.background = '');
      resultEl.textContent = '';
      const existing = document.getElementById('quizReview'); if (existing) existing.remove();
      if (submitBtn) submitBtn.disabled = false;
      localStorage.removeItem('lesson8-quiz');
    });
    (function restore() {
      const raw = localStorage.getItem('lesson8-quiz');
      if (!raw) return;
      try {
        const obj = JSON.parse(raw);
        if (obj && obj.pct !== undefined) {
          resultEl.textContent = `Previous Score: ${obj.pct}%`;
          resultEl.style.color = obj.pct >= 80 ? '#7ef0c1' : obj.pct >= 60 ? '#ffd66e' : '#ff758f';
          if (submitBtn) submitBtn.disabled = true;
        }
      } catch (e) {}
    })();

    /* ---------- Enhanced TTS (responsive / compact defaults) ---------- */
    (function () {
      const STORAGE_PREFIX = 'lesson8.tts';
      const AUTO_KEY = STORAGE_PREFIX + '.auto';
      const COMPACT_KEY = STORAGE_PREFIX + '.compact';
      const RESUME_KEY = STORAGE_PREFIX + '.index';
      const VOICE_KEY = STORAGE_PREFIX + '.voice';
      const RATE_KEY = STORAGE_PREFIX + '.rate';
      const PITCH_KEY = STORAGE_PREFIX + '.pitch';
      const HINT_KEY = STORAGE_PREFIX + '.hint';
      const HOME = 'cyber-index.html';

      const ttsBar = document.getElementById('ttsBar');
      const playBtn = document.getElementById('ttsPlay');
      const pauseBtn = document.getElementById('ttsPause');
      const stopBtn = document.getElementById('ttsStop');
      const voicesSelect = document.getElementById('ttsVoices');
      const rateInput = document.getElementById('ttsRate');
      const pitchInput = document.getElementById('ttsPitch');
      const autoBtn = document.getElementById('ttsToggleAuto');
      const collapseBtn = document.getElementById('ttsCollapse');
      const lesson = document.querySelector('article') || document.body;

      if (!ttsBar) return;
      if (!('speechSynthesis' in window)) { ttsBar.style.display='none'; adjustForTTS(); return; }

      // Desktop back injected, hidden on small screens
      (function injectDesktopBack(){
        if (document.querySelector('.desktop-back-btn')) return;
        const btn = document.createElement('button');
        btn.className = 'desktop-back-btn';
        btn.type = 'button';
        btn.title = 'Back to lessons';
        btn.setAttribute('aria-label','Back to lessons');
        btn.innerText = '◀ Lessons';
        Object.assign(btn.style, {
          position: 'fixed',
          left: '18px',
          top: '18px',
          zIndex: 9999,
          padding: '8px 12px',
          borderRadius: '10px',
          border: '1px solid rgba(255,255,255,0.06)',
          background: 'rgba(255,255,255,0.02)',
          color: 'var(--text)',
          fontWeight: 700,
          cursor: 'pointer',
          backdropFilter: 'blur(6px)'
        });
        document.body.appendChild(btn);
        function update() { btn.style.display = window.innerWidth <= 980 ? 'none' : 'inline-flex'; }
        update();
        window.addEventListener('resize', update);
        btn.addEventListener('click', () => { window.location.href = HOME; });
      })();

      const S = {
        voices: [],
        sentences: [],
        idx: parseInt(localStorage.getItem(RESUME_KEY) || '0', 10) || 0,
        utterance: null,
        auto: localStorage.getItem(AUTO_KEY) === 'true',
        compact: (localStorage.getItem(COMPACT_KEY) === 'true') || (window.matchMedia('(max-width:820px)').matches),
        readingOnScroll: false,
        muted: false
      };

      function safeScrollIntoView(node) {
        if (!node) return;
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        try { node.scrollIntoView({ behavior: prefersReduced ? 'auto' : 'smooth', block: 'center' }); }
        catch (e) { node.scrollIntoView(); }
      }
      function loadVoices() {
        return new Promise((resolve) => {
          let v = speechSynthesis.getVoices();
          if (v.length) { S.voices = v; resolve(v); return; }
          speechSynthesis.onvoiceschanged = () => { v = speechSynthesis.getVoices(); S.voices = v; resolve(v); };
          setTimeout(() => { v = speechSynthesis.getVoices(); S.voices = v; resolve(v); }, 1200);
        });
      }
      async function populateVoices() {
        const voices = await loadVoices();
        if (!voicesSelect) return;
        voicesSelect.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.voiceURI || v.name;
          opt.textContent = `${v.name} (${v.lang})${v.default ? ' — default' : ''}`;
          voicesSelect.appendChild(opt);
        });
        const stored = localStorage.getItem(VOICE_KEY);
        if (stored) try { voicesSelect.value = stored; } catch(e){}
      }
      populateVoices();

      function buildSentences() {
        const nodes = lesson.querySelectorAll('h1,h2,h3,p,li,pre');
        const arr = [];
        nodes.forEach(n => {
          const txt = n.innerText.trim();
          if (!txt) return;
          const parts = txt.split(/(?<=[.?!])\s+/);
          parts.forEach(p => { if (p && p.trim()) arr.push({ text: p.trim(), node: n }); });
        });
        S.sentences = arr;
      }

      function clearHighlights() {
        const els = lesson.querySelectorAll('.tts-highlight');
        els.forEach(el => el.classList.remove('tts-highlight'));
      }
      function highlightNode(node) {
        clearHighlights();
        if (!node) return;
        node.classList.add('tts-highlight');
        safeScrollIntoView(node);
      }

      function pickVoiceByValue(val) {
        return S.voices.find(v => (v.voiceURI && v.voiceURI === val) || v.name === val || v.name.includes(val)) || S.voices.find(v => v.default) || S.voices[0];
      }

      function deviceDefaultRate() {
        const w = window.innerWidth;
        if (w <= 420) return 0.95;
        if (w <= 820) return 1.0;
        return 1.08;
      }

      function speakObj(obj) {
        if (!obj || !obj.text) { S.idx++; return; }
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(obj.text);
        const voiceURI = (voicesSelect && voicesSelect.value) || localStorage.getItem(VOICE_KEY) || '';
        const selected = pickVoiceByValue(voiceURI);
        if (selected) u.voice = selected;
        u.rate = rateInput ? parseFloat(rateInput.value) : deviceDefaultRate();
        u.pitch = pitchInput ? parseFloat(pitchInput.value) : 1.0;
        u.volume = S.muted ? 0 : 1;
        u.onstart = () => highlightNode(obj.node);
        u.onend = () => {
          S.idx++;
          localStorage.setItem(RESUME_KEY, String(S.idx));
          if (S.idx < S.sentences.length) {
            setTimeout(() => speakObj(S.sentences[S.idx]), 110);
          } else {
            S.idx = 0;
            localStorage.setItem(RESUME_KEY, '0');
            clearHighlights();
          }
        };
        S.utterance = u;
        speechSynthesis.speak(u);
      }

      function play(index) {
        if (!S.sentences.length) buildSentences();
        if (typeof index === 'number') S.idx = index;
        if (S.idx >= S.sentences.length) S.idx = 0;
        if (speechSynthesis.paused) return speechSynthesis.resume();
        speakObj(S.sentences[S.idx]);
      }
      function pauseToggle() {
        if (speechSynthesis.speaking && !speechSynthesis.paused) speechSynthesis.pause();
        else if (speechSynthesis.paused) speechSynthesis.resume();
      }
      function stop() {
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
        S.idx = 0;
        localStorage.setItem(RESUME_KEY, '0');
        clearHighlights();
      }
      function speakText(text) {
        if (!text || !text.trim()) return;
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        const voiceURI = (voicesSelect && voicesSelect.value) || localStorage.getItem(VOICE_KEY) || '';
        const selected = pickVoiceByValue(voiceURI);
        if (selected) u.voice = selected;
        u.rate = rateInput ? parseFloat(rateInput.value) : deviceDefaultRate();
        u.pitch = pitchInput ? parseFloat(pitchInput.value) : 1.0;
        speechSynthesis.speak(u);
      }
      function toggleAuto() {
        S.auto = !S.auto;
        localStorage.setItem(AUTO_KEY, S.auto ? 'true' : 'false');
        if (autoBtn) { autoBtn.style.opacity = S.auto ? '1' : '0.6'; autoBtn.setAttribute('aria-pressed', S.auto ? 'true' : 'false'); }
      }
      function setCompact(flag) {
        if (!ttsBar) return;
        ttsBar.setAttribute('data-compact', flag ? 'true' : 'false');
        localStorage.setItem(COMPACT_KEY, flag ? 'true' : 'false');
        if (collapseBtn) collapseBtn.setAttribute('aria-expanded', flag ? 'false' : 'true');
      }

      playBtn && playBtn.addEventListener('click', () => { play(0); });
      pauseBtn && pauseBtn.addEventListener('click', pauseToggle);
      stopBtn && stopBtn.addEventListener('click', stop);
      voicesSelect && voicesSelect.addEventListener('change', () => localStorage.setItem(VOICE_KEY, voicesSelect.value));
      rateInput && rateInput.addEventListener('input', () => localStorage.setItem(RATE_KEY, rateInput.value));
      pitchInput && pitchInput.addEventListener('input', () => localStorage.setItem(PITCH_KEY, pitchInput.value));
      if (autoBtn) { autoBtn.style.opacity = S.auto ? '1' : '0.6'; autoBtn.setAttribute('aria-pressed', S.auto ? 'true' : 'false'); autoBtn.addEventListener('click', toggleAuto); }
      if (collapseBtn) collapseBtn.addEventListener('click', () => { const cur = ttsBar.getAttribute('data-compact') === 'true'; setCompact(!cur); });

      (function init() {
        const storedCompact = localStorage.getItem(COMPACT_KEY);
        const shouldDefault = window.matchMedia('(max-width:820px)').matches;
        const compact = storedCompact === null ? shouldDefault : (storedCompact === 'true');
        setCompact(compact);

        const r = localStorage.getItem(RATE_KEY);
        const p = localStorage.getItem(PITCH_KEY);
        const v = localStorage.getItem(VOICE_KEY);
        if (r && rateInput) rateInput.value = r;
        if (p && pitchInput) pitchInput.value = p;
        if (v && voicesSelect) setTimeout(()=> { try { voicesSelect.value = v; } catch(e){} }, 600);
      })();

      function handleResize() {
        const narrow = window.matchMedia('(max-width:420px)').matches;
        const tablet = window.matchMedia('(max-width:820px)').matches && !narrow;
        const userSet = localStorage.getItem(COMPACT_KEY);
        if (userSet === null) {
          if (narrow) setCompact(true);
          else setCompact(false);
        }
        if (voicesSelect) {
          if (narrow) voicesSelect.style.maxWidth = '120px';
          else if (tablet) voicesSelect.style.maxWidth = '180px';
          else voicesSelect.style.maxWidth = '240px';
        }
        const desktopBtn = document.querySelector('.desktop-back-btn');
        if (desktopBtn) desktopBtn.style.display = window.innerWidth <= 980 ? 'none' : 'inline-flex';
      }
      window.addEventListener('resize', handleResize);
      window.addEventListener('orientationchange', () => setTimeout(handleResize, 260));
      handleResize();

      window.addEventListener('keydown', (e) => {
        const tag = (e.target && e.target.tagName || '').toLowerCase();
        if (tag === 'input' || tag === 'textarea' || e.target.isContentEditable) return;
        if (e.code === 'Space') { e.preventDefault(); if (speechSynthesis.speaking && !speechSynthesis.paused) pauseToggle(); else if (speechSynthesis.paused) pauseToggle(); else play(S.idx || 0); }
        else if (e.key === 's' || e.key === 'S') stop();
        else if (e.key === 'b' || e.key === 'B') window.location.href = HOME;
        else if (e.key === '+' || e.key === '=') { if (rateInput) { rateInput.value = Math.min(parseFloat(rateInput.value) + 0.1, parseFloat(rateInput.max)); localStorage.setItem(RATE_KEY, rateInput.value); } }
        else if (e.key === '-') { if (rateInput) { rateInput.value = Math.max(parseFloat(rateInput.value) - 0.1, parseFloat(rateInput.min)); localStorage.setItem(RATE_KEY, rateInput.value); } }
        else if (e.key === 'm' || e.key === 'M') { S.muted = !S.muted; }
        else if (e.key === 'r' || e.key === 'R') { const sel = window.getSelection().toString().trim(); if (sel) speakText(sel); }
        else if (e.key === 'a' || e.key === 'A') toggleAuto();
        else if (e.key === 't' || e.key === 'T') { S.readingOnScroll = !S.readingOnScroll; alert('Read-on-scroll: ' + (S.readingOnScroll ? 'ON' : 'OFF')); }
      });

      (function doubleTap() {
        let last = 0;
        lesson.addEventListener('touchend', (ev) => {
          const now = Date.now();
          if (now - last < 350) {
            if (speechSynthesis.speaking && !speechSynthesis.paused) pauseToggle();
            else play(S.idx || 0);
            last = 0;
            return;
          }
          last = now;
        }, { passive: true });
      })();

      (function readOnScroll() {
        if (!('IntersectionObserver' in window)) return;
        const io = new IntersectionObserver((entries) => {
          if (!S.readingOnScroll) return;
          entries.forEach(en => {
            if (en.isIntersecting && en.intersectionRatio > 0.6) {
              const node = en.target;
              const idx = S.sentences.findIndex(s => s.node === node);
              if (idx >= 0) { S.idx = idx; play(idx); }
            }
          });
        }, { threshold: [0.6] });
        function observe() {
          const nodes = lesson.querySelectorAll('h1,h2,h3,p,li,pre');
          nodes.forEach(n => io.observe(n));
        }
        observe();
        const mo = new MutationObserver(observe);
        mo.observe(lesson, { childList: true, subtree: true });
      })();

      window.CyberEnh = {
        play: () => play(0),
        pause: () => pauseToggle(),
        stop: () => stop(),
        speakText: (t) => speakText(t),
        toggleAutoRead: () => toggleAuto(),
        selectVoice: (nameOrURI) => {
          if (!voicesSelect || !nameOrURI) return;
          const opt = Array.from(voicesSelect.options).find(o => o.value === nameOrURI || o.textContent.includes(nameOrURI));
          if (opt) { voicesSelect.value = opt.value; localStorage.setItem(VOICE_KEY, opt.value); }
        },
        getState: () => ({ idx: S.idx, auto: S.auto, muted: S.muted })
      };

      window.addEventListener('load', () => {
        buildSentences();
        if (S.auto) {
          try { play(S.idx || 0); } catch (e) { console.warn('Auto TTS blocked by browser, user must press Play to start.'); }
        }
      });

      if (!localStorage.getItem(HINT_KEY)) {
        setTimeout(()=> console.info('TTS shortcuts: Space play/pause • S stop • B back • +/- speed • R read selection • A toggle auto'), 1000);
        localStorage.setItem(HINT_KEY, '1');
      }
    })();

    /* adjust layout for TTS bar so anchors are not covered */
    function adjustForTTS() {
      const bar = document.getElementById('ttsBar');
      if (!bar) return;
      const rect = bar.getBoundingClientRect();
      const computedStyle = window.getComputedStyle(bar);
      const marginBottom = parseFloat(computedStyle.marginBottom || 0);
      const marginTop = parseFloat(computedStyle.marginTop || 0);
      const totalHeight = Math.ceil(rect.height + marginTop + marginBottom);
      document.documentElement.style.setProperty('--tts-height', totalHeight + 'px');
      document.querySelectorAll('.container').forEach(el => {
        const base = 18;
        el.style.paddingBottom = (base + totalHeight + 10) + 'px';
      });
    }
    window.addEventListener('load', ()=> { setTimeout(adjustForTTS, 200); setTimeout(adjustForTTS, 900); });
    window.addEventListener('resize', ()=> { setTimeout(adjustForTTS, 120); });

    console.warn("SAFETY: Examples and commands are for authorized lab use only. Do not run offensive tools on networks or systems you do not have permission to test.");
  </script>
</body>
</html>
