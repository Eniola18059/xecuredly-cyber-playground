<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lesson 11 ‚Äî Threat Detection & Response (Expanded Deep Dive) + TTS + Quiz</title>
<style>
  :root{
    --bg:#041028; --card:#0f2236; --muted:#9db7d9; --text:#e9f6ff;
    --accent:#57a7ff; --accent2:#7ef0c8; --danger:#ff7a7a; --ok:#9ef0b2;
    --tts-height:96px; --header-height:74px; --container-pad:20px;
  }
  *{box-sizing:border-box}
  html { scroll-behavior: smooth; scroll-padding-top: calc(var(--header-height) + 18px); scroll-padding-bottom: calc(var(--tts-height) + 20px); }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:linear-gradient(135deg,var(--bg) 0%, #021427 100%);color:var(--text);-webkit-font-smoothing:antialiased}
  .container{max-width:1200px;margin:0 auto;padding:var(--container-pad);padding-bottom: calc(28px + var(--tts-height));}
  header{position:sticky;top:0;background:rgba(2,10,30,0.65);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03);padding:12px 0;z-index:40}
  .hdr{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:nowrap}
  .left{display:flex;align-items:center;gap:12px;min-width:0}
  .badge{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#021024;padding:8px 14px;border-radius:999px;font-weight:800;flex-shrink:0}
  h1{font-size:clamp(22px,3.6vw,36px);margin:6px 0}
  .subtitle{color:var(--muted);font-size:14px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:18px;border-radius:12px;margin-top:18px;box-shadow:0 10px 30px rgba(0,0,0,0.45)}
  .list{padding-left:20px}
  .list li{margin:8px 0}
  .muted{color:var(--muted)}
  .callout{background:linear-gradient(180deg,rgba(126,240,193,0.04),rgba(126,240,193,0.02));border:1px solid rgba(126,240,193,0.08);padding:10px;border-radius:8px}
  .warn{background:linear-gradient(180deg,rgba(255,123,123,0.04),rgba(255,123,123,0.02));border:1px solid rgba(255,123,123,0.06);padding:10px;border-radius:8px}
  .controls{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  .btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#021024;border:none}
  pre{background:rgba(0,0,0,0.15);padding:12px;border-radius:8px;overflow:auto}
  footer{opacity:.9;padding:30px 0 60px;font-size:13px;color:var(--muted)}
  .section-sub{color:var(--muted);margin-top:6px;font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}
  @media (max-width:1100px){ .grid{grid-template-columns:1fr} }
  .quiz .q{margin:12px 0;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .result{margin-top:12px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .small{font-size:13px;color:var(--muted)}
  code{background:rgba(255,255,255,0.02);padding:2px 6px;border-radius:6px}
  /* TTS bar */
  .tts-bar{position:fixed;right:18px;bottom:18px;z-index:9999;background:rgba(1,6,12,0.88);color:#00ffcc;padding:10px 12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6);font-family:'Share Tech Mono',monospace;display:flex;gap:8px;align-items:center;backdrop-filter:blur(6px);min-width:340px;transition:all .14s ease}
  .tts-bar button{background:linear-gradient(45deg,#ff0080,#7928ca);border:none;color:#fff;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer;min-width:44px}
  .tts-bar .small{padding:6px 8px;min-width:36px}
  .tts-bar select,.tts-bar input[type="range"]{background:rgba(255,255,255,0.06);color:#00ffcc;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:8px;font-family:inherit}
  .tts-highlight{background:rgba(0,255,200,0.15);transition:background 0.2s;padding:0 2px;border-radius:3px}
  @media (max-width:600px){.tts-bar{left:50%;transform:translateX(-50%);right:auto;bottom:12px;min-width:88%}}
  /* compact mode */
  .tts-bar[data-compact="true"]{min-width:58px;max-width:58px;padding:6px;border-radius:999px;gap:0;overflow:hidden}
  .tts-bar[data-compact="true"] .tts-controls{display:none}
  .tts-bar[data-compact="true"] #ttsCollapse{border-radius:999px;padding:8px;width:38px;height:38px}
  .mobile-back-btn{display:none}
  @media (max-width:1024px){
    .mobile-back-btn{
      display:inline-flex;align-items:center;gap:8px;position:fixed;left:12px;bottom:calc(12px + env(safe-area-inset-bottom));z-index:9998;text-decoration:none;padding:9px 12px;border-radius:999px;background:rgba(255,255,255,0.98);color:#021024;font-weight:700;box-shadow:0 8px 28px rgba(2,6,23,0.36);-webkit-tap-highlight-color:transparent;transition:transform .12s ease,box-shadow .12px ease;border:1px solid rgba(0,0,0,0.06);backdrop-filter:blur(6px)
    }
    .mobile-back-btn:active{transform:translateY(1px)}
    .mobile-back-btn:focus{outline:3px solid rgba(110,168,255,0.12);outline-offset:2px}
  }
  @media (max-width:900px){
    :root{--container-pad:14px;--header-height:68px}
    .hdr{flex-wrap:wrap;align-items:flex-start;padding:10px}
    .subtitle{display:block}
    .badge{padding:6px 10px}
    .container{padding-left:14px;padding-right:14px}
    .card{padding:14px}
  }
  @media (max-width:600px){
    :root{--container-pad:10px;--header-height:64px}
    .subtitle{display:none}
    .hdr{gap:8px}
    .container{padding-left:10px;padding-right:10px}
    .tts-bar{min-width:88%}
  }
  mark.tts-mark{background:rgba(0,255,200,0.15);padding:0 2px;border-radius:3px;color:inherit}
  :focus{outline:3px solid rgba(110,168,255,0.12);outline-offset:2px}
  .sidebar{position:sticky;top:calc(var(--header-height) + 10px)}
  .sidebar .card{margin-top:0}
  .sidebar .list a{display:block;padding:8px;border-radius:6px}
</style>
</head>
<body>
  <header>
    <div class="container hdr" role="banner">
      <div class="left">
        <span class="badge">Lesson 11</span>
        <div style="min-width:0;overflow:hidden">
          <strong style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Threat Detection & Response ‚Äî Expanded Deep Dive</strong>
          <div class="subtitle">SIEM internals, detection engineering, IR playbooks, hunting, MDR, KPIs, legal & forensics, TTS & quiz</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
        <button class="btn" id="downloadNotes">üì• Download Notes</button>
        <button class="btn primary" id="copyMd">üìã Copy as Markdown</button>
        <button class="btn" id="toggleTheme" aria-pressed="false" title="Toggle theme">üåó Theme</button>
      </div>
    </div>
  </header>

  <main class="container grid" role="main" aria-live="polite">
    <article class="card lesson-content" aria-live="polite">
      <h1>Threat Detection & Response ‚Äî Full Explanation</h1>
      <p class="section-sub">Operational guidance: what to log, SIEM normalization, detection engineering, IR playbooks, threat hunting, MDR, KPIs, legal/forensics, TTS, and a 10-question quiz.</p>

      <section class="card">
        <h2>Important terms ‚Äî Event, Alert, Incident (detailed)</h2>
        <p>
          These three terms form the hierarchy of severity in security monitoring. Understanding the operational differences helps you design reliable monitoring and avoid analyst overload.
        </p>

        <h3>Event (expanded)</h3>
        <p class="muted">
          An event is a single observable data point: a login attempt, a process spawn, a DNS lookup, a firewall accept/deny, or a configuration change. Events are high-volume ‚Äî thousands to millions per day in mid-sized networks ‚Äî and are the raw material for detection.
        </p>
        <p>
          <strong>Examples of event sources:</strong>
          <ul class="list">
            <li>Windows Security logs (logon success/failure, privilege changes)</li>
            <li>Syslog from routers, switches, firewalls</li>
            <li>Application logs (web server access logs, database audit logs)</li>
            <li>Endpoint telemetry (process creation, file writes, driver events)</li>
            <li>Cloud platform audit logs (IAM changes, API calls)</li>
            <li>Network flows (NetFlow, sFlow) and packet captures</li>
          </ul>
        </p>

        <h3>Alert (expanded)</h3>
        <p class="muted">
          An alert is generated when a rule, analytics model, correlation, or threshold flags one or more events as suspicious. Alerts are how monitoring surfaces potential problems to humans. A single malicious campaign might generate dozens of alerts across many devices.
        </p>
        <p>
          Effective alerts are:
          <ul class="list">
            <li><strong>Actionable:</strong> contain sufficient context to triage (who, what, where, when)</li>
            <li><strong>Prioritized:</strong> scored by risk so analysts focus on critical items</li>
            <li><strong>Tuned:</strong> tuned to reduce noise and false positives</li>
          </ul>
        </p>

        <h3>Incident (expanded)</h3>
        <p class="muted">
          An incident is an event or collection of alerts that represent an actual compromise, data leak, or operational disruption. Incidents require documented IR action: containment, eradication, recovery and post-incident lessons. Proper incident classification (severity, scope, business impact) drives escalation and legal/PR notification.
        </p>

        <div class="callout">
          <strong>Operational note:</strong> teams should maintain a triage playbook that defines how events become alerts and alerts become incidents ‚Äî with owners, timelines, and decision gates to avoid slow or inconsistent responses.
        </div>
      </section>

      <section class="card">
        <h2>SIEM deep dive ‚Äî architecture, data, and detection engineering</h2>
        <p>
          SIEMs do more than collect logs. They provide a pipeline: ingest ‚Üí normalize ‚Üí enrich ‚Üí correlate ‚Üí alert ‚Üí investigate. Each stage needs careful design to be effective at scale.
        </p>

        <h3>Ingest: what to collect and why</h3>
        <p class="muted">
          You should collect logs that help answer common IR questions: who did what, where, when, and how. Prioritize identity systems, endpoints, network security devices, cloud audit logs, and critical application logs. Not all logs are equally valuable ‚Äî balance cost with usefulness.
        </p>
        <p>
          <strong>High-value log types:</strong>
          <ul class="list">
            <li>Authentication events (success/failure, MFA challenge)</li>
            <li>Privilege use (sudo, admin actions)</li>
            <li>Process execution and persistence mechanisms (services, scheduled tasks)</li>
            <li>File integrity / creation events for sensitive directories</li>
            <li>DNS queries and unusual external IP contacts</li>
            <li>Network flows for lateral movement detection</li>
          </ul>
        </p>

        <h3>Normalization & enrichment</h3>
        <p class="muted">
          Normalization converts vendor-specific fields into a common schema (e.g., src_ip, dest_ip, username). Enrichment adds business context: asset owner, device type, criticality, recent vulnerability score, geolocation, and threat-intel match. Good enrichment dramatically reduces investigation time.
        </p>

        <h3>Detection engineering</h3>
        <p>
          Detection engineering is the process of turning threat hypotheses into reliable, repeatable detection logic. It blends rules, statistical baselines, and machine learning. Key practices:
          <ul class="list">
            <li>Define clear detection goals (what attacker behavior are you targeting?)</li>
            <li>Create tests using both benign and malicious data (reduce false positives)</li>
            <li>Use threat intelligence to parameterize rules (IOC lists, malicious IPs)</li>
            <li>Continuously measure detection performance (true positive rate, false positive rate)</li>
          </ul>
        </p>

        <h3>Example detection rule (pseudo)</h3>
        <pre>
IF (Multiple failed authentications for same username from different source IPs within 10 mins)
AND (one successful authentication thereafter from an uncommon country)
THEN create alert: "Possible credential stuffing / account takeover"
SCORE: 8/10, OWNER: identity-team
        </pre>

        <div class="small muted">This rule is enriched by user location history, device profiling (known device/unknown device), and MFA status to avoid false positives.</div>
      </section>

      <section class="card">
        <h2>Threat Detection & Response process ‚Äî operational playbook</h2>
        <p>
          A practical TDR program ties monitoring to a response playbook. Below is an operational sequence you can implement in a SOC.
        </p>

        <h3>Operational flow</h3>
        <ol class="list">
          <li><strong>Alert triage:</strong> validate alert, gather context (asset, user, recent changes), assign severity.</li>
          <li><strong>Scope & impact:</strong> determine affected systems, data at risk, and potential lateral movement.</li>
          <li><strong>Containment:</strong> isolate endpoints, block malicious IPs, disable compromised accounts.</li>
          <li><strong>Eradication:</strong> remove malware/backdoors, patch vulnerable services, reset credentials.</li>
          <li><strong>Recovery:</strong> restore from known-good images/backups, reintroduce systems under monitoring.</li>
          <li><strong>Post-incident:</strong> capture lessons, update detections and controls, notify stakeholders and regulators if required.</li>
        </ol>

        <h3>Example playbook snippet ‚Äî ransomware detection</h3>
        <ul class="list">
          <li>Trigger: sudden spike in file encryption rates on file server + process spawning 'vssadmin' or deletion of shadow copies.</li>
          <li>Immediate actions: isolate server network segment, preserve volatile memory for forensics, block C2 domains.</li>
          <li>Communication: notify incident manager, legal, backup team; stop scheduled backups to avoid corrupting backups.</li>
          <li>Remediation: restore files from offline backups after eradication; rotate service accounts.</li>
        </ul>
      </section>

      <section class="card">
        <h2>Incident response (IR) ‚Äî forensic & legal considerations</h2>
        <p>
          IR isn't just technical ‚Äî there are legal, privacy, and evidentiary issues. Collect data in ways that preserve chain of custody if criminal action is possible. Know your local breach notification laws and preserve logs for regulatory inquiries.
        </p>

        <h3>Forensics basics</h3>
        <ul class="list">
          <li>Take images of affected disks when possible and document timestamps.</li>
          <li>Capture volatile data: memory, open network connections, running processes.</li>
          <li>Preserve logs in append-only storage and record who accessed them.</li>
          <li>Limit remediation steps that would overwrite evidence before forensics completes.</li>
        </ul>

        <h3>Legal & compliance</h3>
        <p class="muted">
          In some industries, notification to regulators and affected customers is legally required within a set timeframe. Coordinate with legal teams before public statements and follow documented escalation paths.
        </p>
      </section>

      <section class="card">
        <h2>Threat hunting ‚Äî techniques and example investigations</h2>
        <p>
          Hunting turns assumptions about attacker behavior into queries across telemetry. Common hypotheses: "attackers will try to enumerate active directory groups" or "malware will attempt DNS resolution to non-typical domains".
        </p>

        <h3>Data-driven hunting techniques</h3>
        <ul class="list">
          <li><strong>Blind anomaly detection:</strong> look for deviations from baseline behavior (uncommon processes, unusual outbound connections).</li>
          <li><strong>Indicator pivoting:</strong> use IOC feeds to search historical logs for signs of past compromise.</li>
          <li><strong>Hunt boxes:</strong> prebuilt queries tuned for specific TTPs (e.g., PowerShell abuse, Mimikatz patterns).</li>
          <li><strong>Hunt orchestration:</strong> capture findings into playbooks to convert hunts into detection rules.</li>
        </ul>

        <h3>Example hunt ‚Äî lateral movement via SMB</h3>
        <ol class="list">
          <li>Hypothesis: compromised user is attempting to access multiple file shares using remote execution tools.</li>
          <li>Search logs for authentication events to multiple servers from same user within short timeframe + suspicious process spawn (wmic, psexec).</li>
          <li>If found: escalate to containment (disable user account, disconnect host) and investigate lateral scope.</li>
        </ol>
      </section>

      <section class="card">
        <h2>Managed Detection & Response (MDR) ‚Äî what to expect</h2>
        <p>
          MDR providers deliver people + process + tooling. When contracting MDR, look for SLA specifics, data ownership, playbook alignment, and how they integrate with your identity & change-management processes.
        </p>

        <h3>Key MDR deliverables</h3>
        <ul class="list">
          <li>24/7 monitoring & alerting</li>
          <li>Proactive threat hunting and IOC sharing</li>
          <li>Incident containment guidance or direct containment actions (if delegated)</li>
          <li>Regular reporting, threat posture reviews, and detection tuning</li>
        </ul>

        <div class="small muted">
          Ensure contracts define response boundaries (who can isolate hosts), data retention, and confidentiality of shared telemetry.
        </div>
      </section>

      <section class="card">
        <h2>KPIs & metrics ‚Äî measuring SOC effectiveness</h2>
        <p>
          Metrics help you track progress and justify investment. Useful KPIs include:
        </p>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:10px">
          <div class="card" style="padding:10px;min-width:180px"><strong>MTTD</strong><div class="small muted">Mean Time to Detect</div></div>
          <div class="card" style="padding:10px;min-width:180px"><strong>MTTR</strong><div class="small muted">Mean Time to Respond</div></div>
          <div class="card" style="padding:10px;min-width:180px"><strong>False Positive Rate</strong><div class="small muted">Percent of non-actionable alerts</div></div>
          <div class="card" style="padding:10px;min-width:180px"><strong>Coverage</strong><div class="small muted">Percent Tier-1 assets instrumented</div></div>
        </div>
        <p class="small muted">Aim to reduce MTTD/MTTR and increase coverage over time.</p>
      </section>

      <section class="card">
        <h2>Detection automation & SOAR</h2>
        <p>
          SOAR platforms automate repetitive response steps (isolate host, block IP, enrich alert) and orchestrate multi-tool workflows. Use automation to accelerate routine containment, but gate high-impact actions (like universal account disable) behind human approval.
        </p>

        <h3>Example automated playbook</h3>
        <ol class="list">
          <li>Alert: suspicious process executing from temporary directory.</li>
          <li>Automated enrichment: fetch file hash, reputation, recent parent process.</li>
          <li>If reputation is malicious: automatically quarantine endpoint; create incident ticket; notify analyst.</li>
        </ol>
      </section>

      <section class="card quiz" aria-labelledby="quiz">
        <h2 id="quiz">10-question Quiz ‚Äî Check your understanding</h2>

        <div class="q">
          <strong>1.</strong> What best describes "normalization" in a SIEM?<br>
          <label><input type="radio" name="q1" value="a"> Converting different vendor log formats to a common schema</label><br>
          <label><input type="radio" name="q1" value="b"> Deleting old logs</label><br>
          <label><input type="radio" name="q1" value="c"> Encrypting log storage</label>
        </div>

        <div class="q">
          <strong>2.</strong> Which log source is most critical to detect account takeover attempts?<br>
          <label><input type="radio" name="q2" value="a"> Authentication/Identity logs (AD, cloud IAM)</label><br>
          <label><input type="radio" name="q2" value="b"> Printer logs</label><br>
          <label><input type="radio" name="q2" value="c"> Weather API logs</label>
        </div>

        <div class="q">
          <strong>3.</strong> Which of the following is a good enrichment value to add to alerts?<br>
          <label><input type="radio" name="q3" value="a"> Asset owner and business criticality</label><br>
          <label><input type="radio" name="q3" value="b"> The user's favorite color</label><br>
          <label><input type="radio" name="q3" value="c"> The number of tabs open in the user's browser</label>
        </div>

        <div class="q">
          <strong>4.</strong> What is a reasonable first containment step for a confirmed infected endpoint?<br>
          <label><input type="radio" name="q4" value="a"> Isolate endpoint from network while preserving logs</label><br>
          <label><input type="radio" name="q4" value="b"> Immediately wipe the disk without imaging</label><br>
          <label><input type="radio" name="q4" value="c"> Publicly post the user's name</label>
        </div>

        <div class="q">
          <strong>5.</strong> Threat hunting improves detection by:<br>
          <label><input type="radio" name="q5" value="a"> Creating hypotheses and converting findings into rules</label><br>
          <label><input type="radio" name="q5" value="b"> Turning off the SIEM</label><br>
          <label><input type="radio" name="q5" value="c"> Only running vulnerability scans</label>
        </div>

        <div class="q">
          <strong>6.</strong> Which KPI indicates the speed of your detection program?<br>
          <label><input type="radio" name="q6" value="a"> Mean Time to Detect (MTTD)</label><br>
          <label><input type="radio" name="q6" value="b"> Number of printers installed</label><br>
          <label><input type="radio" name="q6" value="c"> Number of fonts on the server</label>
        </div>

        <div class="q">
          <strong>7.</strong> Why would you gate certain automated SOAR actions behind human approval?<br>
          <label><input type="radio" name="q7" value="a"> To prevent widespread disruption from an automated false positive</label><br>
          <label><input type="radio" name="q7" value="b"> To make the process slower intentionally</label><br>
          <label><input type="radio" name="q7" value="c"> To increase email volume</label>
        </div>

        <div class="q">
          <strong>8.</strong> What does "chain of custody" ensure when collecting forensic evidence?<br>
          <label><input type="radio" name="q8" value="a"> That evidence was handled in a documented, secure way to preserve admissibility</label><br>
          <label><input type="radio" name="q8" value="b"> That the evidence was immediately deleted</label><br>
          <label><input type="radio" name="q8" value="c"> That logs are never collected</label>
        </div>

        <div class="q">
          <strong>9.</strong> MDR contracts should explicitly define:<br>
          <label><input type="radio" name="q9" value="a"> SLAs, data ownership, scope of containment actions</label><br>
          <label><input type="radio" name="q9" value="b"> How many coffee breaks analysts get</label><br>
          <label><input type="radio" name="q9" value="c"> The vendor's logo size</label>
        </div>

        <div class="q">
          <strong>10.</strong> Which is an indicator of potential data exfiltration?<br>
          <label><input type="radio" name="q10" value="a"> Large encrypted uploads to cloud storage from a workstation at off-hours</label><br>
          <label><input type="radio" name="q10" value="b"> Normal inbound web traffic during business hours</label><br>
          <label><input type="radio" name="q10" value="c"> A scheduled system backup to an approved offline device</label>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <button class="btn primary" id="grade">Grade Quiz</button>
          <button class="btn" id="showAnswers">Show Answers & Explanations</button>
        </div>

        <div id="result" class="result" role="region" aria-live="polite"></div>
      </section>

    </article>

    <aside class="sidebar" aria-label="Sidebar">
      <div class="card">
        <h3>Quick Links</h3>
        <ul class="list">
          <li><a href="#quiz">Quiz</a></li>
          <li><a href="#siem">SIEM Deep Dive</a></li>
          <li><a href="#playbook">Playbook</a></li>
        </ul>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Cheat Sheet</h3>
        <div class="small" style="margin-bottom:8px"><strong>Focus:</strong> instrument identity, endpoints, network flows</div>
        <div class="small"><strong>Measure:</strong> MTTD, MTTR, coverage, false positives</div>
      </div>
    </aside>
  </main>

  <!-- Mobile Back button visible on tablet/phone -->
  <a href="cyber-index.html" class="mobile-back-btn" aria-label="Back to lessons (mobile)">
    <span aria-hidden="true">‚óÄ</span><span style="font-weight:700;margin-left:6px">Lessons</span>
  </a>

  <!-- TTS bar -->
  <div id="ttsBar" class="tts-bar" aria-hidden="false" role="region" aria-label="Text to Speech Controls" data-compact="false">
    <button id="ttsCollapse" title="Collapse/Expand TTS">‚â°</button>

    <div class="tts-controls" style="display:flex;gap:8px;align-items:center;flex-wrap:nowrap">
      <button id="ttsPlay" title="Play">‚ñ∂</button>
      <button id="ttsPause" title="Pause">‚è∏</button>
      <button id="ttsStop" title="Stop">‚èπ</button>

      <span class="small">Voice</span>
      <select id="ttsVoices" aria-label="Select voice"></select>

      <span class="small">Rate</span>
      <input id="ttsRate" type="range" min="0.6" max="2" step="0.1" value="1" />

      <span class="small">Pitch</span>
      <input id="ttsPitch" type="range" min="0.6" max="2" step="0.1" value="1" />

      <button id="ttsToggleAuto" class="btn" title="Auto-read on load">A</button>
    </div>
  </div>

<script>
/* -----------------------------
   Theme, Download, Copy Markdown
   ----------------------------- */
(function(){
  const themeBtn = document.getElementById('toggleTheme');
  const themeKey = 'lesson11.theme';
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  function applyTheme(mode){
    if (mode === 'light'){
      document.documentElement.style.setProperty('--bg','#f4f7fb');
      document.documentElement.style.setProperty('--card','#ffffff');
      document.documentElement.style.setProperty('--text','#072033');
      document.documentElement.style.setProperty('--muted','#4a5875');
      document.documentElement.style.setProperty('--accent','#3b82f6');
      document.documentElement.style.setProperty('--accent2','#34d399');
    } else {
      document.documentElement.style.setProperty('--bg','#041028');
      document.documentElement.style.setProperty('--card','#0f2236');
      document.documentElement.style.setProperty('--text','#e9f6ff');
      document.documentElement.style.setProperty('--muted','#9db7d9');
      document.documentElement.style.setProperty('--accent','#57a7ff');
      document.documentElement.style.setProperty('--accent2','#7ef0c8');
    }
  }
  const stored = localStorage.getItem(themeKey);
  const initial = stored || (prefersDark ? 'dark' : 'dark');
  applyTheme(initial);
  if (themeBtn){
    themeBtn.setAttribute('aria-pressed', initial === 'dark' ? 'true' : 'false');
    themeBtn.addEventListener('click', () => {
      const cur = localStorage.getItem(themeKey) || initial;
      const next = cur === 'dark' ? 'light' : 'dark';
      localStorage.setItem(themeKey, next);
      applyTheme(next);
      themeBtn.setAttribute('aria-pressed', next === 'dark' ? 'true' : 'false');
    });
  }

  document.getElementById('downloadNotes').addEventListener('click', () => {
    const nodes = document.querySelectorAll('main article h1, main article h2, main article h3, main article p, main article li, main article pre');
    const lines = [];
    nodes.forEach(n=>{ const txt = n.innerText.trim(); if (txt) lines.push(txt); });
    const blob = new Blob([lines.join('\n\n')], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'Lesson11_ThreatDetection_Notes.txt'; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 700);
  });

  document.getElementById('copyMd').addEventListener('click', async () => {
    const nodes = document.querySelectorAll('main article h1, main article h2, main article h3, main article p, main article li, main article pre');
    let md = '';
    nodes.forEach(n => {
      const tag = n.tagName.toLowerCase(); const txt = n.innerText.trim(); if (!txt) return;
      if (tag === 'h1') md += '# ' + txt + '\n\n';
      else if (tag === 'h2') md += '## ' + txt + '\n\n';
      else if (tag === 'h3') md += '### ' + txt + '\n\n';
      else if (tag === 'li') md += '- ' + txt + '\n';
      else if (tag === 'pre') md += '```\n' + txt + '\n```\n\n';
      else md += txt + '\n\n';
    });
    try { await navigator.clipboard.writeText(md); alert('Copied notes as Markdown.'); }
    catch(e){ alert('Could not copy to clipboard.'); }
  });
})();

/* -----------------------------
   Quiz logic
   ----------------------------- */
(function(){
  const answers = {
    q1: {a:true,b:false,c:false, explain:"Normalization converts heterogeneous logs to a common schema to enable correlation."},
    q2: {a:true,b:false,c:false, explain:"Authentication/identity logs are primary for detecting account takeover."},
    q3: {a:true,b:false,c:false, explain:"Asset owner and criticality help prioritize and route alerts."},
    q4: {a:true,b:false,c:false, explain:"Isolate endpoint while preserving logs to contain and allow forensics."},
    q5: {a:true,b:false,c:false, explain:"Hunting forms hypotheses and converts findings into detection rules."},
    q6: {a:true,b:false,c:false, explain:"MTTD is the primary speed metric for detection."},
    q7: {a:true,b:false,c:false, explain:"Gating prevents automation from causing wide disruption on false positives."},
    q8: {a:true,b:false,c:false, explain:"Chain of custody documents and secures evidence for legal admissibility."},
    q9: {a:true,b:false,c:false, explain:"MDR contracts should clearly define SLAs, data ownership and containment scope."},
    q10:{a:true,b:false,c:false, explain:"Large off-hours encrypted uploads to cloud storage are a common exfil indicator."}
  };

  const gradeBtn = document.getElementById('grade');
  const showBtn = document.getElementById('showAnswers');
  const out = document.getElementById('result');

  gradeBtn.addEventListener('click', () => {
    let score = 0; const parts = [];
    for (let i=1;i<=10;i++){
      const q = 'q'+i; const sel = document.querySelector(`input[name="${q}"]:checked`);
      const user = sel ? sel.value : '(no answer)';
      const isCorrect = sel && answers[q][sel.value] === true;
      if (isCorrect) score++;
      parts.push(`<strong>Q${i}</strong> ‚Äî Your answer: ${user} ‚Äî ${isCorrect?'<span style="color:var(--ok)">Correct</span>':'<span style="color:var(--danger)">Incorrect</span>'}<br><em>Explanation:</em> ${answers[q].explain}`);
    }
    out.innerHTML = `<div><strong>Score:</strong> ${score} / 10</div><div style="margin-top:10px">${parts.join('<hr>')}</div>`;
    out.focus();
    out.scrollIntoView({behavior:'smooth', block:'center'});
    try { localStorage.setItem('lesson11-quiz', JSON.stringify({score, ts:Date.now()})); } catch(e){}
  });

  showBtn.addEventListener('click', () => {
    const lines = [];
    for (let i=1;i<=10;i++){ const q='q'+i; const correct = Object.keys(answers[q]).find(k=>k!=='explain' && answers[q][k]===true); lines.push(`<strong>Q${i}</strong> ‚Äî Correct: ${correct.toUpperCase()} ‚Äî ${answers[q].explain}`); }
    out.innerHTML = lines.join('<hr>');
    out.scrollIntoView({behavior:'smooth', block:'center'});
  });

  (function restore(){ try{ const raw = localStorage.getItem('lesson11-quiz'); if (!raw) return; const obj = JSON.parse(raw); if (obj && obj.score !== undefined) { const prev = document.createElement('div'); prev.className='small muted'; prev.textContent = `Previous Score: ${obj.score}/10`; document.querySelector('.lesson-content').prepend(prev); } } catch(e){} })();
})();

/* -----------------------------
   TTS module ‚Äî compact, highlight, persistence
   ----------------------------- */
(function(){
  const bar = document.getElementById('ttsBar');
  if (!bar) return;
  if (!('speechSynthesis' in window)) { bar.style.display='none'; adjustForTTS(); return; }

  const HOME = 'cyber-index.html';
  const playBtn = document.getElementById('ttsPlay');
  const pauseBtn = document.getElementById('ttsPause');
  const stopBtn = document.getElementById('ttsStop');
  const voicesSelect = document.getElementById('ttsVoices');
  const rateInput = document.getElementById('ttsRate');
  const pitchInput = document.getElementById('ttsPitch');
  const autoBtn = document.getElementById('ttsToggleAuto');
  const collapseBtn = document.getElementById('ttsCollapse');
  const lesson = document.querySelector('.lesson-content') || document.body;

  // inject desktop back button
  (function injectDesktopBack(){
    if (document.querySelector('.desktop-back-btn')) return;
    const btn = document.createElement('button');
    btn.className = 'desktop-back-btn';
    btn.type = 'button';
    btn.title = 'Back to lessons';
    btn.setAttribute('aria-label','Back to lessons');
    btn.innerText = '‚óÄ Lessons';
    Object.assign(btn.style, {
      position: 'fixed', left: '18px', top: '18px', zIndex: 9999, padding: '8px 12px', borderRadius: '10px',
      border: '1px solid rgba(255,255,255,0.06)', background: 'rgba(255,255,255,0.02)', color: 'var(--text)',
      fontWeight: 700, cursor: 'pointer', backdropFilter: 'blur(6px)'
    });
    document.body.appendChild(btn);
    function update(){ btn.style.display = window.innerWidth <= 980 ? 'none' : 'inline-flex'; }
    update(); window.addEventListener('resize', update);
    btn.addEventListener('click', ()=> { window.location.href = HOME; });
  })();

  const KEYS = { prefix:'lesson11', auto: 'lesson11.auto', voice:'lesson11.voice', rate:'lesson11.rate', pitch:'lesson11.pitch', compact:'lesson11.compact', resume:'lesson11.resume' };

  const S = { voices: [], sentences: [], idx: parseInt(localStorage.getItem(KEYS.resume) || '0',10) || 0, utterance: null, auto: localStorage.getItem(KEYS.auto) === 'true', compact: (localStorage.getItem(KEYS.compact) === 'true') || window.matchMedia('(max-width:820px)').matches, muted:false };

  function loadVoices(){
    return new Promise((resolve) => {
      let v = speechSynthesis.getVoices();
      if (v.length) { S.voices = v; resolve(v); return; }
      speechSynthesis.onvoiceschanged = () => { v = speechSynthesis.getVoices(); S.voices = v; resolve(v); };
      setTimeout(()=> { v = speechSynthesis.getVoices(); S.voices = v; resolve(v); }, 1200);
    });
  }

  async function populateVoices(){
    const voices = await loadVoices();
    if (!voicesSelect) return;
    voicesSelect.innerHTML = '';
    voices.forEach(v => {
      const opt = document.createElement('option'); opt.value = v.voiceURI || v.name; opt.textContent = `${v.name} (${v.lang})${v.default ? ' ‚Äî default' : ''}`; voicesSelect.appendChild(opt);
    });
    const stored = localStorage.getItem(KEYS.voice);
    if (stored) voicesSelect.value = stored;
  }
  populateVoices();

  function buildSentences(){
    const nodes = lesson.querySelectorAll('h1,h2,h3,p,li,pre');
    const arr = [];
    nodes.forEach(n => {
      const txt = n.innerText.trim();
      if (!txt) return;
      const parts = txt.split(/(?<=[.?!:])\s+/);
      parts.forEach(p => { if (p && p.trim()) arr.push({ text: p.trim(), node: n }); });
    });
    S.sentences = arr;
  }

  function clearMarks(){
    const marks = lesson.querySelectorAll('mark.tts-mark');
    marks.forEach(m => {
      const parent = m.parentNode;
      while (m.firstChild) parent.insertBefore(m.firstChild, m);
      parent.removeChild(m);
      parent.normalize();
    });
  }
  function markSentence(node, sentence){
    if (!node) return false;
    const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null, false);
    let n;
    while (n = walker.nextNode()){
      const idx = n.nodeValue.indexOf(sentence);
      if (idx >= 0){
        const range = document.createRange(); range.setStart(n, idx); range.setEnd(n, idx + sentence.length);
        const mark = document.createElement('mark'); mark.className = 'tts-mark';
        try { range.surroundContents(mark); mark.scrollIntoView({behavior:'smooth', block:'center'}); } catch(e){}
        return true;
      }
    }
    return false;
  }

  function pickVoice(val){
    return S.voices.find(v => (v.voiceURI && v.voiceURI === val) || v.name === val) || S.voices.find(v => v.default) || S.voices[0];
  }

  function speakObj(obj){
    if (!obj || !obj.text) { S.idx++; return; }
    if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(obj.text);
    const voiceVal = (voicesSelect && voicesSelect.value) || localStorage.getItem(KEYS.voice) || '';
    const selected = pickVoice(voiceVal);
    if (selected) u.voice = selected;
    u.rate = rateInput ? parseFloat(rateInput.value) : 1;
    u.pitch = pitchInput ? parseFloat(pitchInput.value) : 1;
    u.onstart = () => { clearMarks(); if (!markSentence(obj.node, obj.text)) markSentence(document.body, obj.text); };
    u.onend = () => { S.idx++; localStorage.setItem(KEYS.resume, String(S.idx)); if (S.idx < S.sentences.length) setTimeout(()=> speakObj(S.sentences[S.idx]), 110); else { S.idx = 0; localStorage.setItem(KEYS.resume,'0'); clearMarks(); } };
    S.utterance = u;
    speechSynthesis.speak(u);
  }

  function play(i){
    if (!S.sentences.length) buildSentences();
    if (typeof i === 'number') S.idx = i;
    if (S.idx >= S.sentences.length) S.idx = 0;
    if (speechSynthesis.paused) return speechSynthesis.resume();
    speakObj(S.sentences[S.idx]);
  }
  function pauseToggle(){ if (speechSynthesis.speaking && !speechSynthesis.paused) speechSynthesis.pause(); else if (speechSynthesis.paused) speechSynthesis.resume(); }
  function stop(){ if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel(); S.idx = 0; localStorage.setItem(KEYS.resume,'0'); clearMarks(); }
  function speakText(text){ if (!text || !text.trim()) return; if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); const voiceVal = (voicesSelect && voicesSelect.value) || localStorage.getItem(KEYS.voice) || ''; const selected = pickVoice(voiceVal); if (selected) u.voice = selected; u.rate = rateInput ? parseFloat(rateInput.value) : 1; u.pitch = pitchInput ? parseFloat(pitchInput.value) : 1; speechSynthesis.speak(u); }

  function setCompact(flag){ if (!bar) return; bar.setAttribute('data-compact', flag ? 'true' : 'false'); localStorage.setItem(KEYS.compact, flag ? 'true' : 'false'); }
  function applySaved(){ const r = localStorage.getItem(KEYS.rate); const p = localStorage.getItem(KEYS.pitch); const v = localStorage.getItem(KEYS.voice); if (r && rateInput) rateInput.value = r; if (p && pitchInput) pitchInput.value = p; if (v && voicesSelect) setTimeout(()=>{ try{ voicesSelect.value = v; }catch(e){} }, 800); }

  playBtn && playBtn.addEventListener('click', ()=> { play(0); localStorage.setItem(KEYS.voice, voicesSelect.value || ''); localStorage.setItem(KEYS.rate, rateInput.value); localStorage.setItem(KEYS.pitch, pitchInput.value); });
  pauseBtn && pauseBtn.addEventListener('click', pauseToggle);
  stopBtn && stopBtn.addEventListener('click', stop);
  voicesSelect && voicesSelect.addEventListener('change', ()=> localStorage.setItem(KEYS.voice, voicesSelect.value));
  rateInput && rateInput.addEventListener('input', ()=> localStorage.setItem(KEYS.rate, rateInput.value));
  pitchInput && pitchInput.addEventListener('input', ()=> localStorage.setItem(KEYS.pitch, pitchInput.value));
  if (autoBtn){ autoBtn.style.opacity = S.auto ? '1' : '0.6'; autoBtn.addEventListener('click', ()=> { S.auto = !S.auto; localStorage.setItem(KEYS.auto, S.auto ? 'true' : 'false'); autoBtn.style.opacity = S.auto ? '1' : '0.6'; if (S.auto) play(S.idx || 0); }); }
  if (collapseBtn) collapseBtn.addEventListener('click', ()=> { const cur = bar.getAttribute('data-compact') === 'true'; setCompact(!cur); });

  (function init(){
    populateVoices();
    buildSentences();
    setCompact(S.compact);
    applySaved();
    if (S.auto) setTimeout(()=>{ try{ play(S.idx); } catch(e){} }, 700);
  })();

  function handleResize(){
    const narrow = window.matchMedia('(max-width:420px)').matches;
    const userSet = localStorage.getItem(KEYS.compact);
    if (userSet === null){
      if (narrow) setCompact(true); else setCompact(false);
    }
    const desktopBtn = document.querySelector('.desktop-back-btn');
    if (desktopBtn) desktopBtn.style.display = window.innerWidth <= 980 ? 'none' : 'inline-flex';
  }
  window.addEventListener('resize', handleResize);
  handleResize();

  // keyboard shortcuts
  window.addEventListener('keydown', (e) => {
    const tag = (e.target && e.target.tagName || '').toLowerCase();
    if (tag === 'input' || tag === 'textarea' || e.target.isContentEditable) return;
    if (e.code === 'Space') { e.preventDefault(); if (speechSynthesis.speaking && !speechSynthesis.paused) pauseToggle(); else if (speechSynthesis.paused) pauseToggle(); else play(S.idx || 0); }
    else if (e.key === 's' || e.key === 'S') stop();
    else if (e.key === 'b' || e.key === 'B') window.location.href = HOME;
    else if (e.key === '+' || e.key === '=') { if (rateInput) { rateInput.value = Math.min(parseFloat(rateInput.value) + 0.1, parseFloat(rateInput.max)); localStorage.setItem(KEYS.rate, rateInput.value); } }
    else if (e.key === '-') { if (rateInput) { rateInput.value = Math.max(parseFloat(rateInput.value) - 0.1, parseFloat(rateInput.min)); localStorage.setItem(KEYS.rate, rateInput.value); } }
    else if (e.key === 'r' || e.key === 'R') { const sel = window.getSelection().toString().trim(); if (sel) speakText(sel); }
    else if (e.key === 'a' || e.key === 'A') { S.auto = !S.auto; localStorage.setItem(KEYS.auto, S.auto ? 'true' : 'false'); if (S.auto) play(S.idx); }
  });

  // double-tap to toggle play/pause on mobile
  (function doubleTap(){
    let last = 0;
    document.addEventListener('touchend', (ev) => {
      const now = Date.now();
      if (now - last < 350) {
        if (speechSynthesis.speaking && !speechSynthesis.paused) pauseToggle();
        else play(S.idx || 0);
        last = 0;
        return;
      }
      last = now;
    }, { passive: true });
  })();

  // voices loading fallback
  let tries = 0;
  const iv = setInterval(()=> {
    if (speechSynthesis.getVoices().length) { populateVoices(); applySaved(); clearInterval(iv); adjustForTTS(); }
    else if (++tries > 30) { applySaved(); clearInterval(iv); adjustForTTS(); }
  }, 200);

  // observe bar size
  const ro = new ResizeObserver(entries => adjustForTTS());
  ro.observe(bar);

  if (!localStorage.getItem('lesson11.tts.hint')) { setTimeout(()=> console.info('TTS shortcuts: Space play/pause ‚Ä¢ S stop ‚Ä¢ B back ‚Ä¢ +/- speed ‚Ä¢ R read selection ‚Ä¢ A toggle auto'), 1000); localStorage.setItem('lesson11.tts.hint','1'); }
})();

/* adjust for TTS bar so anchors not covered */
function adjustForTTS(){
  const bar = document.getElementById('ttsBar');
  if (!bar) return;
  const rect = bar.getBoundingClientRect();
  const cs = window.getComputedStyle(bar);
  const h = Math.ceil(rect.height + parseFloat(cs.marginTop||0) + parseFloat(cs.marginBottom||0));
  document.documentElement.style.setProperty('--tts-height', h + 'px');
  document.querySelectorAll('.container').forEach(c => c.style.paddingBottom = (28 + h) + 'px');
}
window.addEventListener('load', ()=> { setTimeout(adjustForTTS, 300); setTimeout(adjustForTTS, 900); });
window.addEventListener('resize', ()=> { setTimeout(adjustForTTS, 120); });

/* safety reminder */
console.warn('SAFETY: Use these exercises in authorized environments only. Respect laws, privacy, and policies.');
</script>
</body>
</html>
