<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOC Training Module: Threat Hunting</title>
  <meta name="description" content="SOC Training Module ‚Äî Threat Hunting: frameworks, IOC vs IOA, baselining, hunting process, hunt notebook and metrics." />
  <!-- Bootstrap CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#8aa0c3;
      --text:#e7eefc;
      --accent:#6ea8ff;
      --accent-2:#7ef0c1;
      --warn:#ffdf6e;
      --danger:#ff7e93;
      --glass: rgba(255,255,255,0.04);
    }

    /* Reset & layout */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Noto Sans",Helvetica,Arial}
    body{
      background: linear-gradient(135deg,var(--bg) 0%, #0f2034 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      padding-bottom:120px; /* space for TTS */
    }
    .container-xl { max-width: 1100px; }

    /* Header */
    header{position:sticky;top:0;z-index:1020;backdrop-filter:saturate(160%) blur(8px);background:rgba(11,18,32,0.75);border-bottom:1px solid rgba(255,255,255,0.04)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:0.8rem 1rem}
    .badge-lesson{display:inline-flex;align-items:center;gap:.5rem;font-weight:700;color:#081024;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:.4rem .75rem;border-radius:999px;font-size:.75rem;text-transform:uppercase}

    /* Hero + cards */
    .hero{padding:1.75rem 1rem}
    .title{font-size:clamp(22px,3.6vw,36px);line-height:1.08;margin:0}
    .subtitle{color:var(--muted);font-size:0.95rem}
    .chips{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.8rem}
    .chip{padding:.35rem .6rem;background:var(--glass);border-radius:999px;font-size:.8rem;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}

    .card-lesson{background:radial-gradient(140% 120% at 100% 0%,#132349 0%,var(--card) 45%);border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:1.1rem;margin-top:1rem;box-shadow:0 12px 36px rgba(0,0,0,0.32)}
    .long-read{line-height:1.6;font-size:0.96rem}
    .list{padding-left:1.25rem}
    .small-muted{font-size:.88rem;color:var(--muted)}
    .explain{margin-top:.8rem;background:rgba(0,0,0,0.12);padding:.8rem;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    pre{white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:.8rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);overflow:auto}
    footer{opacity:.85;font-size:.9rem;padding:24px 0 48px;color:var(--muted)}

    /* Buttons */
    .btn-ghost{background:rgba(255,255,255,0.03);color:var(--text);border:1px solid rgba(255,255,255,0.06);font-weight:700}
    .btn-primary-lesson{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#081024;border:none;font-weight:700}

    /* TTS bar (responsive + compact support) */
    .tts-bar{
      position:fixed;
      right:18px;
      bottom:18px;
      z-index:9999;
      background:rgba(0,0,0,0.78);
      color:#00ffcc;
      padding:10px 12px;
      border-radius:12px;
      box-shadow:0 10px 32px rgba(0,0,0,0.5);
      font-family:'Share Tech Mono',monospace;
      display:flex;
      gap:8px;
      align-items:center;
      backdrop-filter: blur(6px);
      min-width:300px;
      transition:all .16s ease;
    }
    .tts-bar button{background:linear-gradient(45deg,#ff0080,#7928ca);border:none;color:#fff;padding:6px 10px;border-radius:8px;font-weight:700;cursor:pointer}
    .tts-bar select,.tts-bar input[type="range"]{background:rgba(255,255,255,0.06);color:#00ffcc;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:8px;font-family:inherit}
    .tts-highlight{background:rgba(0,255,200,0.12);padding:0 2px;border-radius:3px;transition:background .12s ease}
    @media (max-width:600px){.tts-bar{left:50%;transform:translateX(-50%);right:auto;bottom:12px;min-width:92%}}

    /* mobile back button */
    .mobile-back-btn{display:none}
    @media (max-width:1024px){
      .mobile-back-btn{display:inline-flex;align-items:center;gap:.5rem;position:fixed;left:16px;bottom:calc(14px + env(safe-area-inset-bottom));z-index:9998;padding:.6rem .9rem;border-radius:999px;background:rgba(255,255,255,0.98);color:#081024;font-weight:700;box-shadow:0 8px 28px rgba(2,6,23,0.36);border:1px solid rgba(0,0,0,0.06);backdrop-filter: blur(6px)}
      .mobile-back-icon{font-size:16px}
      .mobile-back-text{font-size:14px}
    }

    /* compact TTS */
    .tts-bar[data-compact="true"]{min-width:58px;max-width:58px;padding:6px;border-radius:999px;gap:0}
    .tts-bar[data-compact="true"] .tts-controls{display:none}
    .tts-bar #ttsCollapse{border-radius:999px;padding:8px;width:38px;height:38px}
    .tts-bar:focus-within{outline:3px solid rgba(21,156,228,0.12);outline-offset:2px}

    /* highlight style for reading */
    .tts-highlight{outline:2px dashed rgba(0,255,200,0.12);border-radius:4px}

    /* small screens tweaks */
    @media (max-width:420px){ .container-xl{padding-left:12px;padding-right:12px} .title{font-size:20px} }

    /* small helper */
    .muted { color: var(--muted); font-size:.92rem }
  </style>
</head>
<body>
  <header>
    <div class="header-row container-xl">
      <div class="d-flex align-items-center">
        <div class="badge-lesson me-3">HUNT</div>
        <div>
          <div style="font-weight:800">SOC Training Module</div>
          <div class="small-muted">Threat Hunting ‚Ä¢ IOC / IOA ‚Ä¢ MITRE ATT&CK ‚Ä¢ Hunt Notebook</div>
        </div>
      </div>
      <div>
        <button id="toggleTheme" class="btn btn-ghost">üåó Theme</button>
      </div>
    </div>
  </header>

  <main class="container-xl mt-3">
    <article class="card-lesson">
      <div class="hero">
        <h1 class="title">SOC Training Module: Threat Hunting</h1>
        <p class="subtitle">Proactive hunting techniques, frameworks, baselining, and a practical hunt notebook structure for SOC analysts.</p>
        <div class="chips mt-2">
          <span class="chip">Threat Hunting</span>
          <span class="chip">MITRE ATT&CK</span>
          <span class="chip">IOA</span>
          <span class="chip">IOC</span>
          <span class="chip">Hunt Notebook</span>
        </div>
      </div>

      <!-- Table of contents -->
      <section class="card-lesson mt-3">
        <h4 class="mb-2">Table of Contents</h4>
        <ol class="list-unstyled ms-3">
          <li>1. What is Threat Hunting?</li>
          <li>2. Why Threat Hunting is Important</li>
          <li>3. Key Terminology</li>
          <li>4. IOC vs IOA (Clear Differences)</li>
          <li>5. Threat Hunting Frameworks</li>
          <li>6. Baselining (Normal vs Abnormal)</li>
          <li>7. Threat Intelligence in Hunting</li>
          <li>8. Key Hunt Focus Areas</li>
          <li>9. Threat Hunting Process</li>
          <li>10. Hunt Notebook / Report Structure</li>
          <li>11. Metrics to Evaluate Hunt Effectiveness</li>
        </ol>
      </section>

      <!-- 1 -->
      <section id="what" class="card-lesson long-read mt-3">
        <h3>1. What is Threat Hunting?</h3>
        <p>Threat Hunting is a proactive cybersecurity practice where SOC analysts intentionally search through systems, logs, endpoints, cloud platforms, and networks to find hidden or unknown threats that have bypassed automated security tools.</p>
        <div class="explain">
          <p class="muted"><strong>Instead of waiting for alerts:</strong></p>
          <ul class="list">
            <li>Threat Hunting assumes the environment may already be compromised, and the analyst actively searches for signs of adversary activity.</li>
            <li>Focus: behavior patterns, anomalies, attacker techniques (TTPs) ‚Äî not only known signatures or alerts.</li>
          </ul>
        </div>
      </section>

      <!-- 2 -->
      <section id="why" class="card-lesson long-read mt-3">
        <h3>2. Why Threat Hunting is Important</h3>
        <p>Modern attackers use techniques that do not trigger traditional alerts, such as:</p>
        <ul class="list">
          <li>Fileless malware executed in memory</li>
          <li>Use of legitimate admin tools (PowerShell, WMI, RDP)</li>
          <li>Credential theft instead of malware</li>
          <li>Living-off-the-land techniques</li>
        </ul>
        <div class="explain">
          <p class="small-muted"><strong>Key Goal:</strong> Reduce attacker dwell time ‚Äî the time between when an attacker enters your environment and when they are detected. The longer the dwell time, the more damage is done.</p>
        </div>
      </section>

      <!-- 3 -->
      <section id="terms" class="card-lesson long-read mt-3">
        <h3>3. Key Terminology in Threat Hunting</h3>
        <div class="table-responsive">
          <table class="table table-borderless text-start">
            <thead>
              <tr class="muted"><th>Term</th><th>Meaning</th></tr>
            </thead>
            <tbody>
              <tr><td><strong>TTPs</strong></td><td>Tactics, Techniques, and Procedures used by attackers.</td></tr>
              <tr><td><strong>IOC</strong></td><td>Indicator of Compromise ‚Äî evidence that a system is already breached.</td></tr>
              <tr><td><strong>IOA</strong></td><td>Indicator of Attack ‚Äî behaviors that suggest an attack is in progress.</td></tr>
              <tr><td><strong>Hypothesis</strong></td><td>A testable assumption that guides the hunt.</td></tr>
              <tr><td><strong>Baseline</strong></td><td>Understanding what ‚Äúnormal‚Äù activity looks like in your environment.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 4 -->
      <section id="iocvsioa" class="card-lesson long-read mt-3">
        <h3>4. IOC vs IOA (Clear Differences)</h3>
        <h5>Indicators of Compromise (IOCs)</h5>
        <ul class="list">
          <li>Malicious file hashes</li>
          <li>Known attacker IP addresses or domains</li>
          <li>Malware filenames</li>
          <li>Suspicious registry entries</li>
          <li>Compromised account credentials</li>
        </ul>

        <h5>Indicators of Attack (IOAs)</h5>
        <ul class="list">
          <li>Unusual process accessing sensitive memory (e.g., LSASS credential dumping)</li>
          <li>Lateral movement between internal hosts not normally connected</li>
          <li>Persistence mechanisms such as new scheduled tasks or startup entries</li>
          <li>Repetitive, timed network communications ("beaconing")</li>
        </ul>

        <div class="explain">
          <p class="small-muted">IOCs are useful after a breach; IOAs are early warnings detecting attacker technique rather than tool signatures.</p>
        </div>
      </section>

      <!-- 5 -->
      <section id="frameworks" class="card-lesson long-read mt-3">
        <h3>5. Threat Hunting Frameworks</h3>
        <h5>MITRE ATT&CK</h5>
        <p>Categories (examples): Reconnaissance, Initial Access, Execution, Persistence, Privilege Escalation, Defense Evasion, Credential Access, Lateral Movement, Command & Control, Exfiltration.</p>
        <h5>Cyber Kill Chain</h5>
        <p>Hunting is most effective in the middle stages: Privilege Escalation, Credential Access, Lateral Movement, Persistence. Stopping attacks here prevents full breach impact.</p>
      </section>

      <!-- 6 -->
      <section id="baselining" class="card-lesson long-read mt-3">
        <h3>6. Understanding Normal vs Abnormal Behavior (Baselining)</h3>
        <div class="table-responsive">
          <table class="table">
            <thead><tr class="muted"><th>Activity</th><th>Normal Behavior</th><th>Suspicious Behavior</th></tr></thead>
            <tbody>
              <tr><td>Logins</td><td>Same devices & times each day</td><td>Unusual time, location, or device</td></tr>
              <tr><td>Processes</td><td>IT tools used by admins</td><td>Admin tools run by non-admin users</td></tr>
              <tr><td>Network Traffic</td><td>Business SaaS & internal apps</td><td>Traffic to unknown foreign servers</td></tr>
              <tr><td>System Changes</td><td>Controlled updates & packages</td><td>New scheduled tasks or registry changes</td></tr>
            </tbody>
          </table>
        </div>
        <p class="small-muted">Baselines help differentiate mistakes from attacks.</p>
      </section>

      <!-- 7 -->
      <section id="intel" class="card-lesson long-read mt-3">
        <h3>7. Threat Intelligence in Hunting</h3>
        <ul class="list">
          <li>VirusTotal (file & domain reputation)</li>
          <li>GreyNoise (classifies scanning/internet noise)</li>
          <li>OTX / MISP (threat sharing communities)</li>
          <li>AbuseIPDB (malicious IP tracking)</li>
        </ul>
        <p class="small-muted">Threat intel helps validate suspicion, prioritize events and speed investigations.</p>
      </section>

      <!-- 8 -->
      <section id="focus" class="card-lesson long-read mt-3">
        <h3>8. Key Hunt Focus Areas</h3>
        <ul class="list">
          <li><strong>Credential Access & Credential Dumping</strong> ‚Äî detect attempts to steal Windows passwords from memory (e.g., LSASS).</li>
          <li><strong>Lateral Movement</strong> ‚Äî identify when attackers move from one system to another (RDP, SMB anomalies).</li>
          <li><strong>Persistence Mechanisms</strong> ‚Äî new scheduled tasks, modified autorun keys or new services.</li>
          <li><strong>Command & Control (C2)</strong> ‚Äî repetitive timed beaconing to unusual IPs or infrastructures.</li>
        </ul>
      </section>

      <!-- 9 -->
      <section id="process" class="card-lesson long-read mt-3">
        <h3>9. Threat Hunting Process</h3>
        <ol class="list">
          <li><strong>Form a Hypothesis</strong> ‚Äî e.g. "If credentials were stolen, attacker may move laterally."</li>
          <li><strong>Identify Relevant Data Sources</strong> ‚Äî system logs, network logs, endpoint telemetry.</li>
          <li><strong>Analyze Behavior Patterns</strong> ‚Äî look for anomalies or suspicious chains of events.</li>
          <li><strong>Investigate and Validate</strong> ‚Äî confirm malicious vs benign.</li>
          <li><strong>Document and Report Findings</strong> ‚Äî a structured hunt report for repeatability.</li>
        </ol>
      </section>

      <!-- 10 -->
      <section id="notebook" class="card-lesson long-read mt-3">
        <h3>10. Hunt Notebook / Report Structure</h3>
        <pre>
HUNT NAME:
HYPOTHESIS:
ENVIRONMENT / SYSTEMS REVIEWED:
BEHAVIORAL FINDINGS:
ATT&CK TECHNIQUES OBSERVED:
IMPACT / RISK LEVEL:
RECOMMENDED ACTIONS:
FINAL OUTCOME (Confirmed / Benign / Needs Monitoring):
        </pre>
        <p class="small-muted">Use the notebook to make hunts repeatable and measurable.</p>
      </section>

      <!-- 11 -->
      <section id="metrics" class="card-lesson long-read mt-3">
        <h3>11. Metrics to Evaluate Hunt Effectiveness</h3>
        <table class="table">
          <thead><tr class="muted"><th>Metric</th><th>What It Measures</th></tr></thead>
          <tbody>
            <tr><td>Mean Time to Detect (MTTD)</td><td>How fast threats are discovered</td></tr>
            <tr><td>Mean Time to Investigate (MTTI)</td><td>How fast analysts determine malicious vs benign</td></tr>
            <tr><td>True Positive Rate</td><td>Quality of hunts and detections</td></tr>
            <tr><td>Coverage</td><td>How much of the environment is actively hunted</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Download / copy -->
      <section class="card-lesson mt-3 d-flex align-items-center gap-3">
        <div>
          <button id="downloadNotes" class="btn btn-primary-lesson">üì• Download Notes (Text)</button>
          <button id="copyMarkdown" class="btn btn-ghost">üìã Copy Markdown</button>
        </div>
        <div class="ms-auto muted">Use these controls to export lesson notes for your LMS or offline review.</div>
      </section>

      <footer class="mt-3">
        <div class="text-center muted">¬© Learning Playground ‚Äî SOC Training Module: Threat Hunting</div>
      </footer>
    </article>
  </main>

  <!-- Mobile Back button -->
  <a href="cyber-index.html" class="mobile-back-btn" aria-label="Back to lessons (mobile)">
    <span class="mobile-back-icon">‚óÄ</span>
    <span class="mobile-back-text">Lessons</span>
  </a>

  <!-- TTS Bar -->
  <div id="ttsBar" class="tts-bar" aria-hidden="false" data-compact="false" role="region" aria-label="Text to Speech Controls">
    <button id="ttsCollapse" title="Collapse/Expand TTS">‚â°</button>

    <div class="tts-controls d-flex align-items-center" aria-hidden="false" style="gap:.5rem;">
      <button id="ttsPlay" title="Play">‚ñ∂</button>
      <button id="ttsPause" title="Pause">‚è∏</button>
      <button id="ttsStop" title="Stop">‚èπ</button>

      <div style="display:flex;align-items:center;gap:.35rem">
        <label class="muted" for="ttsVoices" style="margin:0 6px 0 8px">Voice</label>
        <select id="ttsVoices" aria-label="Select voice" style="min-width:180px"></select>
      </div>

      <div style="display:flex;align-items:center;gap:.35rem">
        <label class="muted" for="ttsRate" style="margin:0 6px 0 8px">Rate</label>
        <input id="ttsRate" type="range" min="0.6" max="2" step="0.1" value="1" />
      </div>

      <div style="display:flex;align-items:center;gap:.35rem">
        <label class="muted" for="ttsPitch" style="margin:0 6px 0 8px">Pitch</label>
        <input id="ttsPitch" type="range" min="0.6" max="2" step="0.1" value="1" />
      </div>

      <button id="ttsToggleAuto" class="btn btn-ghost" title="Auto-read on load">A</button>
    </div>
  </div>

  <!-- Bootstrap + JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* Theme toggle (simple CSS variable swap) */
    (function () {
      const themeBtn = document.getElementById('toggleTheme');
      const keyTheme = 'soc-theme';
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      function applyTheme(mode) {
        if (mode === 'light') {
          document.documentElement.style.setProperty('--bg','#f7f9ff');
          document.documentElement.style.setProperty('--card','#ffffff');
          document.documentElement.style.setProperty('--text','#081024');
          document.documentElement.style.setProperty('--muted','#4a5875');
          document.body.style.background = 'linear-gradient(135deg,#f7fbff 0%, #e6eef9 100%)';
        } else {
          document.documentElement.style.setProperty('--bg','#0b1220');
          document.documentElement.style.setProperty('--card','#111a2e');
          document.documentElement.style.setProperty('--text','#e7eefc');
          document.documentElement.style.setProperty('--muted','#8aa0c3');
          document.body.style.background = 'linear-gradient(135deg,var(--bg) 0%, #0f2034 100%)';
        }
      }
      const stored = localStorage.getItem(keyTheme) || (prefersDark ? 'dark' : 'light');
      applyTheme(stored);
      themeBtn.addEventListener('click', () => {
        const cur = localStorage.getItem(keyTheme) || stored;
        const next = cur === 'dark' ? 'light' : 'dark';
        localStorage.setItem(keyTheme, next);
        applyTheme(next);
      });
    })();

    /* Download notes */
    document.getElementById('downloadNotes').addEventListener('click', () => {
      const title = 'ThreatHunting_Notes.txt';
      const nodes = document.querySelectorAll('article .card-lesson h3, article .card-lesson h4, article .card-lesson p, article .card-lesson li, article .card-lesson pre');
      const lines = [];
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h3' || tag === 'h4') lines.push('\\n' + n.innerText + '\\n');
        else lines.push(n.innerText);
      });
      const content = lines.join('\\n');
      const blob = new Blob([content], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = title; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 600);
    });

    /* Copy Markdown */
    document.getElementById('copyMarkdown').addEventListener('click', async () => {
      const nodes = document.querySelectorAll('article .card-lesson h1, article .card-lesson h3, article .card-lesson h4, article .card-lesson p, article .card-lesson li, article .card-lesson pre');
      let md = '';
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h1') md += `# ${n.innerText}\\n\\n`;
        else if (tag === 'h3') md += `## ${n.innerText}\\n\\n`;
        else if (tag === 'h4') md += `### ${n.innerText}\\n\\n`;
        else if (tag === 'li') md += `- ${n.innerText}\\n`;
        else if (tag === 'pre') md += '```\\n' + n.innerText + '\\n```\\n\\n';
        else md += `${n.innerText}\\n\\n`;
      });
      try { await navigator.clipboard.writeText(md); alert('Copied lesson content as Markdown to clipboard.'); }
      catch(e){ alert('Could not copy to clipboard.'); }
    });

    /* Enhanced TTS (voice selection, play/pause/stop, read-on-scroll, highlight) */
    (function () {
      const HOME = 'cyber-index.html';
      const STORAGE_PREFIX = 'soc_threat_tts';
      const AUTO_KEY = STORAGE_PREFIX + '.auto';
      const COMPACT_KEY = STORAGE_PREFIX + '.compact';
      const RESUME_KEY = STORAGE_PREFIX + '.index';
      const HINT_KEY = STORAGE_PREFIX + '.hint';
      const MOBILE_BREAK = 820;

      const ttsBar = document.getElementById('ttsBar');
      const playBtn = document.getElementById('ttsPlay');
      const pauseBtn = document.getElementById('ttsPause');
      const stopBtn = document.getElementById('ttsStop');
      const voicesSelect = document.getElementById('ttsVoices');
      const rateInput = document.getElementById('ttsRate');
      const pitchInput = document.getElementById('ttsPitch');
      const autoBtn = document.getElementById('ttsToggleAuto');
      const collapseBtn = document.getElementById('ttsCollapse');
      const lesson = document.querySelector('main') || document.body;

      if (!('speechSynthesis' in window)) {
        console.warn('TTS not available; hiding TTS bar.');
        if (ttsBar) ttsBar.style.display = 'none';
        return;
      }

      /* inject desktop back button (non-invasive) */
      (function injectDesktopBack(){
        if (document.querySelector('.desktop-back-btn')) return;
        const btn = document.createElement('button');
        btn.className = 'desktop-back-btn btn btn-ghost';
        btn.title = 'Back to lessons';
        btn.setAttribute('aria-label','Back to lessons');
        btn.innerText = '‚óÄ Lessons';
        Object.assign(btn.style, {
          position: 'fixed',
          left: '18px',
          top: '18px',
          zIndex: 9999,
          padding: '8px 12px',
          borderRadius: '10px',
          border: '1px solid rgba(255,255,255,0.06)',
          background: 'rgba(255,255,255,0.02)',
          color: 'var(--text)',
          fontWeight: 700,
          cursor: 'pointer',
          backdropFilter: 'blur(6px)'
        });
        document.body.appendChild(btn);
        function update() { btn.style.display = window.innerWidth <= MOBILE_BREAK ? 'none' : 'inline-flex'; }
        update();
        window.addEventListener('resize', update);
        btn.addEventListener('click', () => { window.location.href = HOME; });
      })();

      const S = {
        voices: [],
        sentences: [],
        idx: parseInt(localStorage.getItem(RESUME_KEY) || '0', 10) || 0,
        utterance: null,
        auto: localStorage.getItem(AUTO_KEY) === 'true',
        compact: (localStorage.getItem(COMPACT_KEY) === 'true') || (window.matchMedia('(max-width:820px)').matches),
        readingOnScroll: false,
        muted: false
      };

      /* load voices */
      function loadVoices() {
        return new Promise((resolve) => {
          let v = speechSynthesis.getVoices();
          if (v.length) { S.voices = v; resolve(v); return; }
          speechSynthesis.onvoiceschanged = () => { v = speechSynthesis.getVoices(); S.voices = v; resolve(v); };
          setTimeout(() => { v = speechSynthesis.getVoices(); S.voices = v; resolve(v); }, 1200);
        });
      }
      async function populateVoices() {
        const voices = await loadVoices();
        if (!voicesSelect) return;
        voicesSelect.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.voiceURI || v.name;
          opt.textContent = `${v.name} (${v.lang})${v.default ? ' ‚Äî default' : ''}`;
          voicesSelect.appendChild(opt);
        });
        const stored = localStorage.getItem(STORAGE_PREFIX + '.voice');
        if (stored) voicesSelect.value = stored;
      }
      populateVoices();

      /* build sentence objects pointing to nodes */
      function buildSentences() {
        const nodes = lesson.querySelectorAll('h1,h2,h3,h4,p,li,pre');
        const arr = [];
        nodes.forEach(n => {
          const txt = n.innerText.trim();
          if (!txt) return;
          // split into sentences for smoother playback
          const parts = txt.split(/(?<=[.?!])\s+/);
          parts.forEach(p => { if (p && p.trim()) arr.push({ text: p.trim(), node: n }); });
        });
        S.sentences = arr;
      }

      /* highlighting helpers */
      function clearHighlights() {
        const els = lesson.querySelectorAll('.tts-highlight');
        els.forEach(el => el.classList.remove('tts-highlight'));
      }
      function highlightNode(node) {
        clearHighlights();
        if (!node) return;
        node.classList.add('tts-highlight');
        try { node.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) {}
      }

      function deviceDefaultRate() {
        const w = window.innerWidth;
        if (w <= 420) return 0.95;
        if (w <= 820) return 1.0;
        return 1.08;
      }

      /* speaking */
      function speakObj(obj) {
        if (!obj || !obj.text) { S.idx++; return; }
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(obj.text);
        const voiceURI = (voicesSelect && voicesSelect.value) || localStorage.getItem(STORAGE_PREFIX + '.voice') || '';
        const selected = S.voices.find(v => v.voiceURI === voiceURI) || S.voices.find(v => v.default) || S.voices[0];
        if (selected) u.voice = selected;
        u.rate = rateInput ? parseFloat(rateInput.value) : deviceDefaultRate();
        u.pitch = pitchInput ? parseFloat(pitchInput.value) : 1.0;
        u.volume = S.muted ? 0 : 1;
        u.onstart = () => highlightNode(obj.node);
        u.onend = () => {
          S.idx++;
          localStorage.setItem(RESUME_KEY, String(S.idx));
          if (S.idx < S.sentences.length) {
            setTimeout(() => speakObj(S.sentences[S.idx]), 110);
          } else {
            S.idx = 0;
            localStorage.setItem(RESUME_KEY, '0');
            clearHighlights();
          }
        };
        S.utterance = u;
        speechSynthesis.speak(u);
      }

      /* controls */
      function play(index) {
        if (!S.sentences.length) buildSentences();
        if (typeof index === 'number') S.idx = index;
        if (S.idx >= S.sentences.length) S.idx = 0;
        if (speechSynthesis.paused) return speechSynthesis.resume();
        speakObj(S.sentences[S.idx]);
      }
      function pauseToggle() {
        if (speechSynthesis.speaking && !speechSynthesis.paused) speechSynthesis.pause();
        else if (speechSynthesis.paused) speechSynthesis.resume();
      }
      function stop() {
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
        S.idx = 0;
        localStorage.setItem(RESUME_KEY, '0');
        clearHighlights();
      }
      function speakText(text) {
        if (!text || !text.trim()) return;
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        const voiceURI = (voicesSelect && voicesSelect.value) || localStorage.getItem(STORAGE_PREFIX + '.voice') || '';
        const selected = S.voices.find(v => v.voiceURI === voiceURI) || S.voices[0];
        if (selected) u.voice = selected;
        u.rate = rateInput ? parseFloat(rateInput.value) : deviceDefaultRate();
        u.pitch = pitchInput ? parseFloat(pitchInput.value) : 1.0;
        speechSynthesis.speak(u);
      }
      function toggleAuto() {
        S.auto = !S.auto;
        localStorage.setItem(AUTO_KEY, S.auto ? 'true' : 'false');
        if (autoBtn) autoBtn.style.opacity = S.auto ? '1' : '0.6';
      }
      function setCompact(flag) {
        if (!ttsBar) return;
        ttsBar.setAttribute('data-compact', flag ? 'true' : 'false');
        localStorage.setItem(COMPACT_KEY, flag ? 'true' : 'false');
      }

      /* attach UI */
      playBtn && playBtn.addEventListener('click', () => { play(0); });
      pauseBtn && pauseBtn.addEventListener('click', pauseToggle);
      stopBtn && stopBtn.addEventListener('click', stop);
      voicesSelect && voicesSelect.addEventListener('change', () => localStorage.setItem(STORAGE_PREFIX + '.voice', voicesSelect.value));
      rateInput && rateInput.addEventListener('input', () => localStorage.setItem(STORAGE_PREFIX + '.rate', rateInput.value));
      pitchInput && pitchInput.addEventListener('input', () => localStorage.setItem(STORAGE_PREFIX + '.pitch', pitchInput.value));
      if (autoBtn) { autoBtn.style.opacity = S.auto ? '1' : '0.6'; autoBtn.addEventListener('click', toggleAuto); }
      if (collapseBtn) collapseBtn.addEventListener('click', () => { const cur = ttsBar.getAttribute('data-compact') === 'true'; setCompact(!cur); });

      /* initial compact & restore settings */
      (function init() {
        const storedCompact = localStorage.getItem(COMPACT_KEY);
        const shouldDefault = window.matchMedia('(max-width:820px)').matches;
        const compact = storedCompact === null ? shouldDefault : (storedCompact === 'true');
        setCompact(compact);

        const r = localStorage.getItem(STORAGE_PREFIX + '.rate');
        const p = localStorage.getItem(STORAGE_PREFIX + '.pitch');
        const v = localStorage.getItem(STORAGE_PREFIX + '.voice');
        if (r && rateInput) rateInput.value = r;
        if (p && pitchInput) pitchInput.value = p;
        if (v && voicesSelect) setTimeout(()=> { try { voicesSelect.value = v; } catch(e){} }, 600);
      })();

      /* responsive adjustments */
      function handleResize() {
        const narrow = window.matchMedia('(max-width:420px)').matches;
        const tablet = window.matchMedia('(max-width:820px)').matches && !narrow;
        const userSet = localStorage.getItem(COMPACT_KEY);
        if (userSet === null) {
          if (narrow) setCompact(true);
          else setCompact(false);
        }
        if (voicesSelect) {
          if (narrow) voicesSelect.style.maxWidth = '120px';
          else if (tablet) voicesSelect.style.maxWidth = '180px';
          else voicesSelect.style.maxWidth = '240px';
        }
        const desktopBtn = document.querySelector('.desktop-back-btn');
        if (desktopBtn) desktopBtn.style.display = window.innerWidth <= MOBILE_BREAK ? 'none' : 'inline-flex';
      }
      window.addEventListener('resize', handleResize);
      window.addEventListener('orientationchange', () => setTimeout(handleResize, 260));
      handleResize();

      /* keyboard shortcuts */
      window.addEventListener('keydown', (e) => {
        const tag = (e.target && e.target.tagName || '').toLowerCase();
        if (tag === 'input' || tag === 'textarea' || e.target.isContentEditable) return;
        if (e.code === 'Space') { e.preventDefault(); if (speechSynthesis.speaking && !speechSynthesis.paused) pauseToggle(); else if (speechSynthesis.paused) pauseToggle(); else play(S.idx || 0); }
        else if (e.key === 's' || e.key === 'S') stop();
        else if (e.key === 'b' || e.key === 'B') window.location.href = HOME;
        else if (e.key === '+' || e.key === '=') { if (rateInput) { rateInput.value = Math.min(parseFloat(rateInput.value) + 0.1, parseFloat(rateInput.max)); localStorage.setItem(STORAGE_PREFIX + '.rate', rateInput.value); } }
        else if (e.key === '-') { if (rateInput) { rateInput.value = Math.max(parseFloat(rateInput.value) - 0.1, parseFloat(rateInput.min)); localStorage.setItem(STORAGE_PREFIX + '.rate', rateInput.value); } }
        else if (e.key === 'm' || e.key === 'M') { S.muted = !S.muted; }
        else if (e.key === 'r' || e.key === 'R') { const sel = window.getSelection().toString().trim(); if (sel) speakText(sel); }
        else if (e.key === 'a' || e.key === 'A') toggleAuto();
        else if (e.key === 't' || e.key === 'T') { S.readingOnScroll = !S.readingOnScroll; alert('Read-on-scroll: ' + (S.readingOnScroll ? 'ON' : 'OFF')); }
      });

      /* double-tap to toggle play/pause on mobile */
      (function doubleTap() {
        let last = 0;
        document.addEventListener('touchend', (ev) => {
          const now = Date.now();
          if (now - last < 350) {
            if (speechSynthesis.speaking && !speechSynthesis.paused) pauseToggle();
            else play(S.idx || 0);
            last = 0;
            return;
          }
          last = now;
        }, { passive: true });
      })();

      /* read-on-scroll using IntersectionObserver */
      (function readOnScroll() {
        if (!('IntersectionObserver' in window)) return;
        const io = new IntersectionObserver((entries) => {
          if (!S.readingOnScroll) return;
          entries.forEach(en => {
            if (en.isIntersecting && en.intersectionRatio > 0.6) {
              const node = en.target;
              const idx = S.sentences.findIndex(s => s.node === node);
              if (idx >= 0) { S.idx = idx; play(idx); }
            }
          });
        }, { threshold: [0.6] });
        function observe() {
          const nodes = lesson.querySelectorAll('h1,h2,h3,h4,p,li,pre');
          nodes.forEach(n => io.observe(n));
        }
        observe();
        const mo = new MutationObserver(observe);
        mo.observe(lesson, { childList: true, subtree: true });
      })();

      /* expose small API */
      window.CyberEnh = {
        play: () => play(0),
        pause: () => pauseToggle(),
        stop: () => stop(),
        speakText: (t) => speakText(t),
        toggleAutoRead: () => toggleAuto(),
        selectVoice: (nameOrURI) => {
          if (!voicesSelect || !nameOrURI) return;
          const opt = Array.from(voicesSelect.options).find(o => o.value === nameOrURI || o.textContent.includes(nameOrURI));
          if (opt) { voicesSelect.value = opt.value; localStorage.setItem(STORAGE_PREFIX + '.voice', opt.value); }
        },
        getState: () => ({ idx: S.idx, auto: S.auto, muted: S.muted })
      };

      /* auto-play if allowed */
      window.addEventListener('load', () => {
        buildSentences();
        if (S.auto) {
          try { play(S.idx || 0); } catch (e) { console.warn('Auto TTS blocked by browser, user must press Play to start.'); }
        }
      });

      /* quick hint for first-time visitors */
      if (!localStorage.getItem(HINT_KEY)) {
        setTimeout(()=> console.info('TTS shortcuts: Space play/pause ‚Ä¢ S stop ‚Ä¢ B back ‚Ä¢ +/- speed ‚Ä¢ R read selection ‚Ä¢ A toggle auto'), 1000);
        localStorage.setItem(HINT_KEY, '1');
      }

    })();
  </script>
</body>
</html>
