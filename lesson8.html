<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lesson 8 – Malware & Sniffing (Expanded + Labs + Quiz)</title>
  <style>
    :root{
      --bg:#071226; --card:#0f1b36; --muted:#9fb6d7; --text:#e8f3ff;
      --accent:#63a6ff; --accent-2:#76f0c4; --warn:#ffd66e; --danger:#ff758f;
      --tts-height: 96px; /* default until measured by JS */
      --header-height: 84px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    html { scroll-behavior: smooth; scroll-padding-top: calc(var(--header-height) + 12px); scroll-padding-bottom: calc(var(--tts-height) + 18px); }
    body{color:var(--text); background:linear-gradient(135deg,#071226 0%,#0a1b36 100%); -webkit-font-smoothing:antialiased}
    .container{max-width:1200px;margin:0 auto;padding:18px; padding-bottom: calc(var(--tts-height) + 28px);}
    header{position:sticky;top:0;z-index:20;background:rgba(7,18,38,0.6);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.04)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px}
    .left{display:flex;align-items:center;gap:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;font-weight:700;color:#071226;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:8px 12px;border-radius:999px;font-size:12px;text-transform:uppercase}
    .title{font-size:clamp(24px,3.8vw,36px);margin:6px 0}
    .subtitle{color:var(--muted);font-size:14px}
    .card{background:linear-gradient(180deg, rgba(10,24,46,0.6), var(--card));border-radius:14px;padding:18px;margin-top:16px;border:1px solid rgba(255,255,255,0.035)}
    .long-read{line-height:1.7;font-size:15px}
    .list{padding-left:20px}
    .list li{margin:8px 0}
    .small{font-size:13px;color:var(--muted)}
    .explain{margin-top:10px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:8px 12px;border-radius:10px;background:rgba(255,255,255,.02);cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#071226;border:none}
    pre{white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;overflow:auto}
    .q-card{background:rgba(255,255,255,0.02);border-radius:10px;padding:12px;margin:10px 0;border:1px solid rgba(255,255,255,0.03)}
    .q-options{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .result{font-weight:800;margin-left:12px}
    footer{opacity:.8;font-size:13px;padding:30px 0 60px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:2fr 420px}}
    .sidebar{position:sticky;top:84px}
    .muted{color:var(--muted)}
    .metric{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-bottom:8px}
    a{color:var(--accent)}
    .danger{color:var(--danger);font-weight:700}
    .warn-box{background:linear-gradient(180deg, rgba(255,215,110,0.03), rgba(255,215,110,0.01));border-left:4px solid rgba(255,215,110,0.18);padding:10px;border-radius:8px}
    .kbd{background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);}
    /* TTS bar */
    .tts-bar {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      background: rgba(0,0,0,0.65);
      color: #00ffcc;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
      font-family: 'Share Tech Mono', monospace;
      display: flex;
      gap: 8px;
      align-items: center;
      backdrop-filter: blur(6px);
      min-width: 300px;
    }
    .tts-bar button { background: linear-gradient(45deg,#ff0080,#7928ca); border: none; color: #fff; padding: 8px 10px; border-radius: 8px; font-weight: 700; cursor: pointer; min-width: 44px; }
    .tts-bar select, .tts-bar input[type="range"] { background: rgba(255,255,255,0.06); color: #00ffcc; border: 1px solid rgba(255,255,255,0.06); padding: 6px; border-radius: 8px; font-family: inherit; }
    .tts-highlight { background: rgba(0,255,200,0.12); padding:0 2px; border-radius:3px }
    @media (max-width:600px){ .tts-bar{ left:50%; transform:translateX(-50%); right:auto; bottom:12px; min-width:88% } }
    /* anchor spacing */
    .section-title { scroll-margin-top: calc(var(--header-height) + 18px); }
  </style>
</head>
<body>
  <header>
    <div class="container header-row">
      <div class="left">
        <span class="badge">Lesson 8</span>
        <div>
          <div class="title">Malware & Sniffing — Comprehensive Expansion</div>
          <div class="subtitle">Behaviors, detection recipes, SIEM/YARA, safe labs, and quiz</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:8px">
        <button class="btn" id="downloadNotes">📥 Download Notes</button>
        <button class="btn" id="copyMarkdown">📋 Copy Markdown</button>
        <button class="btn" id="toggleTheme">🌗 Theme</button>
      </div>
    </div>
  </header>

  <main class="container grid" role="main" aria-live="polite">
    <article>
      <section class="card">
        <h2>Overview — what this lesson adds</h2>
        <p class="long-read">
          This expanded lesson deepens the previous material with practical detection heuristics, SIEM correlation ideas, YARA examples for static detection, step-by-step safe-lab recipes (no malware distribution), and additional real-world analysis. It's designed for defensive practitioners who want to combine policy, architecture, and hands-on detection capabilities.
        </p>
        <div class="explain">
          <strong>Safety note:</strong> commands and tools shown are for authorized lab environments only. Never run offensive scans or malware against systems you do not own or have explicit written permission for. See the Legal & Ethical section later.
        </div>
      </section>

      <!-- (all your original sections preserved) -->
      <section class="card long-read" id="what-malware">
        <h2 class="section-title">What is Malware? — purpose & lifecycle (expanded)</h2>
        <p>
          Malware is best understood via its lifecycle: <strong>initial access → execution → persistence → privilege escalation → defense evasion → lateral movement → C2 & exfiltration → action on objectives (data theft, destruction, ransom)</strong>. Each phase provides defenders with collection and detection opportunities.
        </p>

        <h3>Lifecycle detection opportunities</h3>
        <ul class="list">
          <li><strong>Initial access:</strong> suspicious inbound email attachments, vulnerable public services, or compromised accounts. Monitor MFAs and abnormal logins.</li>
          <li><strong>Execution:</strong> new processes spawned by Office macros, signed binaries launching script interpreters, or unusual parent-child process relationships.</li>
          <li><strong>Persistence:</strong> new scheduled tasks, services, startup registry keys, or systemd units. Monitor changes in these persistence stores.</li>
          <li><strong>C2 & exfil:</strong> beacon patterns (regular, low-volume callbacks), DNS over abnormal domains, and large outbound data bursts.</li>
        </ul>

        <h3>Threat modeling</h3>
        <p class="small muted">
          When designing defenses, map threat actors (opportunistic, criminal ransomware groups, APTs) to TTPs and determine which controls (EPP/EDR, network segmentation, user training, backups) most reduce risk.
        </p>
      </section>

      <section class="card long-read" id="types">
        <h2 class="section-title">Malware taxonomy — behaviors and real-world signs</h2>

        <h3>Virus — indicators</h3>
        <p class="small muted">Signs: identical file hashes across endpoints, new macros in Office templates, modified executable timestamps.</p>
        <p>Detection: file hash blacklists, document macro policies, and file integrity monitoring.</p>

        <h3>Worm — indicators</h3>
        <p class="small muted">Signs: rapid increase in connections to the same port across subnets, scanning behavior, duplicated artifacts across many hosts.</p>

        <h3>Trojan / Backdoor — indicators</h3>
        <p class="small muted">Signs: suspicious outbound connections to unknown domains, persistence entries referencing unusual binaries, reverse-shell artifacts.</p>

        <h3>Ransomware — indicators</h3>
        <p class="small muted">Signs: file rename patterns, rapid mass-file modifications, deletion of shadow copies, creation of ransom notes (.txt/.html), unusual encryption libraries loaded in memory.</p>

        <h3>Fileless attacks — indicators</h3>
        <p class="small muted">Signs: PowerShell command lines with base64, cmd.exe spawning PowerShell with encoded commands, suspicious WMI event subscriptions.</p>

        <h3>Rootkits — detection challenges</h3>
        <p class="small muted">Rootkits hide processes and files. Detection requires cross-checking kernel module lists, comparison of raw disk vs filesystem views, and trusted boot chains (Secure Boot).</p>

        <div class="explain">
          <strong>Defender’s view:</strong> combine endpoint telemetry (process, registry, memory) + network telemetry (DNS, TLS SNI, flow logs) + identity signals (login anomalies) for robust detection.
        </div>
      </section>

      <section class="card long-read" id="vectors">
        <h2 class="section-title">Propagation & infection vectors — deeper</h2>
        <p>Attackers chain vectors—social engineering to drop a Trojan, then exploit to move laterally. Common vector combos:</p>
        <ul class="list">
          <li>Phishing → Credential theft → RDP access → ransomware</li>
          <li>Malicious dependency in supply chain → signed update pushes backdoor</li>
          <li>Exposed admin interface → brute force → deploy worm across internal network</li>
        </ul>

        <h3>Mitigation patterns</h3>
        <ul class="list">
          <li>Reduce attack surface: close unused ports, adopt Zero Trust segmentation, and disable legacy protocols.</li>
          <li>Harden identities: enforce MFA, short-lived keys, and hardware MFA for admins.</li>
          <li>Software supply chain controls: code signing validation, SBOM (software bill of materials), and controlled update channels.</li>
        </ul>
      </section>

      <section class="card long-read" id="detection">
        <h2 class="section-title">Detection recipes — SIEM correlation & YARA examples</h2>
        <p class="small muted">Below are defensible starting points you can adapt to your environment. Tune thresholds to avoid excessive false positives.</p>

        <h3>SIEM correlation idea — Ransomware early warning</h3>
        <pre>
Rule: ALERT when any host shows:
 - &gt; 100 file write events to dissimilar volumes within 5 minutes AND
 - creation of newly-named ransom file patterns (*.locked, *_README.txt) OR simultaneous creation of many .encrypted files
Action: isolate host VLAN, block host at NAC, notify IR, take EDR snapshot
        </pre>

        <h3>SIEM rule — suspicious PowerShell</h3>
        <pre>
Rule: If process 'powershell.exe' or 'pwsh' is executed with encoded-command or base64 content AND parent is MSWord/Outlook -> high priority alert
Action: capture memory, block execution, notify analyst
        </pre>

        <h3>YARA sample (simple)</h3>
        <pre>
rule Suspicious_Installer_Strings {
 meta:
   author = "Defender"
   description = "Detects common installer obfuscation strings"
 strings:
   $s1 = "CreateProcessA" nocase
   $s2 = "GetProcAddress" nocase
   $s3 = "LoadLibrary" nocase
 condition:
   (uint32(0) == 0x5A4D) and (any of ($s*))
}
        </pre>

        <div class="explain">
          <strong>Notes:</strong> YARA is for static detection on artifacts; combine with dynamic behavioral detections. Always test rules on known-good corpora to reduce false positives.
        </div>
      </section>

      <section class="card long-read" id="net-detect">
        <h2 class="section-title">Network detection — Indicators & heuristics</h2>
        <p>Network telemetry can reveal C2, exfil, and lateral movements. Common heuristics:</p>
        <ul class="list">
          <li><strong>DNS:</strong> fast-flux domains, many small queries to dynamic domains, long domain name entropy, use of uncommon TLDs used by malware.</li>
          <li><strong>Beaconing:</strong> periodic callbacks to the same external IP/domain with consistent intervals — inspect for jitter/variability to reduce false positives.</li>
          <li><strong>HTTP:</strong> weird User-Agents, POSTs to odd endpoints, encrypted payloads on ports not usually used for TLS.</li>
          <li><strong>Flows:</strong> large outbound flows to unknown hosts at odd hours (possible exfil).</li>
        </ul>
        <p class="small muted">Use NetFlow/IPFIX, DNS logs, proxy logs, and TLS metadata (SNI, certificate info) in SIEM to build detections.</p>
      </section>

      <section class="card long-read" id="cases">
        <h2 class="section-title">Detailed case studies & lessons</h2>

        <h3>WannaCry — what defenders can learn</h3>
        <p>
          WannaCry combined a wormable Windows SMB exploit with ransomware payload. It spread quickly across unpatched hosts and highlighted the need for: timely patching, network segmentation, disabling SMBv1, and having offline/backed-up recovery options.
        </p>

        <h3>SolarWinds supply-chain (context)</h3>
        <p>
          While not pure malware in the classic sense, SolarWinds taught defenders about the risk of trusted updates. Build detection rules for unusual outbound behavior from management systems and validate vendor attestations.
        </p>

        <h3>ILOVEYOU — human element</h3>
        <p>
          The ILOVEYOU worm succeeded because users executed attachments. Training + attachment sandboxing + disabling macros in email attachments reduces similar risks.
        </p>
      </section>

      <section class="card long-read" id="sniffing">
        <h2 class="section-title">Sniffing — fundamentals, attack modes & detection</h2>
        <p>
          Packet sniffing captures network traffic for analysis. Attackers sniff to steal credentials and tokens over unencrypted channels. Defenders can also capture packets to troubleshoot or investigate incidents.
        </p>

        <h3>Passive sniffing</h3>
        <p class="small muted">Occurs when an interface naturally sees traffic (hub or mirrored/SPAN port). It's stealthy and hard to detect from the victim's perspective.</p>

        <h3>Active sniffing</h3>
        <p class="small muted">Involves manipulation (ARP spoofing, ICMP redirection) to divert traffic to the attacker — usually detectable by ARP anomalies and duplicate MAC/IP pairs.</p>

        <h3>Detection signals for sniffing/mitm</h3>
        <ul class="list">
          <li>Frequent ARP cache changes or ARP broadcasts from a single host.</li>
          <li>Duplicate IPs seen with different MAC addresses in switch logs.</li>
          <li>Unexpected TLS downgrade attempts or presence of self-signed certs where not expected.</li>
        </ul>
      </section>

      <section class="card long-read" id="sniff-tools">
        <h2 class="section-title">Tools & safe lab commands (defensive focus)</h2>
        <p class="small muted">Use in isolated labs only. Commands illustrate capture and analysis techniques for investigators.</p>

        <h3>Capture tips</h3>
        <pre>
# Capture on interface (root)
sudo tcpdump -i eth0 -s 0 -w /tmp/capture.pcap

# Capture only DNS queries
sudo tcpdump -i eth0 -s 0 -w dns.pcap port 53
        </pre>

        <h3>Analyze with tshark / Wireshark</h3>
        <pre>
# Show HTTP requests
tshark -r capture.pcap -Y http.request

# Extract files from pcap (useful when investigating exfil)
strings capture.pcap | less
        </pre>

        <h3>Detect ARP spoofing</h3>
        <pre>
# Linux: show ARP table and look for frequent changes
ip neigh show

# Use arping to confirm MAC for gateway IP
sudo arping -c 3 -I eth0 10.0.0.1
        </pre>

        <div class="explain">
          <strong>Lab idea:</strong> create two VMs and a dedicated switch/virtual network. Use one VM as attacker with <code>ettercap</code> to ARP-spoof and use Wireshark on the victim to observe captured packets. Then enable DHCP snooping and dynamic ARP inspection on the virtual switch to test defenses.
        </div>
      </section>

      <section class="card long-read" id="ir">
        <h2 class="section-title">Incident Response — ransomware & sniffing incidents (step-by-step)</h2>
        <ol class="list">
          <li><strong>Identification:</strong> collect alerts (EDR/SIEM), isolate affected hosts from the network (quarantine), preserve evidence (memory & disk images), and record timestamps & scope.</li>
          <li><strong>Containment:</strong> block C2 domains/ips at firewall, rotate credentials, revoke sessions for compromised accounts.</li>
          <li><strong>Eradication:</strong> remove malware using EDR tools or rebuild from known-good images; ensure rootkits are removed and kernel integrity restored.</li>
          <li><strong>Recovery:</strong> restore systems from verified backups, reintroduce hosts into network, monitor for re-infection for 30 days.</li>
          <li><strong>Post-incident:</strong> update detection rules, patch systems, and run lessons-learned and tabletop exercises to close gaps.</li>
        </ol>
      </section>

      <section class="card long-read" id="ethics">
        <h2 class="section-title">Legal & ethical considerations (expanded)</h2>
        <p class="small muted">
          Many commands/tools are dual-use. Only perform offensive or intrusive actions with explicit written authorization. In regulated industries, coordinate with legal/compliance teams before investigation or notification. Maintain chain-of-custody for evidence if law enforcement becomes involved.
        </p>
      </section>

      <section class="card" id="quiz">
        <h2 class="section-title">Quiz — Malware & Sniffing (12 questions)</h2>
        <p class="small muted">This quiz reinforces detection and response concepts. Use the explanations after submission to learn.</p>

        <form id="msQuiz">
          <!-- Q1..Q12: identical to your original content -->
          <!-- Q1 -->
          <div class="q-card">
            <h4>1) Which indicator is most associated with fileless malware?</h4>
            <div class="q-options">
              <label><input type="radio" name="q1" value="a"> New executable file on disk</label>
              <label><input type="radio" name="q1" value="b"> Powershell with encoded commands and no corresponding disk artifact</label>
              <label><input type="radio" name="q1" value="c"> Presence of ransom note files</label>
            </div>
          </div>
          <!-- ... (rest of the quiz Q2..Q12 kept identical) -->
          <!-- Q2 -->
          <div class="q-card">
            <h4>2) A sudden spike of small DNS queries to many random hostnames likely indicates:</h4>
            <div class="q-options">
              <label><input type="radio" name="q2" value="a"> Regular web browsing</label>
              <label><input type="radio" name="q2" value="b"> Fast-flux or DGA (domain generation algorithm) based C2 activity</label>
              <label><input type="radio" name="q2" value="c"> Printer traffic</label>
            </div>
          </div>

          <!-- Q3 -->
          <div class="q-card">
            <h4>3) Best first containment step when you detect an active ransomware encryption process?</h4>
            <div class="q-options">
              <label><input type="radio" name="q3" value="a"> Shut down domain controllers immediately</label>
              <label><input type="radio" name="q3" value="b"> Isolate infected hosts from network and preserve volatile data</label>
              <label><input type="radio" name="q3" value="c"> Publish a company-wide notice to reboot all machines</label>
            </div>
          </div>

          <!-- Q4 -->
          <div class="q-card">
            <h4>4) ARP spoofing used to redirect traffic to an attacker's host is an example of:</h4>
            <div class="q-options">
              <label><input type="radio" name="q4" value="a"> Passive sniffing</label>
              <label><input type="radio" name="q4" value="b"> Active sniffing / MITM</label>
              <label><input type="radio" name="q4" value="c"> Supply chain attack</label>
            </div>
          </div>

          <!-- Q5 -->
          <div class="q-card">
            <h4>5) Which defense most directly prevents credential sniffing on public Wi-Fi?</h4>
            <div class="q-options">
              <label><input type="radio" name="q5" value="a"> Use TLS and a reputable VPN</label>
              <label><input type="radio" name="q5" value="b"> Use FTP for file transfers</label>
              <label><input type="radio" name="q5" value="c"> Disable HTTPS</label>
            </div>
          </div>

          <!-- Q6 -->
          <div class="q-card">
            <h4>6) Which network signal could indicate C2 beaconing?</h4>
            <div class="q-options">
              <label><input type="radio" name="q6" value="a"> Large one-time download of a public software update</label>
              <label><input type="radio" name="q6" value="b"> Regular periodic small connections to the same external host every 5 minutes</label>
              <label><input type="radio" name="q6" value="c"> DNS queries only to internal AD servers</label>
            </div>
          </div>

          <!-- Q7 -->
          <div class="q-card">
            <h4>7) Which of these is a recommended ransomware preparedness control?</h4>
            <div class="q-options">
              <label><input type="radio" name="q7" value="a"> Single backup stored on the same network share</label>
              <label><input type="radio" name="q7" value="b"> Immutable, offline backups with tested restores and segmentation</label>
              <label><input type="radio" name="q7" value="c"> Disable backups to avoid data duplication</label>
            </div>
          </div>

          <!-- Q8 -->
          <div class="q-card">
            <h4>8) YARA is primarily used for:</h4>
            <div class="q-options">
              <label><input type="radio" name="q8" value="a"> Dynamic network traffic shaping</label>
              <label><input type="radio" name="q8" value="b"> Pattern-based scanning of files/artifacts for malware signatures</label>
              <label><input type="radio" name="q8" value="c"> Managing Windows Group Policy</label>
            </div>
          </div>

          <!-- Q9 -->
          <div class="q-card">
            <h4>9) Which command is useful to capture packets on Linux for later analysis?</h4>
            <div class="q-options">
              <label><input type="radio" name="q9" value="a"> sudo tcpdump -i eth0 -s 0 -w capture.pcap</label>
              <label><input type="radio" name="q9" value="b"> sudo rm -rf /</label>
              <label><input type="radio" name="q9" value="c"> echo "capture" &gt; /tmp/capture</label>
            </div>
          </div>

          <!-- Q10 -->
          <div class="q-card">
            <h4>10) Which signal would strongly suggest a rootkit is present?</h4>
            <div class="q-options">
              <label><input type="radio" name="q10" value="a"> Consistent visibility of all processes with ps</label>
              <label><input type="radio" name="q10" value="b"> System process missing when comparing raw disk listings to filesystem view</label>
              <label><input type="radio" name="q10" value="c"> Normal CPU & memory use</label>
            </div>
          </div>

          <!-- Q11 -->
          <div class="q-card">
            <h4>11) Which is a defensive network configuration to limit sniffing risk on LANs?</h4>
            <div class="q-options">
              <label><input type="radio" name="q11" value="a"> Enable DHCP snooping & dynamic ARP inspection on switches</label>
              <label><input type="radio" name="q11" value="b"> Disable switch port security</label>
              <label><input type="radio" name="q11" value="c"> Allow all hosts to broadcast MAC addresses</label>
            </div>
          </div>

          <!-- Q12 -->
          <div class="q-card">
            <h4>12) If you find a suspicious outbound TLS connection to an unknown IP, next best action is:</h4>
            <div class="q-options">
              <label><input type="radio" name="q12" value="a"> Immediately delete the host from the network without logs</label>
              <label><input type="radio" name="q12" value="b"> Enrich the IP (WHOIS, passive DNS), check host process and EDR telemetry, and if malicious, contain</label>
              <label><input type="radio" name="q12" value="c"> Ignore it — TLS means it's safe</label>
            </div>
          </div>

          <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
            <button type="button" class="btn primary" id="submitQuiz">Submit Quiz</button>
            <button type="button" class="btn" id="resetQuiz">Reset</button>
            <span id="quizResult" class="result" aria-live="polite"></span>
          </div>
        </form>
      </section>

      <section class="card">
        <h2>Resources & further learning</h2>
        <ul class="list">
          <li><strong>Books:</strong> Practical Malware Analysis; The Practice of Network Security Monitoring.</li>
          <li><strong>Tools to evaluate:</strong> Wireshark, Zeek (Bro), Suricata, Elastic/ELK, Velociraptor, GRR, YARA.</li>
          <li><strong>Communities:</strong> Malware Traffic Analysis, The DFIR community on Twitter/Discord, SANS DFIR resources.</li>
        </ul>
      </section>

      <footer class="container">
        <p class="small muted">© Learning Playground — Malware & Sniffing • Expanded • For authorized defensive lab use only</p>
      </footer>
    </article>

    <aside class="sidebar" aria-label="Sidebar">
      <div class="card">
        <h3>Quick Links</h3>
        <ul class="list">
          <li><a href="#what-malware">What is Malware?</a></li>
          <li><a href="#types">Malware Types</a></li>
          <li><a href="#vectors">Infection Vectors</a></li>
          <li><a href="#detection">Detection Recipes</a></li>
          <li><a href="#net-detect">Network Detection</a></li>
          <li><a href="#sniffing">Sniffing Fundamentals</a></li>
          <li><a href="#sniff-tools">Sniffing Tools</a></li>
          <li><a href="#quiz">Quiz</a></li>
        </ul>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Cheat Sheet</h3>
        <div class="metric"><strong>Protect:</strong> patch, segment, MFA, EDR, backups</div>
        <div class="metric"><strong>Detect:</strong> SIEM rules, NetFlow, DNS anomalies</div>
        <div class="metric"><strong>Respond:</strong> isolate, triage, preserve, restore</div>
        <div class="metric warn-box"><strong class="muted">Lab safety:</strong> test only in isolated networks; use snapshots and restore points.</div>
      </div>
    </aside>
  </main>

  <!-- TTS Control Bar -->
  <div id="ttsBar" class="tts-bar" aria-hidden="false" role="region" aria-label="Text to speech controls">
    <button id="ttsPlay" title="Play">▶</button>
    <button id="ttsPause" title="Pause">⏸</button>
    <button id="ttsStop" title="Stop">⏹</button>

    <span class="label">Voice</span>
    <select id="ttsVoices" aria-label="Select voice"></select>

    <span class="label">Rate</span>
    <input id="ttsRate" type="range" min="0.6" max="2" step="0.1" value="1" />

    <span class="label">Pitch</span>
    <input id="ttsPitch" type="range" min="0.6" max="2" step="0.1" value="1" />

    <button id="ttsToggleAuto" class="btn" title="Auto-read on load">A</button>
  </div>

  <script>
    /* Theme toggle */
    const themeBtn = document.getElementById('toggleTheme');
    const themeKey = 'lesson8-theme';
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    function applyTheme(mode) {
      if (mode === 'light') {
        document.documentElement.style.setProperty('--bg','#f4f7fb');
        document.documentElement.style.setProperty('--card','#ffffff');
        document.documentElement.style.setProperty('--text','#072033');
        document.documentElement.style.setProperty('--muted','#4a5875');
        document.documentElement.style.setProperty('--accent','#3b82f6');
        document.documentElement.style.setProperty('--accent-2','#34d399');
      } else {
        document.documentElement.style.setProperty('--bg','#071226');
        document.documentElement.style.setProperty('--card','#0f1b36');
        document.documentElement.style.setProperty('--text','#e8f3ff');
        document.documentElement.style.setProperty('--muted','#9fb6d7');
        document.documentElement.style.setProperty('--accent','#63a6ff');
        document.documentElement.style.setProperty('--accent-2','#76f0c4');
      }
    }
    const initial = localStorage.getItem(themeKey) || (prefersDark ? 'dark' : 'dark');
    applyTheme(initial);
    themeBtn.addEventListener('click', () => {
      const cur = localStorage.getItem(themeKey) || initial;
      const next = cur === 'dark' ? 'light' : 'dark';
      localStorage.setItem(themeKey, next);
      applyTheme(next);
    });

    /* Download notes (text) */
    document.getElementById('downloadNotes').addEventListener('click', () => {
      const nodes = document.querySelectorAll('article h2, article h3, article p, article li, article pre');
      const lines = [];
      nodes.forEach(n => {
        const t = n.tagName.toLowerCase();
        if (t === 'h2') lines.push('\n' + n.innerText + '\n' + '-'.repeat(60));
        else if (t === 'h3') lines.push('\n' + n.innerText + '\n');
        else if (t === 'pre') lines.push('```\n' + n.innerText + '\n```\n');
        else lines.push(n.innerText);
      });
      const blob = new Blob([lines.join('\n')], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'Lesson8_Malware_Sniffing_Notes.txt'; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 800);
    });

    /* Copy Markdown */
    document.getElementById('copyMarkdown').addEventListener('click', async () => {
      const nodes = document.querySelectorAll('article h2, article h3, article p, article li, article pre');
      let md = '';
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h2') md += `## ${n.innerText}\n\n`;
        else if (tag === 'h3') md += `### ${n.innerText}\n\n`;
        else if (tag === 'li') md += `- ${n.innerText}\n`;
        else if (tag === 'pre') md += '```\n' + n.innerText + '\n```\n\n';
        else md += `${n.innerText}\n\n`;
      });
      try { await navigator.clipboard.writeText(md); alert('Copied lesson content as Markdown to clipboard.'); }
      catch(e){ alert('Could not copy to clipboard.'); }
    });

    /* Quiz logic (keeps your original logic) */
    const answers = {
      q1: 'b', q2: 'b', q3: 'b', q4: 'b', q5: 'a', q6: 'b',
      q7: 'b', q8: 'b', q9: 'a', q10: 'b', q11: 'a', q12: 'b'
    };
    const explanations = {
      q1: 'Fileless malware often uses PowerShell or WMI and avoids creating disk artifacts.',
      q2: 'Many random DNS queries is a hallmark of DGA/Fast-flux used by malware C2.',
      q3: 'Isolating infected hosts preserves evidence and prevents lateral movement.',
      q4: 'ARP spoofing actively changes network mappings — that is an active MITM/sniffing technique.',
      q5: 'TLS + VPN protects traffic over untrusted networks; never use cleartext protocols on public Wi-Fi.',
      q6: 'Regular, periodic small connections are common for C2 beaconing.',
      q7: 'Immutable, offline backups plus tested restores are key ransomware defenses.',
      q8: 'YARA is for matching patterns in files/artifacts (static detection).',
      q9: 'tcpdump is the standard packet capture tool on Linux; the shown command captures to a pcap file.',
      q10: 'Rootkits hide artifacts; discrepancies between raw disk and filesystem views are suspicious.',
      q11: 'DHCP snooping and dynamic ARP inspection prevent rogue DHCP/ARP poisoning attacks.',
      q12: 'Enriching the IP and checking host telemetry helps determine whether to contain and block.'
    };

    const form = document.getElementById('msQuiz');
    const submitBtn = document.getElementById('submitQuiz');
    const resetBtn = document.getElementById('resetQuiz');
    const resultEl = document.getElementById('quizResult');

    function grade() {
      let score = 0, missed = [];
      for (let i = 1; i <= 12; i++) {
        const q = 'q' + i;
        const el = form.querySelector(`input[name="${q}"]:checked`);
        if (el && el.value === answers[q]) {
          score++;
          el.closest('.q-options').style.background = 'linear-gradient(90deg, rgba(120,200,255,0.06), rgba(120,255,200,0.02))';
        } else {
          missed.push(q);
          if (el) el.closest('.q-options').style.background = 'linear-gradient(90deg, rgba(255,120,140,0.04), rgba(0,0,0,0.01))';
        }
      }
      const total = 12;
      const pct = Math.round((score/total)*100);
      resultEl.textContent = `Score: ${score}/${total} (${pct}%)`;
      resultEl.style.color = pct >= 80 ? '#7ef0c1' : pct >= 60 ? '#ffd66e' : '#ff758f';

      // Append explanations
      const existing = document.getElementById('quizReview');
      if (existing) existing.remove();
      const review = document.createElement('div');
      review.id = 'quizReview';
      review.style.marginTop = '12px';
      review.style.padding = '12px';
      review.style.borderRadius = '10px';
      review.style.background = 'rgba(255,255,255,0.02)';
      let html = '<strong>Review & Explanations</strong><ul>';
      for (let i = 1; i <= 12; i++) {
        const q = 'q' + i;
        html += `<li><strong>Q${i}</strong> — Correct: <em>${answers[q].toUpperCase()}</em>. ${explanations[q]}</li>`;
      }
      html += '</ul>';
      review.innerHTML = html;
      form.appendChild(review);

      submitBtn.disabled = true;
      localStorage.setItem('lesson8-quiz', JSON.stringify({ score, pct, ts: Date.now() }));
    }

    submitBtn.addEventListener('click', grade);

    resetBtn.addEventListener('click', () => {
      form.reset();
      form.querySelectorAll('.q-options').forEach(el => el.style.background = '');
      resultEl.textContent = '';
      const existing = document.getElementById('quizReview'); if (existing) existing.remove();
      submitBtn.disabled = false;
      localStorage.removeItem('lesson8-quiz');
    });

    (function restore() {
      const raw = localStorage.getItem('lesson8-quiz');
      if (!raw) return;
      try {
        const obj = JSON.parse(raw);
        if (obj && obj.pct !== undefined) {
          resultEl.textContent = `Previous Score: ${obj.pct}%`;
          resultEl.style.color = obj.pct >= 80 ? '#7ef0c1' : obj.pct >= 60 ? '#ffd66e' : '#ff758f';
          submitBtn.disabled = true;
        }
      } catch (e) {}
    })();

    /* --- TTS module (Web Speech API) --- */
    (function () {
      const ttsBar = document.getElementById('ttsBar');
      const playBtn = document.getElementById('ttsPlay');
      const pauseBtn = document.getElementById('ttsPause');
      const stopBtn = document.getElementById('ttsStop');
      const voicesSelect = document.getElementById('ttsVoices');
      const rateInput = document.getElementById('ttsRate');
      const pitchInput = document.getElementById('ttsPitch');
      const autoBtn = document.getElementById('ttsToggleAuto');
      const lesson = document.querySelector('article') || document.body;
      let utterance = null, sentences = [], currentIndex = 0, readyVoices = [];

      if (!('speechSynthesis' in window)) {
        // hide TTS UI and adjust spacing
        if (ttsBar) ttsBar.style.display = 'none';
        adjustForTTS();
        return;
      }

      const prefs = {
        voiceURI: localStorage.getItem('tts.voice') || '',
        rate: parseFloat(localStorage.getItem('tts.rate')) || 1,
        pitch: parseFloat(localStorage.getItem('tts.pitch')) || 1,
        auto: localStorage.getItem('tts.auto') === 'true' || false
      };
      rateInput.value = prefs.rate; pitchInput.value = prefs.pitch; autoBtn.style.opacity = prefs.auto ? '1' : '0.6';

      function populateVoices() {
        const voices = speechSynthesis.getVoices();
        readyVoices = voices;
        voicesSelect.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.voiceURI;
          opt.textContent = `${v.name} (${v.lang})${v.default ? ' — default' : ''}`;
          voicesSelect.appendChild(opt);
        });
        if (prefs.voiceURI) {
          const found = [...voices].find(v => v.voiceURI === prefs.voiceURI);
          if (found) voicesSelect.value = prefs.voiceURI;
        }
        setTimeout(adjustForTTS, 120);
      }
      populateVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateVoices;

      function getText() {
        const nodes = lesson.querySelectorAll('h1,h2,h3,p,li,pre');
        return Array.from(nodes).map(n => n.innerText.trim()).filter(Boolean).join('.\n');
      }
      function buildSentences(text) { return text.split(/(?<=[.?!])\s+/); }

      function speakFrom(index = 0) {
        const text = getText(); sentences = buildSentences(text); currentIndex = index;
        if (currentIndex >= sentences.length) return; speakSentence(sentences[currentIndex]);
      }
      function speakSentence(sentence) {
        if (!sentence || sentence.trim()==='') { currentIndex++; if (currentIndex<sentences.length) speakSentence(sentences[currentIndex]); return; }
        cancel();
        utterance = new SpeechSynthesisUtterance(sentence);
        const voiceURI = voicesSelect.value || prefs.voiceURI;
        const selected = readyVoices.find(v => v.voiceURI === voiceURI) || readyVoices.find(v => v.default) || readyVoices[0];
        if (selected) utterance.voice = selected;
        utterance.rate = parseFloat(rateInput.value); utterance.pitch = parseFloat(pitchInput.value);
        utterance.onstart = () => highlightSentence(sentence);
        utterance.onend = () => { currentIndex++; if (currentIndex < sentences.length) setTimeout(()=>speakSentence(sentences[currentIndex]),120); else clearHighlights(); };
        speechSynthesis.speak(utterance);
      }
      function cancel() { if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel(); }
      function pause() { if (speechSynthesis.speaking) speechSynthesis.pause(); }
      function resume() { if (speechSynthesis.paused) speechSynthesis.resume(); }
      function highlightSentence(sentence) {
        clearHighlights(); if (!lesson) return;
        const text = lesson.innerHTML; const safe = sentence.replace(/[.*+?^${}()|[\]\\]/g,'\\$&').trim();
        if (!safe) return;
        const regex = new RegExp(safe);
        const newHtml = text.replace(regex, `<span class="tts-highlight">${sentence}</span>`);
        if (newHtml !== text) lesson.innerHTML = newHtml;
      }
      function clearHighlights() { if (!lesson) return; const highlights = lesson.querySelectorAll('.tts-highlight'); highlights.forEach(el => { const txt = el.textContent; el.outerHTML = txt; }); }

      playBtn.addEventListener('click', ()=>{ if (speechSynthesis.paused) return resume(); if (speechSynthesis.speaking) return; speakFrom(0); savePrefs(); });
      pauseBtn.addEventListener('click', ()=>{ if (speechSynthesis.speaking) pause(); else if (speechSynthesis.paused) resume(); });
      stopBtn.addEventListener('click', ()=>{ cancel(); clearHighlights(); });
      voicesSelect.addEventListener('change', savePrefs);
      rateInput.addEventListener('change', savePrefs);
      pitchInput.addEventListener('change', savePrefs);
      autoBtn.addEventListener('click', ()=>{ prefs.auto = !prefs.auto; localStorage.setItem('tts.auto', prefs.auto); autoBtn.style.opacity = prefs.auto ? '1' : '0.6'; });

      function savePrefs() { localStorage.setItem('tts.voice', voicesSelect.value || ''); localStorage.setItem('tts.rate', rateInput.value); localStorage.setItem('tts.pitch', pitchInput.value); }

      // auto-read if allowed
      window.addEventListener('load', ()=> {
        setTimeout(()=> { if (prefs.auto) { try { speakFrom(0); } catch(e){ console.warn('Auto TTS blocked'); } } }, 700);
      });

      // ensure TTS bar sizing is handled
      const mo = new MutationObserver(() => adjustForTTS());
      mo.observe(ttsBar, { attributes: true, childList: true, subtree: true });
    })();

    /* adjust layout for TTS bar so links / anchors are not covered */
    function adjustForTTS() {
      const bar = document.getElementById('ttsBar');
      if (!bar) return;
      const rect = bar.getBoundingClientRect();
      const computedStyle = window.getComputedStyle(bar);
      const marginBottom = parseFloat(computedStyle.marginBottom || 0);
      const marginTop = parseFloat(computedStyle.marginTop || 0);
      const totalHeight = Math.ceil(rect.height + marginTop + marginBottom);
      document.documentElement.style.setProperty('--tts-height', totalHeight + 'px');
      document.querySelectorAll('.container').forEach(el => {
        const base = 18;
        el.style.paddingBottom = (base + totalHeight + 10) + 'px';
      });
    }
    window.addEventListener('load', ()=> { setTimeout(adjustForTTS, 200); setTimeout(adjustForTTS, 900); });
    window.addEventListener('resize', ()=> { setTimeout(adjustForTTS, 120); });

    // small safety reminder in console
    console.warn("SAFETY: Examples and commands are for authorized lab use only. Do not run offensive tools on networks or systems you do not have permission to test.");
  </script>
</body>
</html>
