<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lesson 3 – Cryptography (Expanded)</title>

  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2e;
      --muted: #8aa0c3;
      --text: #e7eefc;
      --accent: #6ea8ff;
      --accent-2: #7ef0c1;
      --warning: #ffdf6e;
      --danger: #ff7e93;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Noto Sans,Helvetica,Arial}
    body{color:var(--text); background:linear-gradient(135deg,#0b1220 0%,#101b34 100%); -webkit-font-smoothing:antialiased;}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(160%) blur(8px);background:rgba(11,18,32,0.7);border-bottom:1px solid rgba(255,255,255,0.06)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;font-weight:600;color:#0b1220;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:8px 12px;border-radius:999px;font-size:12px;text-transform:uppercase;letter-spacing:.06em}
    .hero{padding:28px 20px 8px}
    .title{font-size:clamp(28px,4vw,40px);line-height:1.15;margin:4px 0 10px}
    .subtitle{color:var(--muted);font-size:15px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;background:rgba(255,255,255,0.04);border-radius:999px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .card{background:radial-gradient(140% 120% at 100% 0%,#132349 0%,var(--card) 45%);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-top:16px}
    .list{margin:0;padding-left:18px}
    .list li{margin:8px 0}
    .callout{background:linear-gradient(180deg,rgba(126,240,193,.06),rgba(126,240,193,.02));border:1px solid rgba(126,240,193,.14);padding:12px 14px;border-radius:12px;margin-top:10px}
    .warn{background:linear-gradient(180deg,rgba(255,223,110,.06),rgba(255,223,110,.02));border:1px solid rgba(255,223,110,.14)}
    .long-read{line-height:1.75;font-size:15px}
    .small{font-size:13px;color:var(--muted)}
    .explain{margin-top:8px;background:rgba(0,0,0,0.18);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.05);cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0b1220;border:none}
    .tts-bar{position:fixed;right:18px;bottom:18px;z-index:9999;background:rgba(0,0,0,0.65);color:#00ffcc;padding:10px 12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6);font-family:'Share Tech Mono',monospace;display:flex;gap:8px;align-items:center;backdrop-filter:blur(6px);min-width:260px}
    .tts-bar button{background:linear-gradient(45deg,#ff0080,#7928ca);border:none;color:#fff;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer;min-width:44px}
    .tts-bar .small{padding:6px 8px;min-width:36px}
    .tts-bar select,.tts-bar input[type="range"]{background:rgba(255,255,255,0.06);color:#00ffcc;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:8px;font-family:inherit}
    .tts-highlight{background:rgba(0,255,200,0.15);transition:background 0.2s;padding:0 2px;border-radius:3px}
    footer{opacity:.7;font-size:13px;padding:30px 0 60px}
    @media (max-width:600px){.tts-bar{left:50%;transform:translateX(-50%);right:auto;bottom:12px;min-width:88%}}
  </style>
</head>
<body>
  <header>
    <div class="container header-row">
      <div style="display:flex;align-items:center;gap:12px">
        <span class="badge">Lesson 3</span>
        <div>
          <strong>Cryptography — Full Module (Expanded)</strong>
          <div class="small muted">Threats • Encryption • Hashing • PKI • Attacks • Labs</div>
        </div>
      </div>
      <div>
        <button class="btn ghost" id="toggleTheme" title="Toggle contrast">🌗 Theme</button>
      </div>
    </div>
  </header>

  <main class="container">
    <article class="lesson-content">

      <section class="hero card">
        <h1 class="title">Cryptography — Foundations & Applications</h1>
        <p class="subtitle">A deep, expanded walkthrough of cryptography concepts: why it matters, how it works, common primitives, attacks, PKI, and real-world applications.</p>
        <div class="chips">
          <span class="chip">Encryption</span>
          <span class="chip">Hashing</span>
          <span class="chip">PKI</span>
          <span class="chip">Ciphers</span>
          <span class="chip">Threat Modeling</span>
        </div>
      </section>

      <!-- Threats -->
      <section class="card long-read" aria-labelledby="threats">
        <h2 id="threats" class="section-title">1. Threats</h2>
        <p>
          A cyber threat is any action or event that has the potential to compromise the confidentiality, integrity or availability of systems and data.
          Threats range from low-skill opportunistic malware to highly resourced, long-term advanced persistent threats (APTs).
        </p>
        <div class="explain">
          <strong>Common threat categories:</strong>
          <ul class="list">
            <li><strong>Malware:</strong> viruses, worms, trojans, spyware, ransomware — payloads that steal, destroy, or encrypt data.</li>
            <li><strong>Phishing & social engineering:</strong> attackers manipulate humans to reveal secrets or credentials.</li>
            <li><strong>DDoS / Availability attacks:</strong> flood services to deny legitimate access.</li>
            <li><strong>Insider threats:</strong> negligent or malicious employees abusing access.</li>
            <li><strong>Man-in-the-Middle (MitM):</strong> eavesdropping and altering communications between two parties.</li>
          </ul>
          <p class="small muted">Cryptography provides tools to reduce the impact of many of these threats by protecting contents, verifying origin, and detecting tampering.</p>
        </div>
      </section>

      <!-- Security Goals -->
      <section class="card long-read" aria-labelledby="goals">
        <h2 id="goals" class="section-title">2. Security Goals (CIA +)</h2>
        <p>
          The classical CIA triad—Confidentiality, Integrity and Availability—forms the backbone of security goals. Cryptography primarily helps with confidentiality and integrity,
          and contributes to authentication and non-repudiation.
        </p>
        <div class="explain">
          <ul class="list">
            <li><strong>Confidentiality:</strong> ensure only authorized readers can access data — commonly via encryption.</li>
            <li><strong>Integrity:</strong> ensure data cannot be undetectably altered — commonly via hashes and MACs (Message Authentication Codes).</li>
            <li><strong>Availability:</strong> ensure systems remain accessible — often addressed outside pure cryptography (redundancy, DDoS mitigation).</li>
            <li><strong>Authentication:</strong> confirm identities (passwords, keys, certificates).</li>
            <li><strong>Non-repudiation:</strong> prevent actors from denying actions (digital signatures provide evidence).</li>
          </ul>
          <p class="small muted">When designing systems, think: does this mechanism protect confidentiality, integrity, or both? Does it provide proof of origin?</p>
        </div>
      </section>

      <!-- Encryption & Decryption -->
      <section class="card long-read" aria-labelledby="encdec">
        <h2 id="encdec" class="section-title">3. Encryption & Decryption</h2>
        <p>
          Encryption transforms readable data (plaintext) into unreadable ciphertext using an algorithm and a key. Decryption restores plaintext when the correct key is provided.
        </p>
        <div class="explain">
          <strong>Concrete example — Caesar cipher (toy example):</strong>
          <p class="small muted">Shift letters by 3.</p>
          <pre>Plaintext:  HELLO
Ciphertext: KHOOR  (H→K, E→H, L→O, L→O, O→R)</pre>
          <p>
            Modern cryptography uses far stronger algorithms — not letter shifts — but the concept of transform + key is the same.
          </p>
        </div>

        <h3>When does encryption help?</h3>
        <ul class="list">
          <li><strong>At rest:</strong> disk or database encryption prevents data compromise on stolen drives.</li>
          <li><strong>In transit:</strong> TLS secures HTTP to HTTPS so eavesdroppers cannot read traffic.</li>
          <li><strong>Application-layer:</strong> end-to-end encryption (messaging apps) so servers can't read user content.</li>
        </ul>

        <div class="explain">
          <strong>Key management is everything.</strong> A secure encryption algorithm is useless if keys are stored unprotected or transmitted insecurely. Real-world breaches frequently come from poor key storage or leaked keys.
        </div>
      </section>

      <!-- Cryptography general -->
      <section class="card long-read" aria-labelledby="crypto">
        <h2 id="crypto" class="section-title">4. What is Cryptography?</h2>
        <p>
          Cryptography is the science and practice of designing techniques to protect information — keeping it secret (confidentiality), verifying it hasn't changed (integrity),
          and proving who sent it (authentication / non-repudiation).
        </p>
        <div class="explain">
          <p>Historically, cryptography included substitution and transposition ciphers used by ancient civilizations. Modern cryptography blends mathematics, algorithms, and engineering to secure digital systems.</p>
          <p class="small muted">Examples of modern usage: TLS for web, AES for symmetric encryption, RSA/ECC for keys & signatures, SHA family for hashing.</p>
        </div>
      </section>

      <!-- About Cryptography vocabulary -->
      <section class="card long-read" aria-labelledby="vocab">
        <h2 id="vocab" class="section-title">5. Basic Vocabulary</h2>
        <ul class="list">
          <li><strong>Plaintext:</strong> original readable data.</li>
          <li><strong>Ciphertext:</strong> transformed unreadable data.</li>
          <li><strong>Cipher:</strong> algorithm used to encrypt/decrypt.</li>
          <li><strong>Key:</strong> secret value used by the cipher.</li>
          <li><strong>Hash:</strong> one-way digest of data.</li>
          <li><strong>MAC:</strong> Message Authentication Code, verifies integrity + authenticity with a secret key.</li>
          <li><strong>Digital signature:</strong> asymmetric proof of origin and integrity.</li>
        </ul>
        <div class="explain">
          <p class="small muted">Important distinction — <strong>code</strong> historically substitutes words/phrases; modern systems use <strong>ciphers</strong> that operate on bits/blocks/streams.</p>
        </div>
      </section>

      <!-- Types of Cryptography -->
      <section class="card long-read" aria-labelledby="types">
        <h2 id="types" class="section-title">6. Types of Cryptography</h2>

        <h3>Symmetric Key Cryptography</h3>
        <p>
          A single shared secret key is used for both encryption and decryption. Symmetric ciphers are efficient and often used for bulk encryption.
        </p>
        <div class="explain">
          <ul class="list">
            <li><strong>Examples:</strong> AES (current standard), 3DES (legacy), ChaCha20 (stream cipher widely used in TLS).</li>
            <li><strong>Use cases:</strong> disk encryption, VPN tunnels, HTTPS session data (TLS uses symmetric cipher for bulk after handshake).</li>
            <li><strong>Challenge:</strong> securely sharing the secret key between parties (key distribution).</li>
          </ul>
        </div>

        <h3>Asymmetric (Public-key) Cryptography</h3>
        <p>
          Uses a key pair — a public key (shared openly) and a private key (kept secret). Data encrypted with the public key can only be decrypted with the corresponding private key.
        </p>
        <div class="explain">
          <ul class="list">
            <li><strong>Examples:</strong> RSA, ECDSA/ECDH (elliptic curve variants), Diffie–Hellman key exchange.</li>
            <li><strong>Use cases:</strong> secure key exchange, digital signatures, certificate-based authentication (TLS).</li>
            <li><strong>Trade-offs:</strong> asymmetric algorithms are slower and computationally heavier than symmetric ones, so hybrid approaches combine them (e.g., TLS handshake uses asymmetric crypto to establish symmetric session keys).</li>
          </ul>
        </div>

        <h3>Hash Functions</h3>
        <p>
          Hash functions take arbitrary input and produce a fixed-size digest. They are used for integrity checks and password storage (with salts).
        </p>
        <div class="explain">
          <ul class="list">
            <li><strong>Properties:</strong> one-way, deterministic, collision-resistant (ideally).</li>
            <li><strong>Examples:</strong> SHA-256, SHA-3. MD5 and SHA-1 are considered broken for collision resistance in many contexts and should be avoided.</li>
            <li><strong>Use cases:</strong> file integrity, digital signatures (hash then sign), password hashing (but use specialized slow hashes like bcrypt, Argon2, PBKDF2).</li>
          </ul>
        </div>
      </section>

      <!-- Ciphers -->
      <section class="card long-read" aria-labelledby="ciphers">
        <h2 id="ciphers" class="section-title">7. Ciphers — Block vs Stream & More</h2>
        <p>
          A cipher is a concrete algorithm for encryption/decryption. Modern ciphers are broadly classified as block ciphers and stream ciphers.
        </p>
        <div class="explain">
          <ul class="list">
            <li><strong>Block ciphers:</strong> operate on fixed-size blocks (AES: 128-bit block). Typically used in modes (CBC, GCM) that provide different guarantees (e.g., GCM provides authenticated encryption).</li>
            <li><strong>Stream ciphers:</strong> generate a keystream combined with plaintext (XOR). Examples: RC4 (deprecated), ChaCha20 (modern).</li>
            <li><strong>Authenticated encryption:</strong> modes like AES-GCM or ChaCha20-Poly1305 provide both confidentiality and integrity in one primitive — prefer authenticated encryption where possible.</li>
          </ul>
          <p class="small muted">Choosing the right mode/configuration matters: a strong cipher in a weak mode yields weak security (e.g., AES in ECB mode leaks structure and shouldn't be used).</p>
        </div>
      </section>

      <!-- PKI -->
      <section class="card long-read" aria-labelledby="pki">
        <h2 id="pki" class="section-title">8. Public Key Infrastructure (PKI)</h2>
        <p>
          PKI is the system of keys, certificates, and Certificate Authorities (CAs) that allows entities to prove their identity and exchange keys securely.
        </p>
        <div class="explain">
          <ul class="list">
            <li><strong>Certificates:</strong> digital documents binding public keys to identities (X.509 format is standard for TLS).</li>
            <li><strong>Certificate Authorities (CAs):</strong> trusted third parties that issue and sign certificates (e.g., Let's Encrypt, DigiCert).</li>
            <li><strong>Chain of trust:</strong> browsers trust a set of root CAs — chains from leaf certificates up to trusted roots validate identities.</li>
          </ul>
          <p class="small muted">Best practices: short certificate lifetimes, automated renewal (Let's Encrypt/ACME), enforce certificate pinning where appropriate, and monitor certificate transparency logs for unexpected issuance.</p>
        </div>

        <h3>How PKI is used in TLS (brief)</h3>
        <ol class="list">
          <li>Client connects to server and receives server certificate.</li>
          <li>Client verifies certificate chain up to a trusted CA and checks validity (expiry, revocation).</li>
          <li>Using asymmetric crypto, the client and server establish a symmetric session key (handshake).</li>
          <li>All further communication uses symmetric encryption for performance.</li>
        </ol>
      </section>

      <!-- Attacks -->
      <section class="card long-read" aria-labelledby="attacks">
        <h2 id="attacks" class="section-title">9. Attacks on Cryptosystems</h2>

        <h3>Passive attacks</h3>
        <p>Goal: obtain information without altering it — e.g., sniffing network traffic.</p>

        <h3>Active attacks</h3>
        <p>Goal: modify, inject, replay, or destroy messages — e.g., tampering, man-in-the-middle (MitM), DoS.</p>

        <h3>Cryptanalysis & attack models</h3>
        <div class="explain">
          <ul class="list">
            <li><strong>Ciphertext-only attack (COA):</strong> attacker has ciphertexts and tries to deduce plaintext or key (classic codebreaking scenario).</li>
            <li><strong>Known-plaintext attack (KPA):</strong> attacker knows some plaintext and corresponding ciphertext — helpful to deduce key.</li>
            <li><strong>Chosen-plaintext attack (CPA):</strong> attacker can encrypt chosen plaintexts and observe ciphertexts (relevant to evaluating algorithms).</li>
            <li><strong>Chosen-ciphertext attack (CCA):</strong> attacker can decrypt chosen ciphertexts (strong security notion; CCA-resistance matters for many protocols).</li>
            <li><strong>Brute-force attacks:</strong> try all possible keys — key length determines feasibility (e.g., 128-bit symmetric keys are infeasible to brute-force today).</li>
            <li><strong>Side-channel attacks:</strong> exploit physical leakages (timing, power, electromagnetic emissions) — require implementation defenses (constant-time code, shielding).</li>
            <li><strong>Replay attacks:</strong> re-sending valid messages to cause unintended actions — mitigated by nonces, timestamps, or sequence numbers.</li>
          </ul>
        </div>

        <div class="callout warn">
          <strong>Real-world note:</strong> Many practical breaks are due to implementation mistakes (poor RNG, reused nonces, weak key storage), not broken math of the algorithms themselves.
        </div>
      </section>

      <!-- Crypto + Cybersecurity -->
      <section class="card long-read" aria-labelledby="integration">
        <h2 id="integration" class="section-title">10. Cryptography + Cybersecurity</h2>
        <p>
          Cryptography is a foundational tool in a security engineer’s toolbox. It underpins secure communications, authentication, integrity verification and many compliance requirements.
        </p>
        <div class="explain">
          <strong>Practical examples:</strong>
          <ul class="list">
            <li><strong>ATM & payment systems:</strong> PINs and card data are protected using symmetric encryption and MACs in standards like EMV.</li>
            <li><strong>Web security:</strong> TLS provides confidentiality and integrity for HTTP traffic — always prefer modern TLS versions and strong cipher suites.</li>
            <li><strong>Password handling:</strong> store salted+hashed passwords with slow hashes (Argon2, bcrypt).</li>
            <li><strong>Code signing:</strong> ensures software packages are from an authentic source and not tampered with (package managers use this).</li>
            <li><strong>Blockchain:</strong> uses hashing and digital signatures to secure transactions and immutability guarantees.</li>
          </ul>
          <p class="small muted">Cryptography reduces risk but does not replace good practice: access control, monitoring, secure coding and incident response remain essential.</p>
        </div>
      </section>

      <!-- Labs -->
      <section class="card long-read" aria-labelledby="labs">
        <h2 id="labs" class="section-title">11. Hands-on Labs & Exercises</h2>
        <p>Exercises to solidify conceptual understanding and practical skills.</p>
        <div class="explain">
          <ul class="list">
            <li><strong>1) Caesar & substitution ciphers:</strong> implement enc/dec in a short script (Python/JS) to understand basic transforms.</li>
            <li><strong>2) Hash experiment:</strong> compute SHA-256 for files, alter files, and observe hash changes. Use salted password hashes vs raw hashes to see why salt matters.</li>
            <li><strong>3) TLS inspection:</strong> use <code>openssl s_client -connect example.com:443</code> to view certificates and handshake details.</li>
            <li><strong>4) Generate keys & sign:</strong> create an RSA or ECDSA key pair with OpenSSL, sign a message/file, and verify it.</li>
            <li><strong>5) PKI lab:</strong> set up a small CA with OpenSSL, issue a server certificate, and configure a local web server (Nginx) with your cert.</li>
            <li><strong>6) Side-channel awareness:</strong> time simple operations and learn why constant-time implementations matter (use libraries that provide constant-time primitives).</li>
          </ul>
        </div>
      </section>

      <!-- Extra references -->
      <section class="card long-read" aria-labelledby="references">
        <h2 id="references" class="section-title">12. References & Further Reading</h2>
        <ul class="list">
          <li>NIST Cryptographic Standards (SP 800-series)</li>
          <li>RFCs for TLS (RFC 8446 for TLS 1.3)</li>
          <li>Applied Cryptography by Bruce Schneier (classic reference)</li>
          <li>Modern Applied Cryptography resources and libraries (libsodium for high-level primitives)</li>
        </ul>
        <div class="explain">If you plan to build production systems, rely on vetted libraries and standards — avoid designing your own cryptographic protocols.</div>
      </section>

      <!-- Download -->
      <section class="card" aria-labelledby="share">
        <h2 id="share" class="section-title">Download / Share</h2>
        <p class="small muted">You can download these expanded cryptography notes or copy them as Markdown for your LMS or handouts.</p>
        <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
          <button class="btn primary" id="downloadNotes">📥 Download Notes (Text)</button>
          <button class="btn" id="copyMarkdown">📋 Copy Markdown</button>
        </div>
      </section>

    </article>

    <footer class="container">
      <p>© Learning Playground – Cryptography • Lesson 3 (Expanded)</p>
    </footer>
  </main>

  <!-- TTS Control Bar -->
  <div id="ttsBar" class="tts-bar" aria-hidden="false">
    <button id="ttsPlay" title="Play">▶</button>
    <button id="ttsPause" class="small" title="Pause">⏸</button>
    <button id="ttsStop" class="small" title="Stop">⏹</button>

    <span class="label">Voice</span>
    <select id="ttsVoices" aria-label="Select voice"></select>

    <span class="label">Rate</span>
    <input id="ttsRate" type="range" min="0.6" max="2" step="0.1" value="1" />

    <span class="label">Pitch</span>
    <input id="ttsPitch" type="range" min="0.6" max="2" step="0.1" value="1" />

    <button id="ttsToggleAuto" class="small" title="Auto-read on load">A</button>
  </div>

  <script>
    /* Theme toggle (persist) */
    const themeBtn = document.getElementById('toggleTheme');
    const keyTheme = 'lesson3-theme';
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const applyTheme = (mode) => {
      if (mode === 'light') {
        document.documentElement.style.setProperty('--bg','#f7f9ff');
        document.documentElement.style.setProperty('--card','#ffffff');
        document.documentElement.style.setProperty('--text','#0b1220');
        document.documentElement.style.setProperty('--muted','#4a5875');
      } else {
        document.documentElement.style.setProperty('--bg','#0b1220');
        document.documentElement.style.setProperty('--card','#111a2e');
        document.documentElement.style.setProperty('--text','#e7eefc');
        document.documentElement.style.setProperty('--muted','#8aa0c3');
      }
    };
    const storedTheme = localStorage.getItem(keyTheme) || (prefersDark ? 'dark' : 'light');
    applyTheme(storedTheme);
    themeBtn.addEventListener('click', () => {
      const cur = localStorage.getItem(keyTheme) || storedTheme;
      const next = cur === 'dark' ? 'light' : 'dark';
      localStorage.setItem(keyTheme, next);
      applyTheme(next);
    });

    /* Download notes as text */
    document.getElementById('downloadNotes').addEventListener('click', () => {
      const title = 'Lesson3_Cryptography_Notes_Expanded.txt';
      const nodes = document.querySelectorAll('.lesson-content h1, .lesson-content h2, .lesson-content p, .lesson-content li');
      const lines = [];
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h1' || tag === 'h2') lines.push('\n' + n.innerText + '\n');
        else lines.push(n.innerText);
      });
      const content = lines.join('\n');
      const blob = new Blob([content], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = title; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
    });

    /* Copy Markdown */
    document.getElementById('copyMarkdown').addEventListener('click', async () => {
      const nodes = document.querySelectorAll('.lesson-content h1, .lesson-content h2, .lesson-content p, .lesson-content li');
      let md = '';
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h1') md += `# ${n.innerText}\n\n`;
        else if (tag === 'h2') md += `## ${n.innerText}\n\n`;
        else if (tag === 'li') md += `- ${n.innerText}\n`;
        else md += `${n.innerText}\n\n`;
      });
      try { await navigator.clipboard.writeText(md); alert('Copied lesson content as Markdown to clipboard.'); }
      catch(e){ alert('Could not copy to clipboard.'); }
    });

    /* TTS module (Web Speech API) */
    (function () {
      if (!('speechSynthesis' in window)) {
        console.warn('TTS not supported in this browser.');
        const bar = document.getElementById('ttsBar'); if (bar) bar.style.display = 'none';
        return;
      }

      const playBtn = document.getElementById('ttsPlay');
      const pauseBtn = document.getElementById('ttsPause');
      const stopBtn = document.getElementById('ttsStop');
      const voicesSelect = document.getElementById('ttsVoices');
      const rateInput = document.getElementById('ttsRate');
      const pitchInput = document.getElementById('ttsPitch');
      const autoBtn = document.getElementById('ttsToggleAuto');

      const lesson = document.querySelector('.lesson-content') || document.body;
      let utterance = null;
      let sentences = [];
      let currentIndex = 0;
      let readyVoices = [];

      const prefs = {
        voiceURI: localStorage.getItem('tts.voice') || '',
        rate: parseFloat(localStorage.getItem('tts.rate')) || 1,
        pitch: parseFloat(localStorage.getItem('tts.pitch')) || 1,
        auto: localStorage.getItem('tts.auto') === 'true' || false
      };
      rateInput.value = prefs.rate;
      pitchInput.value = prefs.pitch;
      autoBtn.style.opacity = prefs.auto ? '1' : '0.6';

      function populateVoices() {
        const voices = speechSynthesis.getVoices();
        readyVoices = voices;
        voicesSelect.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.voiceURI;
          opt.textContent = `${v.name} (${v.lang})${v.default ? ' — default' : ''}`;
          voicesSelect.appendChild(opt);
        });
        if (prefs.voiceURI) {
          const found = [...voices].find(v => v.voiceURI === prefs.voiceURI);
          if (found) voicesSelect.value = prefs.voiceURI;
        }
      }

      populateVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoices;
      }

      function getText() {
        if (!lesson) return document.body.innerText;
        const nodes = lesson.querySelectorAll('h1,h2,p,li');
        return Array.from(nodes).map(n => n.innerText.trim()).filter(Boolean).join('.\n');
      }

      function buildSentences(text) {
        return text.split(/(?<=[.?!])\s+/);
      }

      function speakFrom(index = 0) {
        const text = getText();
        sentences = buildSentences(text);
        currentIndex = index;
        if (currentIndex >= sentences.length) return;
        speakSentence(sentences[currentIndex]);
      }

      function speakSentence(sentence) {
        if (!sentence || sentence.trim() === '') {
          currentIndex++;
          if (currentIndex < sentences.length) speakSentence(sentences[currentIndex]);
          return;
        }
        cancel();

        utterance = new SpeechSynthesisUtterance(sentence);
        const voiceURI = voicesSelect.value || prefs.voiceURI;
        const selected = readyVoices.find(v => v.voiceURI === voiceURI) || readyVoices.find(v => v.default) || readyVoices[0];
        if (selected) utterance.voice = selected;
        utterance.rate = parseFloat(rateInput.value);
        utterance.pitch = parseFloat(pitchInput.value);

        utterance.onstart = () => highlightSentence(sentence);
        utterance.onend = () => {
          currentIndex++;
          if (currentIndex < sentences.length) {
            setTimeout(() => speakSentence(sentences[currentIndex]), 120);
          } else {
            clearHighlights();
          }
        };

        speechSynthesis.speak(utterance);
      }

      function cancel() {
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
      }
      function pause() { if (speechSynthesis.speaking) speechSynthesis.pause(); }
      function resume() { if (speechSynthesis.paused) speechSynthesis.resume(); }

      function highlightSentence(sentence) {
        clearHighlights();
        if (!lesson) return;
        const text = lesson.innerHTML;
        const safe = sentence.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').trim();
        if (!safe) return;
        const regex = new RegExp(safe);
        const newHtml = text.replace(regex, `<span class="tts-highlight">${sentence}</span>`);
        if (newHtml !== text) lesson.innerHTML = newHtml;
      }

      function clearHighlights() {
        if (!lesson) return;
        const highlights = lesson.querySelectorAll('.tts-highlight');
        highlights.forEach(el => {
          const txt = el.textContent;
          el.outerHTML = txt;
        });
      }

      playBtn.addEventListener('click', () => {
        if (speechSynthesis.paused) return resume();
        if (speechSynthesis.speaking) return;
        speakFrom(0);
        savePrefs();
      });
      pauseBtn.addEventListener('click', () => {
        if (speechSynthesis.speaking) pause();
        else if (speechSynthesis.paused) resume();
      });
      stopBtn.addEventListener('click', () => {
        cancel();
        clearHighlights();
      });
      voicesSelect.addEventListener('change', () => { savePrefs(); });
      rateInput.addEventListener('change', () => savePrefs());
      pitchInput.addEventListener('change', () => savePrefs());
      autoBtn.addEventListener('click', () => {
        prefs.auto = !prefs.auto;
        localStorage.setItem('tts.auto', prefs.auto);
        autoBtn.style.opacity = prefs.auto ? '1' : '0.6';
      });

      function savePrefs() {
        localStorage.setItem('tts.voice', voicesSelect.value || '');
        localStorage.setItem('tts.rate', rateInput.value);
        localStorage.setItem('tts.pitch', pitchInput.value);
      }

      function applySavedSettings() {
        rateInput.value = prefs.rate;
        pitchInput.value = prefs.pitch;
        if (prefs.voiceURI && voicesSelect.options.length) {
          voicesSelect.value = prefs.voiceURI;
        }
      }

      let attempts = 0;
      const voiceApplyInterval = setInterval(() => {
        if (speechSynthesis.getVoices().length) {
          populateVoices();
          applySavedSettings();
          clearInterval(voiceApplyInterval);
        } else if (attempts++ > 20) {
          applySavedSettings();
          clearInterval(voiceApplyInterval);
        }
      }, 300);

      window.addEventListener('load', () => {
        setTimeout(() => {
          if (prefs.auto) {
            try {
              speakFrom(0);
            } catch (e) {
              console.warn('Auto TTS blocked by browser, user must press Play to start.');
            }
          }
        }, 700);
      });

      window.__Lesson3TTS = { speakFrom, cancel, pause, resume, getText };

    })();
  </script>
</body>
</html>
