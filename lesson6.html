<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lesson 6 – Identity & Access Management (Expanded)</title>
  <meta name="description" content="Lesson 6: Identity & Access Management — deep dive: identities, authentication, authorization, federation, SSO, PAM, RBAC/ABAC, lifecycle, best practices and Linux hands-on." />
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#8aa0c3;
      --text:#e7eefc;
      --accent:#6ea8ff;
      --accent-2:#7ef0c1;
      --warn:#ffdf6e;
      --danger:#ff7e93;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Noto Sans,Helvetica,Arial}
    body{background:linear-gradient(135deg,#0b1220 0%,#101b34 100%);color:var(--text);-webkit-font-smoothing:antialiased}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(160%) blur(8px);background:rgba(11,18,32,0.75);border-bottom:1px solid rgba(255,255,255,0.06)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;font-weight:600;color:#0b1220;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:8px 12px;border-radius:999px;font-size:12px;text-transform:uppercase}
    .hero{padding:28px 20px 8px}
    .title{font-size:clamp(28px,4vw,40px);line-height:1.15;margin:4px 0 10px}
    .subtitle{color:var(--muted);font-size:15px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .chip{padding:6px 10px;background:rgba(255,255,255,0.04);border-radius:999px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .card{background:radial-gradient(140% 120% at 100% 0%,#132349 0%,var(--card) 45%);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-top:16px}
    .long-read{line-height:1.75;font-size:15px}
    .list{padding-left:18px}
    .list li{margin:8px 0}
    .small{font-size:13px;color:var(--muted)}
    .explain{margin-top:8px;background:rgba(0,0,0,0.18);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    .callout{background:linear-gradient(180deg,rgba(126,240,193,.04),rgba(126,240,193,.02));border:1px solid rgba(126,240,193,.08);padding:10px;border-radius:10px}
    .warn{background:linear-gradient(180deg,rgba(255,223,110,.04),rgba(255,223,110,.02));border:1px solid rgba(255,223,110,.08);padding:10px;border-radius:10px}
    .kbd{background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);font-family:monospace}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.03);cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0b1220;border:none}
    pre{white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);overflow:auto}
    footer{opacity:.7;font-size:13px;padding:30px 0 60px}

    /* TTS bar styles (responsive + compact support) */
    .tts-bar{position:fixed;right:18px;bottom:18px;z-index:9999;background:rgba(0,0,0,0.65);color:#00ffcc;padding:10px 12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6);font-family:'Share Tech Mono',monospace;display:flex;gap:8px;align-items:center;backdrop-filter:blur(6px);min-width:260px;transition:all .16s ease}
    .tts-bar button{background:linear-gradient(45deg,#ff0080,#7928ca);border:none;color:#fff;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer}
    .tts-bar select,.tts-bar input[type="range"]{background:rgba(255,255,255,0.06);color:#00ffcc;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:8px;font-family:inherit}
    .tts-highlight{background:rgba(0,255,200,0.12);padding:0 2px;border-radius:3px}
    @media (max-width:600px){.tts-bar{left:50%;transform:translateX(-50%);right:auto;bottom:12px;min-width:88%}}

    /* Mobile-only fixed "Back to lessons" button (avoids overlapping TTS) */
    .mobile-back-btn { display: none; }
    @media (max-width: 1024px) {
      .mobile-back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        position: fixed;
        left: 16px;
        bottom: calc(14px + env(safe-area-inset-bottom));
        z-index: 9998; /* below TTS (tts-bar uses 9999) so TTS remains on top */
        text-decoration: none;
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(255,255,255,0.98);
        color: #0b1220;
        font-weight: 700;
        box-shadow: 0 8px 28px rgba(2,6,23,0.36);
        -webkit-tap-highlight-color: transparent;
        transition: transform .12s ease, box-shadow .12s ease;
        pointer-events: auto;
        border: 1px solid rgba(0,0,0,0.06);
        backdrop-filter: blur(6px);
      }
      .mobile-back-btn:active { transform: translateY(1px); }
      .mobile-back-btn:focus { outline: 3px solid rgba(21,156,228,0.18); outline-offset: 2px; }
      .mobile-back-icon { font-size: 16px; line-height: 1; }
      .mobile-back-text { font-size: 14px; letter-spacing: .01em; }

      /* For narrow devices lift the back button above the TTS so there's no overlap */
      @media (max-width: 820px) {
        .mobile-back-btn {
          bottom: calc(14px + env(safe-area-inset-bottom) + 70px);
          left: 12px;
          padding: 9px 12px;
        }
      }
      @media (max-width: 420px) {
        .mobile-back-btn { left: 10px; padding: 9px 12px; bottom: calc(8px + env(safe-area-inset-bottom) + 70px); }
      }
    }

    /* Collapse control for TTS (compact mode) */
    #ttsCollapse {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:38px;
      height:38px;
      padding:6px 8px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
      background:linear-gradient(45deg,#ff0080,#7928ca);
      color:#fff;
    }
    .tts-controls{display:flex;gap:8px;align-items:center;flex-wrap:nowrap}
    .tts-bar[data-compact="true"]{min-width:58px;max-width:58px;padding:6px;border-radius:999px;gap:0}
    .tts-bar[data-compact="true"] .tts-controls{display:none}
    .tts-bar[data-compact="true"] #ttsCollapse{border-radius:999px;padding:8px;width:38px;height:38px}
    .tts-bar:focus-within{outline:3px solid rgba(21,156,228,0.12);outline-offset:2px}
  </style>
</head>
<body>
  <header>
    <div class="container header-row">
      <div style="display:flex;align-items:center;gap:12px">
        <span class="badge">Lesson 6</span>
        <div>
          <strong>Identity & Access Management — Deep Dive (Expanded)</strong>
          <div class="small muted">Concepts • Federation • SSO • PAM • RBAC/ABAC • Linux lab</div>
        </div>
      </div>
      <div>
        <button class="btn" id="toggleTheme" title="Toggle theme">🌗 Theme</button>
      </div>
    </div>
  </header>

  <main class="container">
    <article class="lesson-content">

      <section class="hero card">
        <h1 class="title">Identity & Access Management (IdAM) — Expanded Module</h1>
        <p class="subtitle">Comprehensive guide: concepts, protocols, lifecycle, secure design patterns, practical Linux user/group exercises and operational advice for production IAM.</p>
        <div class="chips">
          <span class="chip">IAM</span><span class="chip">SSO</span><span class="chip">SAML</span><span class="chip">OIDC</span><span class="chip">PAM</span>
        </div>
      </section>

      <!-- TOC -->
      <section class="card" aria-labelledby="toc">
        <h2 id="toc" class="section-title">Table of Content</h2>
        <ol class="list">
          <li>What is an IAM?</li>
          <li>What is an Identity?</li>
          <li>Authentication & factors</li>
          <li>Authorization, models & PoLP</li>
          <li>How IAM works (lifecycle, provisioning, federation)</li>
          <li>SSO, SAML, OAuth2, OpenID Connect</li>
          <li>Privileged Access Management (PAM)</li>
          <li>Password best practices & account recovery</li>
          <li>Identity theft — prevention & detection</li>
          <li>Hands-on: Linux users, groups, ACLs, sudo</li>
          <li>Monitoring, metrics & compliance</li>
        </ol>
      </section>

      <!-- What is IAM -->
      <section class="card long-read" aria-labelledby="whatiam">
        <h2 id="whatiam" class="section-title">What is an IAM?</h2>
        <p>
          Identity and Access Management (IAM) is the strategic combination of policies, processes, and technologies that ensures the right identities (people, services, devices) can access the right resources under the right conditions.
        </p>
        <div class="explain">
          <p class="small muted">IAM solves operational problems (account provisioning, password resets), security problems (least privilege, MFA enforcement), and compliance problems (auditable access logs, segregation of duties).</p>
          <p>In modern environments IAM is central — cloud platforms (AWS, Azure, GCP) expose IAM APIs; SaaS apps integrate via SAML/OIDC; enterprises link HR systems to automate lifecycle events (hire, role-change, exit).</p>
        </div>
      </section>

      <!-- Identity -->
      <section class="card long-read" aria-labelledby="identity">
        <h2 id="identity" class="section-title">What is an Identity?</h2>
        <p>
          A digital identity is a set of attributes (claims) that uniquely identify an entity. Attributes include usernames, emails, UIDs, device IDs, X.509 certificate subject, groups, roles, and contextual claims (location, device posture).
        </p>
        <div class="explain">
          <p class="small muted">An identity can be:</p>
          <ul class="list">
            <li>a person (employee, contractor)</li>
            <li>a service account (automation, CI/CD runner)</li>
            <li>a device (IoT sensor, server)</li>
            <li>a federated identity (Google account, Azure AD user)</li>
          </ul>
          <p>Design note: treat non-human identities with the same security rigor as humans — rotate keys, apply least privilege, assign lifecycle ownership.</p>
        </div>
      </section>

      <!-- Authentication -->
      <section class="card long-read" aria-labelledby="authn">
        <h2 id="authn" class="section-title">Authentication — proving who you are</h2>
        <p>
          Authentication verifies an identity. Modern authentication combines multiple factors, adaptive signals, and hardware-backed methods to reduce compromise risk.
        </p>

        <h3>Authentication factors</h3>
        <ul class="list">
          <li><strong>Knowledge:</strong> passwords, PINs — cheap but weakest.</li>
          <li><strong>Possession:</strong> TOTP apps, hardware keys (FIDO2/WebAuthn), smartcards — resistant to phishing when hardware-backed.</li>
          <li><strong>Inherence:</strong> biometrics (fingerprint, face) — convenient but require fallback and privacy care.</li>
          <li><strong>Location/Device posture:</strong> IP range, geolocation, MFA only from trusted device.</li>
        </ul>

        <h3>Adaptive & risk-based authentication</h3>
        <p class="small muted">Systems evaluate risk (new device, unusual location, rapid impossible travel) and can step up authentication (require MFA, block access, or prompt for revalidation).</p>

        <div class="callout">
          <strong>Recommendation:</strong> prefer phishing-resistant MFA (FIDO2 / hardware tokens). Avoid SMS-based MFA for high-value accounts — SMS can be intercepted or SIM-swapped.
        </div>
      </section>

      <!-- Authorization -->
      <section class="card long-read" aria-labelledby="authz">
        <h2 id="authz" class="section-title">Authorization — determining what you can do</h2>
        <p>
          Authorization maps identities to permissions using roles, groups, attributes, and policies. It enforces access control at resource, API, and data levels.
        </p>

        <h3>Models</h3>
        <ul class="list">
          <li><strong>RBAC (Role-Based Access Control):</strong> roles simplify assignment (e.g., "HR-Analyst" role has read access to payroll). Works well when job functions map cleanly to permissions.</li>
          <li><strong>ABAC (Attribute-Based Access Control):</strong> policy decisions use attributes — user.department == "Engineering" AND resource.sensitivity != "High" AND request.time in business-hours.</li>
          <li><strong>PBAC (Policy-Based Access Control):</strong> centralized policy engines (OPA, XACML) evaluate complex rules.</li>
        </ul>

        <div class="explain">
          <p class="small muted">Hybrid approaches are common — RBAC for coarse control, ABAC for exceptions and contextual rules. Always enforce separation of duties for sensitive workflows (e.g., developer cannot deploy to production without approval).</p>
        </div>
      </section>

      <!-- How IAM works -->
      <section class="card long-read" aria-labelledby="how">
        <h2 id="how" class="section-title">How IAM Works — lifecycle & components</h2>
        <ol class="list">
          <li><strong>Provisioning:</strong> create account, set initial roles/groups, issue credentials.</li>
          <li><strong>Authentication:</strong> verify credentials & factors (SSO, MFA).</li>
          <li><strong>Authorization:</strong> policy check to allow/deny actions.</li>
          <li><strong>Session management:</strong> tokens, expiry, refresh and revocation.</li>
          <li><strong>Attestation / Access certification:</strong> periodic review of who has access and why.</li>
          <li><strong>De-provisioning:</strong> remove access when role changes or employee leaves.</li>
        </ol>

        <h3>Important protocols & standards</h3>
        <ul class="list">
          <li><strong>SCIM</strong> — automates user provisioning between HR/IdP and apps.</li>
          <li><strong>SAML</strong> — XML-based federation used for enterprise SSO.</li>
          <li><strong>OAuth2</strong> — delegated authorization for APIs.</li>
          <li><strong>OpenID Connect (OIDC)</strong> — identity layer on top of OAuth2 for authentication.</li>
        </ul>

        <div class="explain">
          <p class="small muted">Design tip: integrate HR/Identity Source of Truth (HRIS) with IAM to automate lifecycle events and reduce orphaned accounts.</p>
        </div>
      </section>

      <!-- SSO and Protocols -->
      <section class="card long-read" aria-labelledby="sso">
        <h2 id="sso" class="section-title">SSO, Federation & Protocols (SAML / OAuth2 / OIDC)</h2>
        <p>
          Single Sign-On (SSO) reduces credential fatigue and centralizes authentication. Federation allows identities from one domain (IdP) to access resources in another domain (SP).
        </p>

        <h3>SAML (Security Assertion Markup Language)</h3>
        <p class="small muted">SAML issues assertions (XML) from an Identity Provider (IdP) to a Service Provider (SP) asserting the user identity and attributes. Common in enterprise web SSO.</p>

        <h3>OAuth2 & OIDC</h3>
        <p class="small muted">OAuth2 issues tokens for delegated access (e.g., apps accessing APIs on a user's behalf). OIDC sits on OAuth2 to provide user identity (ID Token) suitable for modern web & mobile apps.</p>

        <div class="callout">
          <strong>Operational reminder:</strong> rotate signing keys, monitor token usage, set short token lifetimes and use refresh tokens with caution (tied to client security).
        </div>
      </section>

      <!-- PAM -->
      <section class="card long-read" aria-labelledby="pam">
        <h2 id="pam" class="section-title">Privileged Access Management (PAM)</h2>
        <p>
          PAM focuses on securing elevated accounts (root, admin, service accounts). Privileged actions are high-risk and require tighter controls: session recording, just-in-time access, approval workflows, and vaulting of secrets.
        </p>
        <ul class="list">
          <li>Use a secrets vault (HashiCorp Vault, AWS Secrets Manager) instead of plaintext credentials.</li>
          <li>Require session recording and approval for sensitive operations.</li>
          <li>Implement just-in-time (JIT) elevation: grant temporary privileges for a limited window.</li>
        </ul>
      </section>

      <!-- Passwords & Recovery -->
      <section class="card long-read" aria-labelledby="pw">
        <h2 id="pw" class="section-title">Password Best Practices & Account Recovery</h2>
        <ul class="list">
          <li>Use passphrases or long random passwords (>12–16 chars).</li>
          <li>Server-side: store only salted, memory-hard hashes (Argon2, bcrypt with proper parameters).</li>
          <li>Encourage password managers and block reused or breached passwords (integrate with breach databases).</li>
          <li>Account recovery must be secure: avoid weak fallbacks (mother's maiden name). Employ multi-step recovery and human checks for high-risk accounts.</li>
        </ul>
        <div class="explain">
          <p class="small muted">Usability: long complex passwords + password manager + MFA offers high security with acceptable user experience. Avoid excessive forced rotation unless compromise suspected.</p>
        </div>
      </section>

      <!-- Identity theft -->
      <section class="card long-read" aria-labelledby="theft">
        <h2 id="theft" class="section-title">Identity Theft — detection & mitigation</h2>
        <p>
          Identity theft uses stolen identifiers to impersonate victims. Early detection (anomaly detection, unusual transactions) and strong prevention (encryption, MFA) reduce impact.
        </p>
        <ul class="list">
          <li>Monitor for credential leaks and block compromised credentials.</li>
          <li>Use behavioral analytics to detect account takeover (impossible travel, new device with fresh cookies).</li>
          <li>Educate users about phishing, social engineering and safe handling of PII.</li>
        </ul>
      </section>

      <!-- Monitoring & Metrics -->
      <section class="card long-read" aria-labelledby="metrics">
        <h2 id="metrics" class="section-title">Monitoring, Metrics & Compliance</h2>
        <p>
          IAM programs should be measurable. Key metrics:
        </p>
        <ul class="list">
          <li>Time-to-provision and time-to-deprovision</li>
          <li>Percentage of accounts with MFA enabled</li>
          <li>Number of privileged accounts and JIT elevation events</li>
          <li>Number of orphaned accounts found during audits</li>
          <li>Number of failed login attempts and account lockouts</li>
        </ul>
        <div class="explain">
          <p class="small muted">Audit logs should be tamper-evident and retained per policy for compliance (e.g., SOX, PCI, HIPAA). Regularly run access certification campaigns.</p>
        </div>
      </section>

      <!-- Hands-on: Linux -->
      <section class="card long-read" aria-labelledby="lab">
        <h2 id="lab" class="section-title">Hands-On: Linux Users, Groups, ACLs, Sudo (Expanded)</h2>

        <p>Below is a step-by-step lab. Run in a disposable VM (Ubuntu/Debian) — do NOT run on production systems.</p>

        <div class="warn"><strong>Lab safety:</strong> this is destructive to test accounts; use snapshots and isolate network access.</div>

        <h3>1) Create groups</h3>
        <pre><code class="kbd">sudo groupadd securityTeam
sudo groupadd softwareTeam
# verify
getent group securityTeam
getent group softwareTeam</code></pre>

        <h3>2) Create users with home directories</h3>
        <pre><code class="kbd">sudo useradd -m -s /bin/bash user1
sudo useradd -m -s /bin/bash user2
sudo useradd -m -s /bin/bash user3
sudo useradd -m -s /bin/bash user4
# set passwords
sudo passwd user1
sudo passwd user2
sudo passwd user3
sudo passwd user4</code></pre>

        <h3>3) Add users to groups (append safely)</h3>
        <pre><code class="kbd">sudo usermod -aG securityTeam user1
sudo usermod -aG securityTeam user2
sudo usermod -aG softwareTeam user3
sudo usermod -aG softwareTeam user4
# verify membership
id user2
groups user2</code></pre>

        <h3>4) Create a file as user1 and change group</h3>
        <pre><code class="kbd">sudo -i -u user1 bash
echo "This is the file created by user1" &gt; /home/user1/user1file.txt
ls -l /home/user1/user1file.txt
# change file group to securityTeam
chgrp securityTeam /home/user1/user1file.txt
ls -l /home/user1/user1file.txt
exit</code></pre>

        <h3>5) Grant group write permission</h3>
        <pre><code class="kbd"># grant group write so other securityTeam members can edit
sudo chmod g+w /home/user1/user1file.txt
ls -l /home/user1/user1file.txt
# expected: -rw-rw-r--  user1 securityTeam</code></pre>

        <h3>6) Test editing as user2</h3>
        <pre><code class="kbd">sudo -i -u user2 bash
# copy file locally to show editing overwrites vs append
cp /home/user1/user1file.txt /home/user2
echo "Edited by user2 on $(date)" >> /home/user1/user1file.txt
cat /home/user1/user1file.txt
exit</code></pre>

        <h3>7) Ownership vs permissions vs ACLs</h3>
        <pre><code class="kbd"># change owner (if required)
sudo chown user1:securityTeam /home/user1/user1file.txt

# view ACLs (Access Control Lists)
getfacl /home/user1/user1file.txt

# give explicit ACL so user2 has rw even if group perms change
sudo setfacl -m u:user2:rw /home/user1/user1file.txt
getfacl /home/user1/user1file.txt</code></pre>

        <h3>8) Sudoers & delegated admin</h3>
        <pre><code class="kbd"># create a securityAdmin group and allow sudo for specific commands
sudo groupadd securityAdmin
sudo usermod -aG securityAdmin youradminuser

# add a rule using visudo (safer)
sudo EDITOR='tee -a' visudo <<'EOF'
%securityAdmin ALL=(ALL) /usr/bin/systemctl, /usr/bin/journalctl, /usr/bin/sshd
EOF

# verify sudo: run as a securityAdmin member
sudo -l</code></pre>

        <h3>9) Cleanup (lab)</h3>
        <pre><code class="kbd"># remove users and optionally home directories
sudo deluser --remove-home user1 || sudo userdel -r user1
sudo deluser --remove-home user2
sudo deluser --remove-home user3
sudo deluser --remove-home user4
# remove groups
sudo groupdel securityTeam
sudo groupdel softwareTeam
sudo groupdel securityAdmin</code></pre>

        <div class="explain">
          <p class="small muted">Notes:
            <ul>
              <li>Many distros provide <code>adduser</code> wrapper that's friendlier than <code>useradd</code>. Use distro guidance.</li>
              <li>ACLs provide per-user allowances beyond the standard owner/group/other model. Use <code>setfacl</code> / <code>getfacl</code> when you need finer control.</li>
              <li>In production, use directory services (LDAP/AD/FreeIPA) and centralized provisioning (SCIM) rather than ad-hoc Linux accounts.</li>
            </ul>
          </p>
        </div>
      </section>

      <!-- governance -->
      <section class="card long-read" aria-labelledby="governance">
        <h2 id="governance" class="section-title">Governance, Compliance & Policies</h2>
        <p>
          IAM implementations should be guided by policies: account lifecycle rules, privileged access reviews, acceptable use, and incident response. Map IAM controls to compliance frameworks relevant to your industry (PCI, HIPAA, SOX, GDPR).
        </p>
        <div class="explain">
          <p class="small muted">Practical governance actions: schedule quarterly access reviews, define SOD (segregation of duties) rules, maintain tamper-evident logs, and require MFA for all privileged roles.</p>
        </div>
      </section>

      <!-- final -->
      <section class="card long-read" aria-labelledby="final">
        <h2 id="final" class="section-title">Final Recommendations & Next Steps</h2>
        <ul class="list">
          <li>Enable MFA for all accounts; prefer hardware-backed tokens (FIDO2) for admins.</li>
          <li>Automate provisioning/deprovisioning via SCIM + HR integration.</li>
          <li>Use short-lived credentials for automation (use roles & temporary tokens).</li>
          <li>Implement PAM for elevated accounts and secrets vaulting for service credentials.</li>
          <li>Measure and report IAM KPIs regularly and run access certification campaigns.</li>
        </ul>
      </section>

      <section class="card" aria-labelledby="download">
        <h2 id="download" class="section-title">Download / Export</h2>
        <p class="small muted">Download expanded lesson notes or copy Markdown for your LMS.</p>
        <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
          <button class="btn primary" id="downloadNotes">📥 Download Notes (Text)</button>
          <button class="btn" id="copyMarkdown">📋 Copy Markdown</button>
        </div>
      </section>

    </article>

    <footer class="container">
      <p>© Learning Playground – Identity & Access Management • Lesson 6 (Expanded)</p>
    </footer>
  </main>

  <!-- Mobile Back button (mobile & tablet only) -->
  <a href="cyber-index.html" class="mobile-back-btn" aria-label="Back to lessons (mobile)">
    <span class="mobile-back-icon" aria-hidden="true">◀</span>
    <span class="mobile-back-text">Lessons</span>
  </a>

  <!-- TTS Bar (responsive + collapsible) -->
  <div id="ttsBar" class="tts-bar" aria-hidden="false" data-compact="false" role="region" aria-label="Text to Speech Controls">
    <button id="ttsCollapse" title="Collapse/Expand TTS">≡</button>

    <div class="tts-controls" aria-hidden="false">
      <button id="ttsPlay" title="Play">▶</button>
      <button id="ttsPause" class="small" title="Pause">⏸</button>
      <button id="ttsStop" class="small" title="Stop">⏹</button>

      <span class="label">Voice</span>
      <select id="ttsVoices" aria-label="Select voice"></select>

      <span class="label">Rate</span>
      <input id="ttsRate" type="range" min="0.6" max="2" step="0.1" value="1" />

      <span class="label">Pitch</span>
      <input id="ttsPitch" type="range" min="0.6" max="2" step="0.1" value="1" />

      <button id="ttsToggleAuto" class="small" title="Auto-read on load">A</button>
    </div>
  </div>

  <script>
    /* Theme toggle */
    const themeBtn = document.getElementById('toggleTheme');
    const keyTheme = 'lesson6-theme';
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const applyTheme = (mode) => {
      if (mode === 'light') {
        document.documentElement.style.setProperty('--bg','#f7f9ff');
        document.documentElement.style.setProperty('--card','#ffffff');
        document.documentElement.style.setProperty('--text','#0b1220');
        document.documentElement.style.setProperty('--muted','#4a5875');
      } else {
        document.documentElement.style.setProperty('--bg','#0b1220');
        document.documentElement.style.setProperty('--card','#111a2e');
        document.documentElement.style.setProperty('--text','#e7eefc');
        document.documentElement.style.setProperty('--muted','#8aa0c3');
      }
    };
    const storedTheme = localStorage.getItem(keyTheme) || (prefersDark ? 'dark' : 'light');
    applyTheme(storedTheme);
    themeBtn.addEventListener('click', () => {
      const cur = localStorage.getItem(keyTheme) || storedTheme;
      const next = cur === 'dark' ? 'light' : 'dark';
      localStorage.setItem(keyTheme, next);
      applyTheme(next);
    });

    /* Download notes */
    document.getElementById('downloadNotes').addEventListener('click', () => {
      const title = 'Lesson6_IdAM_Notes_Expanded.txt';
      const nodes = document.querySelectorAll('.lesson-content h1, .lesson-content h2, .lesson-content p, .lesson-content li, .lesson-content pre');
      const lines = [];
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h1' || tag === 'h2') lines.push('\n' + n.innerText + '\n');
        else lines.push(n.innerText);
      });
      const content = lines.join('\n');
      const blob = new Blob([content], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = title; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
    });

    /* Copy Markdown */
    document.getElementById('copyMarkdown').addEventListener('click', async () => {
      const nodes = document.querySelectorAll('.lesson-content h1, .lesson-content h2, .lesson-content p, .lesson-content li, .lesson-content pre');
      let md = '';
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h1') md += `# ${n.innerText}\n\n`;
        else if (tag === 'h2') md += `## ${n.innerText}\n\n`;
        else if (tag === 'li') md += `- ${n.innerText}\n`;
        else if (tag === 'pre') md += '```\n' + n.innerText + '\n```\n\n';
        else md += `${n.innerText}\n\n`;
      });
      try { await navigator.clipboard.writeText(md); alert('Copied lesson content as Markdown to clipboard.'); }
      catch(e){ alert('Could not copy to clipboard.'); }
    });

    /* TTS module using Web Speech API (preserves your original behaviour) */
    (function () {
      if (!('speechSynthesis' in window)) {
        console.warn('TTS not supported in this browser.');
        const bar = document.getElementById('ttsBar'); if (bar) bar.style.display = 'none';
        return;
      }
      const playBtn = document.getElementById('ttsPlay');
      const pauseBtn = document.getElementById('ttsPause');
      const stopBtn = document.getElementById('ttsStop');
      const voicesSelect = document.getElementById('ttsVoices');
      const rateInput = document.getElementById('ttsRate');
      const pitchInput = document.getElementById('ttsPitch');
      const autoBtn = document.getElementById('ttsToggleAuto');
      const lesson = document.querySelector('.lesson-content') || document.body;

      let utterance = null, sentences = [], currentIndex = 0, readyVoices = [];
      const prefs = {
        voiceURI: localStorage.getItem('tts.voice') || '',
        rate: parseFloat(localStorage.getItem('tts.rate')) || 1,
        pitch: parseFloat(localStorage.getItem('tts.pitch')) || 1,
        auto: localStorage.getItem('tts.auto') === 'true' || false
      };
      rateInput.value = prefs.rate;
      pitchInput.value = prefs.pitch;
      autoBtn.style.opacity = prefs.auto ? '1' : '0.6';

      function populateVoices() {
        const voices = speechSynthesis.getVoices();
        readyVoices = voices;
        voicesSelect.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.voiceURI;
          opt.textContent = `${v.name} (${v.lang})${v.default ? ' — default' : ''}`;
          voicesSelect.appendChild(opt);
        });
        if (prefs.voiceURI) {
          const found = [...voices].find(v => v.voiceURI === prefs.voiceURI);
          if (found) voicesSelect.value = prefs.voiceURI;
        }
      }
      populateVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateVoices;

      function getText() {
        const nodes = lesson.querySelectorAll('h1,h2,p,li,pre');
        return Array.from(nodes).map(n => n.innerText.trim()).filter(Boolean).join('.\n');
      }
      function buildSentences(text) { return text.split(/(?<=[.?!])\s+/); }

      function speakFrom(index = 0) {
        const text = getText();
        sentences = buildSentences(text);
        currentIndex = index;
        if (currentIndex >= sentences.length) return;
        speakSentence(sentences[currentIndex]);
      }
      function speakSentence(sentence) {
        if (!sentence || sentence.trim() === '') { currentIndex++; if (currentIndex < sentences.length) speakSentence(sentences[currentIndex]); return; }
        cancel();
        utterance = new SpeechSynthesisUtterance(sentence);
        const voiceURI = voicesSelect.value || prefs.voiceURI;
        const selected = readyVoices.find(v => v.voiceURI === voiceURI) || readyVoices.find(v => v.default) || readyVoices[0];
        if (selected) utterance.voice = selected;
        utterance.rate = parseFloat(rateInput.value);
        utterance.pitch = parseFloat(pitchInput.value);
        utterance.onstart = () => highlightSentence(sentence);
        utterance.onend = () => {
          currentIndex++;
          if (currentIndex < sentences.length) setTimeout(()=>speakSentence(sentences[currentIndex]), 120);
          else clearHighlights();
        };
        speechSynthesis.speak(utterance);
      }
      function cancel(){ if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel(); }
      function pause(){ if (speechSynthesis.speaking) speechSynthesis.pause(); }
      function resume(){ if (speechSynthesis.paused) speechSynthesis.resume(); }

      function highlightSentence(sentence) {
        clearHighlights();
        const text = lesson.innerHTML;
        const safe = sentence.replace(/[.*+?^${}()|[\]\\]/g,'\\$&').trim();
        if (!safe) return;
        const regex = new RegExp(safe);
        const newHtml = text.replace(regex, `<span class="tts-highlight">${sentence}</span>`);
        if (newHtml !== text) lesson.innerHTML = newHtml;
      }
      function clearHighlights() {
        const highlights = lesson.querySelectorAll('.tts-highlight');
        highlights.forEach(el => { const txt = el.textContent; el.outerHTML = txt; });
      }

      playBtn.addEventListener('click', () => { if (speechSynthesis.paused) return resume(); if (speechSynthesis.speaking) return; speakFrom(0); savePrefs(); });
      pauseBtn.addEventListener('click', () => { if (speechSynthesis.speaking) pause(); else if (speechSynthesis.paused) resume(); });
      stopBtn.addEventListener('click', () => { cancel(); clearHighlights(); });
      voicesSelect.addEventListener('change', savePrefs);
      rateInput.addEventListener('change', savePrefs);
      pitchInput.addEventListener('change', savePrefs);
      autoBtn.addEventListener('click', () => { prefs.auto = !prefs.auto; localStorage.setItem('tts.auto', prefs.auto); autoBtn.style.opacity = prefs.auto ? '1' : '0.6'; });

      function savePrefs() {
        localStorage.setItem('tts.voice', voicesSelect.value || '');
        localStorage.setItem('tts.rate', rateInput.value);
        localStorage.setItem('tts.pitch', pitchInput.value);
      }

      function applySavedSettings() {
        rateInput.value = prefs.rate;
        pitchInput.value = prefs.pitch;
        if (prefs.voiceURI && voicesSelect.options.length) voicesSelect.value = prefs.voiceURI;
      }

      let attempts = 0;
      const voiceApplyInterval = setInterval(() => {
        if (speechSynthesis.getVoices().length) { populateVoices(); applySavedSettings(); clearInterval(voiceApplyInterval); }
        else if (attempts++ > 20) { applySavedSettings(); clearInterval(voiceApplyInterval); }
      }, 300);

      window.addEventListener('load', () => {
        setTimeout(() => { if (prefs.auto) { try { speakFrom(0); } catch(e) { console.warn('Auto TTS blocked'); } } }, 700);
      });

      window.__Lesson6TTS = { speakFrom, cancel, pause, resume, getText };
    })();

    /* Responsive TTS: compact/expand toggle (keeps TTS IDs intact) */
    (function () {
      const BAR_KEY = 'lesson6.ttsCompact';
      const ttsBar = document.getElementById('ttsBar');
      const collapseBtn = document.getElementById('ttsCollapse');

      if (!ttsBar || !collapseBtn) return;

      // Initialize from saved preference or default for small screens
      const saved = localStorage.getItem(BAR_KEY);
      const shouldCompactDefault = window.matchMedia('(max-width:820px)').matches;
      const compact = (saved === null) ? shouldCompactDefault : (saved === 'true');

      ttsBar.setAttribute('data-compact', compact ? 'true' : 'false');

      function setCompact(flag) {
        ttsBar.setAttribute('data-compact', flag ? 'true' : 'false');
        localStorage.setItem(BAR_KEY, flag ? 'true' : 'false');
      }

      collapseBtn.addEventListener('click', (e) => {
        const cur = ttsBar.getAttribute('data-compact') === 'true';
        setCompact(!cur);
      });

      // If user hasn't chosen preference, auto-adjust on resize
      let userOverrode = saved !== null;
      window.addEventListener('resize', () => {
        if (userOverrode) return;
        const narrow = window.matchMedia('(max-width:820px)').matches;
        setCompact(narrow);
      });
    })();
  </script>
</body>
</html>
