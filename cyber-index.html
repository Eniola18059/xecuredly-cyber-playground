<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cybersecurity Course ‚Äî Lessons</title>

  <!-- Fonts + GSAP -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@300;600;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <style>
    :root{
      --bg-dark:#02040a;
      --bg-soft:#061528;
      --card:#071a2b;
      --muted:#91b4d9;
      --accent1:#00ffe7;
      --accent2:#57a7ff;
      --accent3:#ff7aee;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      --focus: 0 0 0 4px rgba(87,167,255,0.10);
      --max-w:1100px;
    }

    /* Reset & base */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Share Tech Mono",monospace;background:linear-gradient(180deg,var(--bg-dark),var(--bg-soft));color:var(--accent1);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--max-w);margin:0 auto;padding:20px}

    /* Top bar */
    header.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 0;position:sticky;top:0;background:linear-gradient(180deg, rgba(0,0,0,0.25), transparent);backdrop-filter:blur(6px);z-index:80}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent3),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#021024;font-size:20px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .title{font-weight:800;font-size:18px}
    .subtitle{font-size:12px;color:var(--muted)}

    /* controls */
    .controls{display:flex;gap:12px;align-items:center}
    .search{display:flex;align-items:center;gap:8px;background:var(--glass);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
    .search input{background:transparent;border:none;color:var(--accent1);outline:none;min-width:180px;font-size:14px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:var(--accent1);cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#021024;border:none;box-shadow:0 10px 32px rgba(0,160,255,0.08)}
    .toggle{background:rgba(255,255,255,0.03);border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:8px;font-size:13px}

    /* hero */
    .hero{display:flex;align-items:center;justify-content:space-between;gap:20px;margin-top:18px;padding:20px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.03)}
    .hero-left{max-width:64%}
    .hero h1{margin:0;font-size:clamp(24px,3.6vw,34px);line-height:1;letter-spacing:-0.01em}
    .hero p{margin:8px 0 0;color:var(--muted)}
    .hero-cta{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted);font-weight:800;font-size:12px}

    /* lesson grid */
    .grid-wrap{margin-top:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
      box-shadow:0 12px 40px rgba(0,0,0,0.5);
      transition:transform .36s cubic-bezier(.2,.9,.3,1), box-shadow .36s, background .36s;
      display:flex;flex-direction:column;gap:8px;position:relative;overflow:hidden;
    }
    .card:focus{outline:none;box-shadow:var(--focus)}
    .card:hover{transform:translateY(-8px);box-shadow:0 30px 80px rgba(0,0,0,0.6)}
    .card h3{margin:0;font-size:15px}
    .card p{margin:0;color:var(--muted);font-size:13px}
    .card .meta{display:flex;justify-content:space-between;align-items:center;margin-top:auto;gap:8px}
    .tag{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px;font-weight:800;color:var(--muted);font-size:12px}
    .visited{position:absolute;right:10px;top:8px;background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#021024;padding:6px 8px;border-radius:8px;font-weight:800;font-size:12px;box-shadow:0 8px 18px rgba(0,160,255,0.08)}

    /* floating neon accent */
    .neon { position:absolute;right:-120px;top:-30px;width:280px;height:280px;border-radius:50%;filter:blur(40px);opacity:0.07;background:radial-gradient(circle at 30% 30%, var(--accent2), transparent 35%);pointer-events:none; }

    /* footer */
    footer{margin-top:26px;padding:18px;border-radius:12px;background:rgba(255,255,255,0.01);display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}

    /* particle canvas */
    canvas#particles{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:0;opacity:0.9;mix-blend-mode:screen}

    /* floating home button & tts bar */
    .home-btn {
      position: fixed;
      left: 14px;
      bottom: 18px;
      z-index: 9999;
      background: linear-gradient(90deg,var(--accent2),var(--accent1));
      color:#021024;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      box-shadow:0 10px 30px rgba(0,0,0,0.45);
      display:flex;
      gap:8px;
      align-items:center;
      border:none;
      cursor:pointer;
    }
    .home-btn:active { transform:scale(.98) }

    .tts-bar {
      position: fixed;
      right: 14px;
      bottom: 16px;
      z-index: 9999;
      background: rgba(2,8,20,0.85);
      color: var(--accent1);
      padding:10px 12px;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,0.45);
      display:flex;
      gap:10px;
      align-items:center;
      min-width:280px;
      max-width:92%;
      backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,0.03);
    }
    .tts-bar .btn-tts { background:linear-gradient(90deg,var(--accent2),var(--accent1)); border:none; padding:8px 10px; border-radius:8px; color:#021024; font-weight:800; cursor:pointer;}
    .tts-bar select, .tts-bar input[type="range"] { background: rgba(255,255,255,0.03); color:var(--accent1); border:1px solid rgba(255,255,255,0.04); border-radius:8px; padding:6px; }
    .tts-mini { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    /* responsive */
    @media (max-width:880px){
      .hero-left{max-width:100%}
      .controls{flex-direction:column-reverse;align-items:flex-start;gap:10px}
      .hero{flex-direction:column;align-items:flex-start}
      .grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
      .tts-bar{min-width:220px; right:10px; left:10px; bottom:12px; justify-content:space-between}
      .home-btn{left:50%; transform:translateX(-50%); bottom:12px}
    }

    /* Light theme */
    .light { --bg-dark:#f5f8ff; --bg-soft:#eaf3ff; --card:#ffffff; --muted:#475569; --accent1:#003a7c; --accent2:#0ea5ff; --accent3:#ff66c4; color:var(--accent1); }
    .light .card { border-color: rgba(2,8,20,0.03); box-shadow: 0 8px 28px rgba(2,8,20,0.06); color:var(--accent1) }
    .light .search { background: rgba(2,8,20,0.03) }
    .light .btn { color:var(--accent1) }
    /* reduced motion */
    @media (prefers-reduced-motion: reduce){
      * { transition:none !important; animation:none !important; }
      canvas#particles { display:none; }
    }

    /* focus styles for keyboard */
    .card:focus-visible { box-shadow:var(--focus); transform:translateY(-6px) }

  </style>
</head>
<body>
  <canvas id="particles" aria-hidden="true"></canvas>

  <header class="topbar container" role="banner">
    <div class="brand" aria-hidden="false">
      <div class="logo" id="logo" aria-hidden="true">X</div>
      <div>
        <div class="title">Xecuredly ‚Äî Cybersecurity Course</div>
        <div class="subtitle">Hands-on lessons ‚Ä¢ TTS-ready modules ‚Ä¢ SOC & defensive tracks</div>
      </div>
    </div>

    <div class="controls" role="search">
      <div class="search" role="search" aria-label="Search lessons">
        <svg width="16" height="16" aria-hidden="true" viewBox="0 0 24 24" style="opacity:.8"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5z"/></svg>
        <input id="q" type="search" placeholder="Search lessons (e.g., 'malware', 'SOC')" aria-label="Search lessons">
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div class="toggle" id="themeToggle" role="button" tabindex="0" aria-pressed="false" title="Toggle theme">üåô Theme</div>
        <button class="btn primary" id="newLab">Launch Lab</button>
      </div>
    </div>
  </header>

  <main class="container" role="main">
    <section class="hero" aria-labelledby="heroTitle">
      <div class="hero-left">
        <div class="eyebrow badge">COURSE</div>
        <h1 id="heroTitle">Cybersecurity ‚Äî Full lesson suite</h1>
        <p>Pick a lesson to open the TTS-ready module, run labs, or take a quick quiz. Lessons include notes, quizzes and lab links.</p>

        <div class="hero-cta" aria-hidden="false">
          <a class="btn" id="allBtn" href="#all">All Lessons</a>
          <a class="btn" id="socsBtn" href="soc-index.html">SOC Track</a>
        </div>
      </div>

      <div style="position:relative;min-width:220px">
        <div class="hero-right" aria-hidden="true" style="padding:14px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:12px;border:1px solid rgba(255,255,255,0.03)">
          <div style="font-weight:800">Quick Links</div>
          <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
            <a class="btn" href="module_index.pdf" target="_blank" rel="noopener">Download Syllabus</a>
            <a class="btn" href="#labs">Open Labs</a>
            <a class="btn" href="#help">Support</a>
          </div>
        </div>
        <div class="neon" aria-hidden="true"></div>
      </div>
    </section>

    <section class="grid-wrap" id="all">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:18px">
        <h2 style="margin:0">Lessons</h2>
        <div style="color:var(--muted);font-size:13px">Click a lesson to open ‚Ä¢ visited lessons are tracked</div>
      </div>

      <div class="grid" id="lessonGrid" aria-live="polite" style="margin-top:12px">
        <!-- cards injected by JS -->
      </div>
    </section>

    <footer>
      <div>¬© Xecuredly ¬∑ Learn responsibly</div>
      <div style="display:flex;gap:12px">
        <a href="index.html" class="btn">Homepage</a>
        <a href="#contact" class="btn">Contact</a>
      </div>
    </footer>
  </main>

  <!-- floating home button (always visible on mobile & desktop) -->
  <a href="index.html" class="home-btn" aria-label="Return to homepage">üè† Home</a>

  <!-- TTS control bar -->
  <div id="ttsBar" class="tts-bar" role="region" aria-label="Text to Speech Controls">
    <div class="tts-mini" style="gap:8px;align-items:center">
      <button id="ttsPlay" class="btn-tts" title="Play">‚ñ∂</button>
      <button id="ttsPause" class="btn-tts" title="Pause">‚è∏</button>
      <button id="ttsStop" class="btn-tts" title="Stop">‚èπ</button>
    </div>

    <div class="tts-mini" style="flex:1;justify-content:flex-end;align-items:center">
      <label for="ttsVoices" class="small" style="font-size:12px;color:var(--muted);margin-right:6px">Voice</label>
      <select id="ttsVoices" aria-label="Select voice"></select>

      <label for="ttsRate" class="small" style="font-size:12px;color:var(--muted);margin-left:8px;margin-right:6px">Rate</label>
      <input id="ttsRate" type="range" min="0.6" max="2" step="0.1" value="1" />

      <label for="ttsPitch" class="small" style="font-size:12px;color:var(--muted);margin-left:8px;margin-right:6px">Pitch</label>
      <input id="ttsPitch" type="range" min="0.6" max="2" step="0.1" value="1" />

      <button id="ttsToggleAuto" class="btn" title="Auto-read on load" style="margin-left:8px;padding:6px 8px;font-weight:700">A</button>
    </div>
  </div>

  <script>
    // lessons data (intro to SOC removed per request)
    const lessons = [
      { id: 'lesson1', title: 'Lesson 1 ‚Äî Networking Basics', file: 'lesson1.html', tags: ['network','tcp'] },
      { id: 'lesson2', title: 'Lesson 2 ‚Äî Introduction to Linux', file: 'lesson2.html', tags: ['linux'] },
      { id: 'lesson3', title: 'Lesson 3 ‚Äî Recon & Footprinting', file: 'lesson3.html', tags: ['recon','osint'] },
      { id: 'lesson4', title: 'Lesson 4 ‚Äî Vulnerability Assessment', file: 'lesson4.html', tags: ['vuln','scanning'] },
      { id: 'lesson5', title: 'Lesson 5 ‚Äî System Hacking', file: 'lesson5.html', tags: ['hacking','privilege'] },
      { id: 'lesson6', title: 'Lesson 6 ‚Äî Malware Analysis', file: 'lesson6.html', tags: ['malware'] },
      { id: 'lesson7', title: 'Lesson 7 ‚Äî Vulnerability Assessment & System Hacking', file: 'lesson7.html', tags: ['vuln','hacking'] },
      { id: 'lesson8', title: 'Lesson 8 ‚Äî Malware & Sniffing', file: 'lesson8.html', tags: ['malware','sniffing'] },
      { id: 'lesson9', title: 'Lesson 9 ‚Äî DoS/DDoS & Session Hijacking', file: 'lesson9.html', tags: ['ddos','session'] },
      { id: 'lesson10', title: 'Lesson 10 ‚Äî Social Engineering', file: 'lesson10.html', tags: ['social','phishing'] },
      { id: 'lesson11', title: 'Lesson 11 ‚Äî Threat Detection & Response', file: 'lesson11.html', tags: ['siem','tdr'] }
    ];

    // render grid
    const grid = document.getElementById('lessonGrid');
    const visited = JSON.parse(localStorage.getItem('visitedLessons') || '{}');

    function render(filter='') {
      grid.innerHTML = '';
      const q = filter.trim().toLowerCase();
      const filtered = lessons.filter(l => !q || (l.title + ' ' + (l.tags||[]).join(' ')).toLowerCase().includes(q));
      if (filtered.length === 0) {
        const none = document.createElement('div');
        none.style.gridColumn = '1/-1';
        none.style.padding = '20px';
        none.style.color = 'var(--muted)';
        none.textContent = 'No lessons match your search.';
        grid.appendChild(none);
        return;
      }

      filtered.forEach((l, idx) => {
        const el = document.createElement('a');
        el.className = 'card';
        el.href = l.file;
        el.setAttribute('role','link');
        el.setAttribute('aria-label', l.title + ' ‚Äî open lesson');
        el.innerHTML = `
          ${visited[l.id] ? '<div class="visited">Visited</div>' : ''}
          <h3>${l.title}</h3>
          <p class="desc">Open the lesson page (<code>${l.file}</code>) with notes, TTS and quizzes.</p>
          <div class="meta">
            <div class="tag">${l.tags ? l.tags.slice(0,2).join(' ‚Ä¢ ') : 'Lesson'}</div>
            <div style="font-size:13px;color:var(--muted)">${String(idx+1).padStart(2,'0')}</div>
          </div>
        `;
        // mark visited on click (so user sees immediately)
        el.addEventListener('click', (ev) => {
          // allow ctrl/meta click to open in new tab
          if (ev.metaKey || ev.ctrlKey) return;
          ev.preventDefault();
          visited[l.id] = true;
          localStorage.setItem('visitedLessons', JSON.stringify(visited));
          // small burst animation when opening
          burstEffect(el);
          // slight delay to show animation then navigate
          setTimeout(()=> location.href = l.file, 260);
        });

        // keyboard support
        el.setAttribute('tabindex','0');
        el.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') el.click();
        });

        grid.appendChild(el);
      });

      // animate cards in (GSAP)
      if (window.gsap) {
        gsap.fromTo('.card', {y:15, opacity:0}, {y:0, opacity:1, stagger:0.06, duration:0.6, ease:'power2.out'});
      }
    }

    render();

    // search
    const qInput = document.getElementById('q');
    qInput.addEventListener('input', (e) => render(e.target.value));

    // simple burst effect
    function burstEffect(target) {
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const rect = target.getBoundingClientRect();
      const root = document.createElement('div');
      root.style.position = 'fixed';
      root.style.left = rect.left + rect.width/2 + 'px';
      root.style.top = rect.top + rect.height/2 + 'px';
      root.style.pointerEvents = 'none';
      root.style.zIndex = 9999;
      document.body.appendChild(root);

      const count = 12;
      for (let i=0;i<count;i++){
        const d = document.createElement('div');
        const size = 6 + Math.random()*8;
        d.style.width = d.style.height = size + 'px';
        d.style.borderRadius = '50%';
        d.style.position = 'absolute';
        d.style.left = '0px';
        d.style.top = '0px';
        d.style.background = Math.random()>0.5 ? 'linear-gradient(90deg,var(--accent2),var(--accent1))' : 'linear-gradient(90deg,var(--accent3),var(--accent2))';
        d.style.boxShadow = '0 8px 20px rgba(0,0,0,0.3)';
        root.appendChild(d);
        const angle = Math.random()*Math.PI*2;
        const dist = 40 + Math.random()*80;
        const tx = Math.cos(angle)*dist;
        const ty = Math.sin(angle)*dist;
        if (window.gsap) {
          gsap.to(d, { x: tx, y: ty, opacity:0, scale:0.4, duration:0.9 + Math.random()*0.6, ease:'power3.out', onComplete: ()=> d.remove() });
        } else {
          d.remove();
        }
      }
      setTimeout(()=> root.remove(), 1200);
    }

    // particle canvas (subtle)
    (function(){
      const canvas = document.getElementById('particles');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      let DPR = window.devicePixelRatio || 1;
      let W = innerWidth, H = innerHeight;
      canvas.width = W*DPR; canvas.height = H*DPR; ctx.setTransform(DPR,0,0,DPR,0,0);
      let parts = [];
      const n = Math.max(24, Math.floor(Math.min(W,1200)/48));
      function init(){
        parts = [];
        for (let i=0;i<n;i++){
          parts.push({
            x: Math.random()*W,
            y: Math.random()*H,
            r: Math.random()*2+0.6,
            vx: (Math.random()-0.5)*0.3,
            vy: -0.15 - Math.random()*0.6,
            hue: 180 + Math.random()*120,
            a: 0.06 + Math.random()*0.35
          });
        }
      }
      function resize(){ DPR = window.devicePixelRatio || 1; W = innerWidth; H = innerHeight; canvas.width = W*DPR; canvas.height = H*DPR; canvas.style.width = W+'px'; canvas.style.height = H+'px'; ctx.setTransform(DPR,0,0,DPR,0,0); init(); }
      function step(){
        ctx.clearRect(0,0,W,H);
        ctx.globalCompositeOperation = 'lighter';
        for (const p of parts){
          p.x += p.vx; p.y += p.vy;
          if (p.y < -20) p.y = H + 20;
          if (p.x < -40) p.x = W + 40;
          if (p.x > W + 40) p.x = -40;
          const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*10);
          g.addColorStop(0, `hsla(${p.hue},100%,62%,${p.a})`);
          g.addColorStop(0.5, `hsla(${p.hue+20},100%,55%,${p.a*0.3})`);
          g.addColorStop(1, 'rgba(0,0,0,0)');
          ctx.fillStyle = g;
          ctx.beginPath();
          ctx.arc(p.x,p.y,p.r*6,0,Math.PI*2);
          ctx.fill();
        }
        requestAnimationFrame(step);
      }
      window.addEventListener('resize', resize);
      resize(); step();
    })();

    // theme toggle (light/dark)
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(t){
      if (t === 'light') document.documentElement.classList.add('light');
      else document.documentElement.classList.remove('light');
      localStorage.setItem('site-theme', t);
      themeToggle.setAttribute('aria-pressed', String(t==='light'));
      themeToggle.textContent = t === 'light' ? '‚òÄÔ∏è Light' : 'üåô Dark';
    }
    // load saved theme
    const saved = localStorage.getItem('site-theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
    applyTheme(saved);

    themeToggle.addEventListener('click', () => {
      const cur = document.documentElement.classList.contains('light') ? 'light' : 'dark';
      applyTheme(cur === 'light' ? 'dark' : 'light');
    });
    themeToggle.addEventListener('keypress', (e)=> { if (e.key==='Enter' || e.key===' ') themeToggle.click(); });

    // quick lab button stub
    document.getElementById('newLab').addEventListener('click', (e) => {
      e.preventDefault();
      alert('Demo: Launching an isolated lab (stub). In production this would request and spin up a sandbox environment.');
    });

    // keyboard focus improvements: cycle search on "/" press
    window.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== qInput) {
        e.preventDefault();
        qInput.focus();
        qInput.select();
      }
    });

    // initial animation for header & hero
    if (window.gsap) {
      gsap.from('.logo', {scale:0.6, rotation:-8, duration:0.8, ease:'back.out(1.4)'});
      gsap.from('h1', {y:12, opacity:0, duration:0.7, delay:0.1});
      gsap.from('.hero p', {y:8, opacity:0, duration:0.6, delay:0.18});
      gsap.from('.card', {y:12, opacity:0, duration:0.6, stagger:0.04, delay:0.25});
    }

    // initial render (with possible search param)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('q')) qInput.value = urlParams.get('q');
    render(qInput.value || '');

    /* ---------------------------
       TTS (responsive, mobile friendly)
       --------------------------- */
    (function(){
      const ttsBar = document.getElementById('ttsBar');
      const playBtn = document.getElementById('ttsPlay');
      const pauseBtn = document.getElementById('ttsPause');
      const stopBtn = document.getElementById('ttsStop');
      const voicesSelect = document.getElementById('ttsVoices');
      const rateInput = document.getElementById('ttsRate');
      const pitchInput = document.getElementById('ttsPitch');
      const autoBtn = document.getElementById('ttsToggleAuto');

      if (!('speechSynthesis' in window)) {
        // Hide TTS when unsupported
        if (ttsBar) ttsBar.style.display = 'none';
        return;
      }

      let voices = [];
      function populateVoices(){
        voices = speechSynthesis.getVoices() || [];
        voicesSelect.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.voiceURI;
          opt.textContent = `${v.name} (${v.lang})${v.default ? ' ‚Äî default' : ''}`;
          voicesSelect.appendChild(opt);
        });
        const savedVoice = localStorage.getItem('tts.voice');
        if (savedVoice && [...voices].some(v => v.voiceURI === savedVoice)) voicesSelect.value = savedVoice;
      }
      populateVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateVoices;

      function getLessonText() {
        // Collect readable text from hero and cards (avoid code tags)
        const parts = [];
        const hero = document.querySelector('.hero-left');
        if (hero) parts.push(hero.innerText.trim());
        const cards = document.querySelectorAll('#lessonGrid .card h3, #lessonGrid .card p');
        cards.forEach(n => parts.push(n.innerText.trim()));
        return parts.filter(Boolean).join('.\n');
      }

      function splitSentences(text) {
        return text.split(/(?<=[.?!])\s+/);
      }

      let sentences = [];
      let idx = 0;
      let currentUtterance = null;

      function cancelAll() {
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
      }

      function speakSentence(i) {
        if (!sentences[i]) { idx = sentences.length; return; }
        cancelAll();
        const s = sentences[i];
        const u = new SpeechSynthesisUtterance(s);
        const selURI = voicesSelect.value;
        const sel = voices.find(v => v.voiceURI === selURI) || voices.find(v => v.default) || voices[0];
        if (sel) u.voice = sel;
        u.rate = parseFloat(rateInput.value);
        u.pitch = parseFloat(pitchInput.value);
        u.onstart = () => highlightSentence(s);
        u.onend = () => {
          removeHighlights();
          idx++;
          if (idx < sentences.length) setTimeout(()=> speakSentence(idx), 120);
          else { idx = 0; currentUtterance = null; }
        };
        currentUtterance = u;
        speechSynthesis.speak(u);
      }

      function highlightSentence(sentence) {
        removeHighlights();
        // naive safe replace for the exact sentence in hero-left only (less DOM changes)
        const hero = document.querySelector('.hero-left');
        if (!hero) return;
        const html = hero.innerHTML;
        const safe = sentence.replace(/[.*+?^${}()|[\]\\]/g,'\\$&').trim();
        if (!safe) return;
        const re = new RegExp(safe);
        hero.innerHTML = html.replace(re, `<span style="background:rgba(0,255,200,0.12);padding:2px 4px;border-radius:4px">${sentence}</span>`);
      }

      function removeHighlights() {
        const hero = document.querySelector('.hero-left');
        if (!hero) return;
        const spans = hero.querySelectorAll('span');
        spans.forEach(s => {
          // only remove our highlight if it matches exactly the sentence pattern (best-effort)
          s.outerHTML = s.textContent;
        });
      }

      function speakAll() {
        const raw = getLessonText();
        sentences = splitSentences(raw);
        if (!sentences.length) return;
        idx = 0;
        speakSentence(idx);
      }

      playBtn.addEventListener('click', ()=> {
        if (speechSynthesis.paused) return speechSynthesis.resume();
        if (speechSynthesis.speaking) return;
        speakAll();
        localStorage.setItem('tts.voice', voicesSelect.value || '');
        localStorage.setItem('tts.rate', rateInput.value);
        localStorage.setItem('tts.pitch', pitchInput.value);
      });

      pauseBtn.addEventListener('click', ()=> {
        if (speechSynthesis.speaking) speechSynthesis.pause();
        else if (speechSynthesis.paused) speechSynthesis.resume();
      });

      stopBtn.addEventListener('click', ()=> {
        cancelAll(); removeHighlights();
      });

      voicesSelect.addEventListener('change', ()=> localStorage.setItem('tts.voice', voicesSelect.value));
      rateInput.addEventListener('change', ()=> localStorage.setItem('tts.rate', rateInput.value));
      pitchInput.addEventListener('change', ()=> localStorage.setItem('tts.pitch', pitchInput.value));

      const savedAuto = localStorage.getItem('tts.auto') === 'true';
      autoBtn.style.opacity = savedAuto ? '1' : '0.6';
      autoBtn.addEventListener('click', ()=> {
        const cur = localStorage.getItem('tts.auto') === 'true';
        localStorage.setItem('tts.auto', (!cur).toString());
        autoBtn.style.opacity = (!cur) ? '1' : '0.6';
      });

      // apply saved prefs on voices populated
      let tries = 0;
      const iv = setInterval(()=> {
        if (speechSynthesis.getVoices().length) {
          populateVoices();
          const sv = localStorage.getItem('tts.voice');
          if (sv && [...voices].find(v=>v.voiceURI===sv)) voicesSelect.value = sv;
          const sr = localStorage.getItem('tts.rate');
          const sp = localStorage.getItem('tts.pitch');
          if (sr) rateInput.value = sr;
          if (sp) pitchInput.value = sp;
          if (localStorage.getItem('tts.auto') === 'true') {
            try { speakAll(); } catch(e) { console.warn('Auto TTS blocked'); }
          }
          clearInterval(iv);
        } else if (++tries > 30) {
          clearInterval(iv);
        }
      }, 200);
    })();

  </script>
</body>
</html>
