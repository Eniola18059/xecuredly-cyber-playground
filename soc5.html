<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lesson 5 – Applications & Web Security (Expanded)</title>

  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2e;
      --muted: #8aa0c3;
      --text: #e7eefc;
      --accent: #6ea8ff;
      --accent-2: #7ef0c1;
      --warning: #ffdf6e;
      --danger: #ff7e93;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Noto Sans,Helvetica,Arial}
    body{color:var(--text); background:linear-gradient(135deg,#0b1220 0%,#101b34 100%); -webkit-font-smoothing:antialiased;}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(160%) blur(8px);background:rgba(11,18,32,0.7);border-bottom:1px solid rgba(255,255,255,0.06)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;font-weight:600;color:#0b1220;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:8px 12px;border-radius:999px;font-size:12px;text-transform:uppercase;letter-spacing:.06em}
    .hero{padding:28px 20px 8px}
    .title{font-size:clamp(28px,4vw,40px);line-height:1.15;margin:4px 0 10px}
    .subtitle{color:var(--muted);font-size:15px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;background:rgba(255,255,255,0.04);border-radius:999px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .card{background:radial-gradient(140% 120% at 100% 0%,#132349 0%,var(--card) 45%);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-top:16px}
    .list{margin:0;padding-left:18px}
    .list li{margin:8px 0}
    .callout{background:linear-gradient(180deg,rgba(126,240,193,.06),rgba(126,240,193,.02));border:1px solid rgba(126,240,193,.14);padding:12px 14px;border-radius:12px;margin-top:10px}
    .warn{background:linear-gradient(180deg,rgba(255,223,110,.06),rgba(255,223,110,.02));border:1px solid rgba(255,223,110,.14)}
    .long-read{line-height:1.75;font-size:15px}
    .small{font-size:13px;color:var(--muted)}
    .explain{margin-top:8px;background:rgba(0,0,0,0.18);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.05);cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0b1220;border:none}
    .tts-bar{position:fixed;right:18px;bottom:18px;z-index:9999;background:rgba(0,0,0,0.65);color:#00ffcc;padding:10px 12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6);font-family:'Share Tech Mono',monospace;display:flex;gap:8px;align-items:center;backdrop-filter:blur(6px);min-width:260px}
    .tts-bar button{background:linear-gradient(45deg,#ff0080,#7928ca);border:none;color:#fff;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer;min-width:44px}
    .tts-bar .small{padding:6px 8px;min-width:36px}
    .tts-bar select,.tts-bar input[type="range"]{background:rgba(255,255,255,0.06);color:#00ffcc;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:8px;font-family:inherit}
    .tts-highlight{background:rgba(0,255,200,0.15);transition:background 0.2s;padding:0 2px;border-radius:3px}
    footer{opacity:.7;font-size:13px;padding:30px 0 60px}
    code{background:rgba(255,255,255,0.02);padding:2px 6px;border-radius:6px;font-family:monospace}
    .kbd{background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.02)}
    @media (max-width:600px){.tts-bar{left:50%;transform:translateX(-50%);right:auto;bottom:12px;min-width:88%}}
  </style>
</head>
<body>
  <header>
    <div class="container header-row">
      <div style="display:flex;align-items:center;gap:12px">
        <span class="badge">Lesson 5</span>
        <div>
          <strong>Applications & Web Security — Expanded</strong>
          <div class="small muted">Web servers • Architecture • Attacks • Countermeasures • bWAPP LFI lab</div>
        </div>
      </div>
      <div>
        <button class="btn ghost" id="toggleTheme" title="Toggle contrast">🌗 Theme</button>
      </div>
    </div>
  </header>

  <main class="container">
    <article class="lesson-content">

      <section class="hero card">
        <h1 class="title">Applications & Web Security</h1>
        <p class="subtitle">A detailed, expanded module covering web servers, application architecture, common attacks (XSS, SQLi, CSRF, LFI), mitigation strategies, patch management and an actionable bWAPP LFI lab walkthrough.</p>
        <div class="chips">
          <span class="chip">Web Server</span>
          <span class="chip">HTTP</span>
          <span class="chip">XSS</span>
          <span class="chip">SQLi</span>
          <span class="chip">DDoS</span>
        </div>
      </section>

      <!-- Table of contents -->
      <section class="card" aria-labelledby="toc">
        <h2 id="toc" class="section-title">Table of Contents</h2>
        <ol class="list">
          <li>What is a Web Server?</li>
          <li>Web Server Architecture (Single-tier, Multi-tier, Load balancing)</li>
          <li>How Web Servers Work (DNS → HTTP/HTTPS flow)</li>
          <li>What is Web Security?</li>
          <li>Common Web Server & Application Attacks</li>
          <li>Countermeasures & Patch Management</li>
          <li>Difference: Websites vs Web Applications</li>
          <li>Web Application Architecture (Frontend/Backend/DB)</li>
          <li>Web App Attacks: SQLi, XSS, CSRF, LFI, File upload risks</li>
          <li>bWAPP LFI Walkthrough (step-by-step lab)</li>
          <li>Hands-on Labs & Further Reading</li>
        </ol>
      </section>

      <!-- What is a web server -->
      <section class="card long-read" aria-labelledby="whatserver">
        <h2 id="whatserver" class="section-title">What is a Web Server?</h2>
        <p>
          A <strong>web server</strong> is software (running on hardware) that accepts HTTP(S) requests from clients (typically browsers), processes them, and returns HTTP responses—usually webpages, API responses, files or media.
          Popular server software includes <strong>Apache</strong>, <strong>Nginx</strong>, and Microsoft <strong>IIS</strong>.
        </p>
        <div class="explain">
          <p class="small muted">Example flow (high level): <strong>Browser → DNS lookup → TCP connection (port 80/443) → HTTP request → Server processes request → HTTP response with HTML/CSS/JS → Browser renders page.</strong></p>
          <p>Web servers often sit in front of application servers (e.g., Node, Django, PHP-FPM) and may proxy, cache, route or terminate TLS for backend services.</p>
        </div>
      </section>

      <!-- web server architecture -->
      <section class="card long-read" aria-labelledby="arch">
        <h2 id="arch" class="section-title">Web Server Architecture</h2>

        <h3>Single-tier (Single Server)</h3>
        <p>
          Single-server setups combine web serving, application processing and data storage on one machine. This is simple and low-cost but quickly limits scale and fault tolerance.
        </p>
        <ul class="list">
          <li>Use when: prototypes, demos, small static sites.</li>
          <li>Limitations: single point of failure, limited concurrent connections, maintenance downtime affects entire service.</li>
        </ul>

        <h3>Multi-tier / Load-balanced architecture</h3>
        <p>
          Multi-tier designs split responsibilities: load balancer → web servers → application layer → database. Load balancers distribute traffic across many servers, improving availability and scale.
        </p>
        <ul class="list">
          <li><strong>Load balancer:</strong> hardware or software (HAProxy, Nginx, cloud LB) distributing connections.</li>
          <li><strong>Web/app servers:</strong> stateless where possible so any server can handle requests.</li>
          <li><strong>Database tier:</strong> scaled via read replicas and clustering.</li>
        </ul>

        <div class="explain">
          <p class="small muted">Design decisions like session management (sticky sessions vs shared session store) and caching (CDN, reverse proxy) critically affect performance and security.</p>
        </div>
      </section>

      <!-- how web servers work -->
      <section class="card long-read" aria-labelledby="howwork">
        <h2 id="howwork" class="section-title">How Web Servers Work — Step-by-step</h2>
        <ol class="list">
          <li><strong>User enters domain in browser</strong> (e.g., <code>example.com</code>).</li>
          <li><strong>DNS resolution:</strong> browser/system queries DNS cache or DNS servers to obtain the server's IP.</li>
          <li><strong>TCP connection:</strong> browser opens TCP connection to IP on port <code>80</code> (HTTP) or <code>443</code> (HTTPS).</li>
          <li><strong>TLS handshake (if HTTPS):</strong> client and server negotiate encryption parameters and exchange certificates.</li>
          <li><strong>HTTP request sent:</strong> client sends request line, headers, and optional body (POST data).</li>
          <li><strong>Server processing:</strong> static files are read; dynamic requests are forwarded to application layer, which may query databases or call other services.</li>
          <li><strong>Response sent:</strong> server returns status code, headers, and body (HTML/JSON/images).</li>
          <li><strong>Browser renders:</strong> browser parses HTML, requests additional resources (CSS/JS/images) and executes scripts.</li>
        </ol>
        <div class="explain">
          <p class="small muted">Understanding this flow helps pinpoint where attacks occur and where to place defenses (e.g., WAF at the edge, input validation at the app layer, encryption in transit).</p>
        </div>
      </section>

      <!-- what is web security -->
      <section class="card long-read" aria-labelledby="websec">
        <h2 id="websec" class="section-title">What is Web Security?</h2>
        <p>
          <strong>Web security</strong> is the discipline of protecting websites and web applications from threats that could damage availability, integrity, or confidentiality. It combines secure development, runtime protections, monitoring, and incident response.
        </p>

        <div class="explain">
          <p>Key practices include authentication & authorization, input validation, encryption (TLS), patching, secure configuration, logging & monitoring, and defense-in-depth.</p>
          <p class="small muted">Good web security reduces risk but cannot eliminate it—assume compromise and design for detection & rapid recovery.</p>
        </div>
      </section>

      <!-- web server attacks -->
      <section class="card long-read" aria-labelledby="attacks">
        <h2 id="attacks" class="section-title">Common Web Server & Application Attacks</h2>

        <h3>Distributed Denial-of-Service (DDoS)</h3>
        <p>
          DDoS floods a target with requests from many compromised devices (botnets) to saturate bandwidth or exhaust server resources. The 2020 AWS attack peaked at 2.3 Tbps and was mitigated by AWS protections.
        </p>

        <h3>Brute Force (e.g., SSH, login forms)</h3>
        <p>
          Automated guessing of credentials until success. Mitigations: rate limiting, account lockouts, MFA, and strong password policies.
        </p>

        <h3>Cross-Site Scripting (XSS)</h3>
        <p>
          XSS injects malicious JavaScript into pages seen by other users. Attackers can steal session tokens, perform actions as victims, or deliver malware.
        </p>

        <h3>Phishing</h3>
        <p>
          Phishing attempts trick users into disclosing credentials or clicking malicious links that lead to credential theft or drive-by downloads.
        </p>

        <h3>Web Defacement, DNS Hijacking, Server Misconfiguration, Software Exploits</h3>
        <p>
          Attackers exploit weak configs, unpatched server software, or DNS to redirect users to attacker-controlled content.
        </p>

        <div class="explain">
          <p class="small muted">Attackers commonly combine techniques: e.g., exploit a web app vulnerability to gain shell access, then use the server in a DDoS or defacement campaign.</p>
        </div>
      </section>

      <!-- attacks cont - web app attacks -->
      <section class="card long-read" aria-labelledby="webappattacks">
        <h2 id="webappattacks" class="section-title">Web Application Attacks — Deep Dive</h2>

        <h3>SQL Injection (SQLi)</h3>
        <p>
          SQLi occurs when user input is used to build database queries without proper sanitization. Attackers can read, modify or delete database contents, bypass auth, or escalate privileges.
        </p>
        <p class="small muted">Examples: classic payloads like <code>' OR '1'='1</code> can alter WHERE clauses; blind SQLi uses timing or boolean responses.</p>

        <h3>Cross-Site Scripting (XSS)</h3>
        <p>
          XSS types: reflected, stored, and DOM-based. Prevention: context-aware output encoding, Content Security Policy (CSP), and input validation.
        </p>

        <h3>Cross-Site Request Forgery (CSRF)</h3>
        <p>
          CSRF tricks an authenticated user into performing an action they did not intend (e.g., transferring money). Prevent with anti-CSRF tokens, SameSite cookies, and double-submit cookies.
        </p>

        <h3>Security Misconfigurations</h3>
        <p>
          Examples include exposed admin interfaces, default credentials, directory listings, or verbose error pages leaking stack traces. Harden servers, remove dev endpoints, and enforce least privilege.
        </p>

        <h3>File Upload Vulnerabilities</h3>
        <p>
          Unsafely processed uploads can lead to arbitrary code execution. Mitigations: validate file type/content, store outside webroot, use unique names, and run uploads under low-privilege accounts.
        </p>
      </section>

      <!-- countermeasures & patch management -->
      <section class="card long-read" aria-labelledby="counter">
        <h2 id="counter" class="section-title">Countermeasures & Patch Management</h2>

        <h3>Countermeasures</h3>
        <ul class="list">
          <li><strong>Input validation & sanitization:</strong> treat all input as hostile — use parameterized queries for DBs.</li>
          <li><strong>Least privilege:</strong> run services with minimal permissions.</li>
          <li><strong>Web Application Firewall (WAF):</strong> mitigates common attacks (injections, XSS).</li>
          <li><strong>Secure coding practices:</strong> follow OWASP Top 10 guidance during development.</li>
          <li><strong>Encrypt in transit:</strong> TLS everywhere; HSTS and secure cookies.</li>
        </ul>

        <h3>Patch Management</h3>
        <ul class="list">
          <li><strong>Regular updates:</strong> apply security patches to OS, web server, app frameworks.</li>
          <li><strong>Automated patching:</strong> where safe (test first in staging), use automation to reduce windows of exposure.</li>
          <li><strong>Vulnerability scanning:</strong> run regular scans and prioritize fixes by risk.</li>
          <li><strong>Backups & rollback:</strong> tested backups and rollback procedures reduce impact of failed patches or ransomware.</li>
        </ul>

        <div class="explain">
          <p class="small muted">Combine proactive patching with intrusion detection, logging, and an incident response plan for best results.</p>
        </div>
      </section>

      <!-- websites vs web apps -->
      <section class="card long-read" aria-labelledby="diff">
        <h2 id="diff" class="section-title">Difference Between Websites & Web Applications</h2>
        <p>
          A <strong>website</strong> traditionally serves mostly static content (pages to read), while a <strong>web application</strong> is interactive and processes user input to perform tasks (banking, shopping carts, dashboards). Modern sites blur the line — many websites are web applications.
        </p>
        <ul class="list">
          <li>Websites: static HTML/CSS, content-focused.</li>
          <li>Web applications: dynamic logic, user state, DB interactions, authentication.</li>
        </ul>
      </section>

      <!-- web app architecture -->
      <section class="card long-read" aria-labelledby="webapparch">
        <h2 id="webapparch" class="section-title">Web Application Architecture</h2>
        <p>
          Typical components are split into client-side (frontend), server-side (backend), and data stores.
        </p>

        <h3>Client-side (Frontend)</h3>
        <ul class="list">
          <li>HTML, CSS, JavaScript frameworks (React, Vue, Angular)</li>
          <li>Responsiveness, accessibility, input validation (but never trust client validation for security)</li>
        </ul>

        <h3>Server-side (Backend)</h3>
        <ul class="list">
          <li>Application logic (Node, Django, Ruby on Rails, PHP)</li>
          <li>APIs, authentication, business rules</li>
          <li>Rate limiting, logging, and error handling</li>
        </ul>

        <h3>Databases</h3>
        <ul class="list">
          <li>Relational (Postgres, MySQL) vs NoSQL (MongoDB, Redis)</li>
          <li>Design: least privilege DB accounts, parameterized queries, encryption at rest</li>
        </ul>
      </section>

      <!-- web app attacks cont / LFI -->
      <section class="card long-read" aria-labelledby="lfi">
        <h2 id="lfi" class="section-title">Local File Inclusion (LFI) — Concept & bWAPP Walkthrough</h2>
        <p>
          <strong>Local File Inclusion (LFI)</strong> is a vulnerability where an attacker can instruct a web application to include files from the server's filesystem. When exploited, LFI can expose sensitive files (like <code>/etc/passwd</code>) or escalate to code execution if combined with other flaws.
        </p>

        <div class="explain">
          <p class="small muted">LFI is common in PHP apps that include files based on user input without proper validation (e.g., <code>include($_GET['page']);</code>).</p>
        </div>

        <h3>bWAPP LFI Lab — Step-by-step (safe, local lab)</h3>
        <p class="small muted">Important: Only perform this lab in an isolated lab environment (bWAPP inside a VM). Unauthorized scanning/exploitation on networks you don't own is illegal.</p>

        <ol class="list">
          <li><strong>Start target VM and bWAPP:</strong> boot your vulnerable VM (e.g., OWASP bWAPP). Default creds are often <span class="kbd">bee/bug</span> or similar — check your lab notes.</li>
          <li><strong>Find target IP:</strong> on the target VM run <code>ifconfig</code> or <code>ip addr</code> and note the interface IP (e.g., <code>10.0.0.169</code>).</li>
          <li><strong>From attacker VM (Kali), open browser:</strong> point to <code>http://10.0.0.169</code> (replace with your target IP).</li>
          <li><strong>Login to bWAPP:</strong> use lab credentials (e.g., <span class="kbd">bee/bug</span>).</li>
          <li><strong>Select challenge:</strong> navigate to the menu and choose <em>Directory Traversal - Files</em> or the LFI challenge.</li>
          <li><strong>Trigger vulnerability:</strong> the app may use a URL parameter like <code>?page=message.txt</code>. Replace value with traversal payloads such as <code>../../../../etc/passwd</code>.</li>
          <li><strong>Example URL:</strong> <code>http://10.0.0.169/bWAPP/directory_traversal_1.php?page=../../../../etc/passwd</code></li>
          <li><strong>Observe output:</strong> the server may print contents of <code>/etc/passwd</code>. If successful, you’ll see system user entries—confirmation of LFI.</li>
          <li><strong>Post-exploitation notes:</strong> with LFI you can often read configuration files (DB credentials) or logs; chained with other issues, it may allow RCE. In labs, document findings and responsibly disclose in real engagements.</li>
        </ol>

        <div class="callout warn">
          <strong>Safety note:</strong> Do not run these techniques against systems you do not own or have explicit permission to test. Use isolated lab VMs and snapshots to avoid damage.
        </div>
      </section>

      <!-- sample attacks: XSS, SQLi, CSRF -->
      <section class="card long-read" aria-labelledby="examples">
        <h2 id="examples" class="section-title">Attack Examples & Quick Demos</h2>
        <h3>Reflected XSS (example)</h3>
        <p class="small muted">Payload example that a vulnerable search field might reflect: <code>&lt;script&gt;alert('XSS')&lt;/script&gt;</code>. Demonstration shows how scripts run in victims' browsers.</p>

        <h3>Simple SQLi (example)</h3>
        <p class="small muted">Login bypass example: submitting username <code>' OR '1'='1</code> and any password may bypass naive authentication if backend concatenates queries. Proper defense: parameterized queries and ORM usage.</p>

        <h3>CSRF (example)</h3>
        <p class="small muted">A malicious page can auto-submit a form to the bank transfer endpoint if the victim is authenticated, causing unwanted transactions. Use anti-CSRF tokens and SameSite cookie attributes.</p>
      </section>

      <!-- labs -->
      <section class="card long-read" aria-labelledby="labs">
        <h2 id="labs" class="section-title">Hands-on Labs & Exercises</h2>
        <p>Practice in an isolated environment (VirtualBox, VMware, or cloud sandboxes). Sample labs:</p>
        <ul class="list">
          <li><strong>Lab 1 — Setup a simple Apache + PHP site:</strong> host a page that includes a filename from a parameter; learn how to patch it (whitelist and sanitize).</li>
          <li><strong>Lab 2 — XSS lab:</strong> use DVWA or bWAPP to practice reflected & stored XSS and test mitigation techniques like output encoding and CSP.</li>
          <li><strong>Lab 3 — SQLi lab:</strong> use a safe test DB (e.g., Damn Vulnerable Web App) to learn blind & union-based SQLi and how parameterized queries stop them.</li>
          <li><strong>Lab 4 — Patch-harden-deploy:</strong> deploy a small app, apply updates, enable TLS, add a WAF rule, and test before/after behavior.</li>
        </ul>
        <div class="explain">
          <p class="small muted">Document every action while testing: commands, timestamps, outputs and remediation steps. This is essential for reports and learning.</p>
        </div>
      </section>

      <!-- references -->
      <section class="card long-read" aria-labelledby="refs">
        <h2 id="refs" class="section-title">References & Further Reading</h2>
        <ul class="list">
          <li>OWASP Top 10 — essential reading for web application security.</li>
          <li>bWAPP, DVWA — intentionally vulnerable apps for learning.</li>
          <li>Mozilla Web Security Guidelines — practical best practices.</li>
          <li>Tools: Burp Suite (interception/proxy), sqlmap (SQLi automation), Nikto (server scanner), Nmap (discovery).</li>
        </ul>
        <div class="explain">
          <p class="small muted">When moving to production, use vetted libraries, perform threat modeling, and include automated CI/CD scanning and runtime protection.</p>
        </div>
      </section>

      <!-- download/export -->
      <section class="card" aria-labelledby="share">
        <h2 id="share" class="section-title">Download / Export</h2>
        <p class="small muted">Download lesson notes or copy as Markdown for course materials.</p>
        <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
          <button class="btn primary" id="downloadNotes">📥 Download Notes (Text)</button>
          <button class="btn" id="copyMarkdown">📋 Copy Markdown</button>
        </div>
      </section>

    </article>

    <footer class="container">
      <p>© Learning Playground – Applications & Web Security • Lesson 5 (Expanded)</p>
    </footer>
  </main>

  <!-- TTS Control Bar -->
  <div id="ttsBar" class="tts-bar" aria-hidden="false">
    <button id="ttsPlay" title="Play">▶</button>
    <button id="ttsPause" class="small" title="Pause">⏸</button>
    <button id="ttsStop" class="small" title="Stop">⏹</button>

    <span class="label">Voice</span>
    <select id="ttsVoices" aria-label="Select voice"></select>

    <span class="label">Rate</span>
    <input id="ttsRate" type="range" min="0.6" max="2" step="0.1" value="1" />

    <span class="label">Pitch</span>
    <input id="ttsPitch" type="range" min="0.6" max="2" step="0.1" value="1" />

    <button id="ttsToggleAuto" class="small" title="Auto-read on load">A</button>
  </div>

  <script>
    /* Theme toggle (persist) */
    const themeBtn = document.getElementById('toggleTheme');
    const keyTheme = 'lesson5-theme';
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const applyTheme = (mode) => {
      if (mode === 'light') {
        document.documentElement.style.setProperty('--bg','#f7f9ff');
        document.documentElement.style.setProperty('--card','#ffffff');
        document.documentElement.style.setProperty('--text','#0b1220');
        document.documentElement.style.setProperty('--muted','#4a5875');
      } else {
        document.documentElement.style.setProperty('--bg','#0b1220');
        document.documentElement.style.setProperty('--card','#111a2e');
        document.documentElement.style.setProperty('--text','#e7eefc');
        document.documentElement.style.setProperty('--muted','#8aa0c3');
      }
    };
    const storedTheme = localStorage.getItem(keyTheme) || (prefersDark ? 'dark' : 'light');
    applyTheme(storedTheme);
    themeBtn.addEventListener('click', () => {
      const cur = localStorage.getItem(keyTheme) || storedTheme;
      const next = cur === 'dark' ? 'light' : 'dark';
      localStorage.setItem(keyTheme, next);
      applyTheme(next);
    });

    /* Download notes as text */
    document.getElementById('downloadNotes').addEventListener('click', () => {
      const title = 'Lesson5_Web_Security_Notes_Expanded.txt';
      const nodes = document.querySelectorAll('.lesson-content h1, .lesson-content h2, .lesson-content p, .lesson-content li');
      const lines = [];
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h1' || tag === 'h2') lines.push('\n' + n.innerText + '\n');
        else lines.push(n.innerText);
      });
      const content = lines.join('\n');
      const blob = new Blob([content], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = title; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
    });

    /* Copy Markdown */
    document.getElementById('copyMarkdown').addEventListener('click', async () => {
      const nodes = document.querySelectorAll('.lesson-content h1, .lesson-content h2, .lesson-content p, .lesson-content li');
      let md = '';
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h1') md += `# ${n.innerText}\n\n`;
        else if (tag === 'h2') md += `## ${n.innerText}\n\n`;
        else if (tag === 'li') md += `- ${n.innerText}\n`;
        else md += `${n.innerText}\n\n`;
      });
      try { await navigator.clipboard.writeText(md); alert('Copied lesson content as Markdown to clipboard.'); }
      catch(e){ alert('Could not copy to clipboard.'); }
    });

    /* TTS module (Web Speech API) */
    (function () {
      if (!('speechSynthesis' in window)) {
        console.warn('TTS not supported in this browser.');
        const bar = document.getElementById('ttsBar'); if (bar) bar.style.display = 'none';
        return;
      }

      const playBtn = document.getElementById('ttsPlay');
      const pauseBtn = document.getElementById('ttsPause');
      const stopBtn = document.getElementById('ttsStop');
      const voicesSelect = document.getElementById('ttsVoices');
      const rateInput = document.getElementById('ttsRate');
      const pitchInput = document.getElementById('ttsPitch');
      const autoBtn = document.getElementById('ttsToggleAuto');

      const lesson = document.querySelector('.lesson-content') || document.body;
      let utterance = null;
      let sentences = [];
      let currentIndex = 0;
      let readyVoices = [];

      const prefs = {
        voiceURI: localStorage.getItem('tts.voice') || '',
        rate: parseFloat(localStorage.getItem('tts.rate')) || 1,
        pitch: parseFloat(localStorage.getItem('tts.pitch')) || 1,
        auto: localStorage.getItem('tts.auto') === 'true' || false
      };
      rateInput.value = prefs.rate;
      pitchInput.value = prefs.pitch;
      autoBtn.style.opacity = prefs.auto ? '1' : '0.6';

      function populateVoices() {
        const voices = speechSynthesis.getVoices();
        readyVoices = voices;
        voicesSelect.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.voiceURI;
          opt.textContent = `${v.name} (${v.lang})${v.default ? ' — default' : ''}`;
          voicesSelect.appendChild(opt);
        });
        if (prefs.voiceURI) {
          const found = [...voices].find(v => v.voiceURI === prefs.voiceURI);
          if (found) voicesSelect.value = prefs.voiceURI;
        }
      }

      populateVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoices;
      }

      function getText() {
        if (!lesson) return document.body.innerText;
        const nodes = lesson.querySelectorAll('h1,h2,p,li');
        return Array.from(nodes).map(n => n.innerText.trim()).filter(Boolean).join('.\n');
      }

      function buildSentences(text) {
        return text.split(/(?<=[.?!])\s+/);
      }

      function speakFrom(index = 0) {
        const text = getText();
        sentences = buildSentences(text);
        currentIndex = index;
        if (currentIndex >= sentences.length) return;
        speakSentence(sentences[currentIndex]);
      }

      function speakSentence(sentence) {
        if (!sentence || sentence.trim() === '') {
          currentIndex++;
          if (currentIndex < sentences.length) speakSentence(sentences[currentIndex]);
          return;
        }
        cancel();

        utterance = new SpeechSynthesisUtterance(sentence);
        const voiceURI = voicesSelect.value || prefs.voiceURI;
        const selected = readyVoices.find(v => v.voiceURI === voiceURI) || readyVoices.find(v => v.default) || readyVoices[0];
        if (selected) utterance.voice = selected;
        utterance.rate = parseFloat(rateInput.value);
        utterance.pitch = parseFloat(pitchInput.value);

        utterance.onstart = () => highlightSentence(sentence);
        utterance.onend = () => {
          currentIndex++;
          if (currentIndex < sentences.length) {
            setTimeout(() => speakSentence(sentences[currentIndex]), 120);
          } else {
            clearHighlights();
          }
        };

        speechSynthesis.speak(utterance);
      }

      function cancel() {
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
      }
      function pause() { if (speechSynthesis.speaking) speechSynthesis.pause(); }
      function resume() { if (speechSynthesis.paused) speechSynthesis.resume(); }

      function highlightSentence(sentence) {
        clearHighlights();
        if (!lesson) return;
        const text = lesson.innerHTML;
        const safe = sentence.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').trim();
        if (!safe) return;
        const regex = new RegExp(safe);
        const newHtml = text.replace(regex, `<span class="tts-highlight">${sentence}</span>`);
        if (newHtml !== text) lesson.innerHTML = newHtml;
      }

      function clearHighlights() {
        if (!lesson) return;
        const highlights = lesson.querySelectorAll('.tts-highlight');
        highlights.forEach(el => {
          const txt = el.textContent;
          el.outerHTML = txt;
        });
      }

      playBtn.addEventListener('click', () => {
        if (speechSynthesis.paused) return resume();
        if (speechSynthesis.speaking) return;
        speakFrom(0);
        savePrefs();
      });
      pauseBtn.addEventListener('click', () => {
        if (speechSynthesis.speaking) pause();
        else if (speechSynthesis.paused) resume();
      });
      stopBtn.addEventListener('click', () => {
        cancel();
        clearHighlights();
      });
      voicesSelect.addEventListener('change', () => { savePrefs(); });
      rateInput.addEventListener('change', () => savePrefs());
      pitchInput.addEventListener('change', () => savePrefs());
      autoBtn.addEventListener('click', () => {
        prefs.auto = !prefs.auto;
        localStorage.setItem('tts.auto', prefs.auto);
        autoBtn.style.opacity = prefs.auto ? '1' : '0.6';
      });

      function savePrefs() {
        localStorage.setItem('tts.voice', voicesSelect.value || '');
        localStorage.setItem('tts.rate', rateInput.value);
        localStorage.setItem('tts.pitch', pitchInput.value);
      }

      function applySavedSettings() {
        rateInput.value = prefs.rate;
        pitchInput.value = prefs.pitch;
        if (prefs.voiceURI && voicesSelect.options.length) {
          voicesSelect.value = prefs.voiceURI;
        }
      }

      let attempts = 0;
      const voiceApplyInterval = setInterval(() => {
        if (speechSynthesis.getVoices().length) {
          populateVoices();
          applySavedSettings();
          clearInterval(voiceApplyInterval);
        } else if (attempts++ > 20) {
          applySavedSettings();
          clearInterval(voiceApplyInterval);
        }
      }, 300);

      window.addEventListener('load', () => {
        setTimeout(() => {
          if (prefs.auto) {
            try {
              speakFrom(0);
            } catch (e) {
              console.warn('Auto TTS blocked by browser, user must press Play to start.');
            }
          }
        }, 700);
      });

      window.__Lesson5TTS = { speakFrom, cancel, pause, resume, getText };

    })();
  </script>
</body>
</html>
