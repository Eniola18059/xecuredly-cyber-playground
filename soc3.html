<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOC 3 ‚Äì Security Tools, Data Analysis & Log Aggregation</title>
  <meta name="description" content="Chapter 3: Security Tools, Data Analysis, and Log Aggregation ‚Äî data sources, SIEM, EDR, threat intel, SOAR, and alert anatomy." />
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#8aa0c3;
      --text:#e7eefc;
      --accent:#6ea8ff;
      --accent-2:#7ef0c1;
      --warn:#ffdf6e;
      --danger:#ff7e93;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Noto Sans,Helvetica,Arial}
    body{background:linear-gradient(135deg,#0b1220 0%,#101b34 100%);color:var(--text);-webkit-font-smoothing:antialiased}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(160%) blur(8px);background:rgba(11,18,32,0.75);border-bottom:1px solid rgba(255,255,255,0.06)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;font-weight:600;color:#0b1220;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:8px 12px;border-radius:999px;font-size:12px;text-transform:uppercase}
    .hero{padding:28px 20px 8px}
    .title{font-size:clamp(28px,4vw,40px);line-height:1.15;margin:4px 0 10px}
    .subtitle{color:var(--muted);font-size:15px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .chip{padding:6px 10px;background:rgba(255,255,255,0.04);border-radius:999px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .card{background:radial-gradient(140% 120% at 100% 0%,#132349 0%,var(--card) 45%);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-top:16px}
    .long-read{line-height:1.75;font-size:15px}
    .list{padding-left:18px}
    .list li{margin:8px 0}
    .small{font-size:13px;color:var(--muted)}
    .explain{margin-top:8px;background:rgba(0,0,0,0.18);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    .callout{background:linear-gradient(180deg,rgba(126,240,193,.04),rgba(126,240,193,.02));border:1px solid rgba(126,240,193,.08);padding:10px;border-radius:10px}
    .warn{background:linear-gradient(180deg,rgba(255,223,110,.04),rgba(255,223,110,.02));border:1px solid rgba(255,223,110,.08);padding:10px;border-radius:10px}
    .kbd{background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);font-family:monospace}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.03);cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0b1220;border:none}
    pre{white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);overflow:auto}
    footer{opacity:.7;font-size:13px;padding:30px 0 60px}

    /* TTS bar styles (responsive + compact support) */
    .tts-bar{position:fixed;right:18px;bottom:18px;z-index:9999;background:rgba(0,0,0,0.72);color:#00ffcc;padding:10px 12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6);font-family:'Share Tech Mono',monospace;display:flex;gap:8px;align-items:center;backdrop-filter:blur(6px);min-width:260px;transition:all .16s ease}
    .tts-bar button{background:linear-gradient(45deg,#ff0080,#7928ca);border:none;color:#fff;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer}
    .tts-bar select,.tts-bar input[type="range"]{background:rgba(255,255,255,0.06);color:#00ffcc;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:8px;font-family:inherit}
    .tts-highlight{background:rgba(0,255,200,0.12);padding:0 2px;border-radius:3px;transition:background .12s ease}
    @media (max-width:600px){.tts-bar{left:50%;transform:translateX(-50%);right:auto;bottom:12px;min-width:88%}}
    /* Mobile-only fixed "Back to lessons" button (avoids overlapping TTS) */
    .mobile-back-btn { display: none; }
    @media (max-width: 1024px) {
      .mobile-back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        position: fixed;
        left: 16px;
        bottom: calc(14px + env(safe-area-inset-bottom));
        z-index: 9998;
        text-decoration: none;
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(255,255,255,0.98);
        color: #0b1220;
        font-weight: 700;
        box-shadow: 0 8px 28px rgba(2,6,23,0.36);
        -webkit-tap-highlight-color: transparent;
        transition: transform .12s ease, box-shadow .12s ease;
        pointer-events: auto;
        border: 1px solid rgba(0,0,0,0.06);
        backdrop-filter: blur(6px);
      }
      .mobile-back-btn:active { transform: translateY(1px); }
      .mobile-back-btn:focus { outline: 3px solid rgba(21,156,228,0.18); outline-offset: 2px; }
      .mobile-back-icon { font-size: 16px; line-height: 1; }
      .mobile-back-text { font-size: 14px; letter-spacing: .01em; }
      @media (max-width: 820px) {
        .mobile-back-btn { bottom: calc(14px + env(safe-area-inset-bottom) + 70px); left: 12px; padding: 9px 12px; }
      }
      @media (max-width: 420px) {
        .mobile-back-btn { left: 10px; padding: 9px 12px; bottom: calc(8px + env(safe-area-inset-bottom) + 70px); }
      }
    }

    /* Collapse control for compact mode */
    #ttsCollapse {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:38px;
      height:38px;
      padding:6px 8px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
      background:linear-gradient(45deg,#ff0080,#7928ca);
      color:#fff;
    }
    .tts-controls{display:flex;gap:8px;align-items:center;flex-wrap:nowrap}
    .tts-bar[data-compact="true"]{min-width:58px;max-width:58px;padding:6px;border-radius:999px;gap:0}
    .tts-bar[data-compact="true"] .tts-controls{display:none}
    .tts-bar[data-compact="true"] #ttsCollapse{border-radius:999px;padding:8px;width:38px;height:38px}
    .tts-bar:focus-within{outline:3px solid rgba(21,156,228,0.12);outline-offset:2px}

    /* small layout tweaks for narrow screens */
    @media (max-width:420px){ .container{padding:12px} .title{font-size:22px} }
  </style>
</head>
<body>
  <header>
    <div class="container header-row">
      <div style="display:flex;align-items:center;gap:12px">
        <span class="badge">SOC 3</span>
        <div>
          <strong>Chapter 3 ‚Äî Security Tools, Data Analysis & Log Aggregation</strong>
          <div class="small muted">Data sources ‚Ä¢ SIEM ‚Ä¢ EDR ‚Ä¢ SOAR ‚Ä¢ Alert anatomy</div>
        </div>
      </div>
      <div>
        <button class="btn" id="toggleTheme" title="Toggle theme">üåó Theme</button>
      </div>
    </div>
  </header>

  <main class="container">
    <article class="lesson-content">

      <section class="hero card">
        <h1 class="title">Chapter 3: Security Tools, Data Analysis, and Log Aggregation</h1>
        <p class="subtitle">Technologies that power SOC operations: logs, SIEM, EDR, packet tools, threat intel, and SOAR playbooks.</p>
        <div class="chips">
          <span class="chip">Logs</span><span class="chip">SIEM</span><span class="chip">EDR</span><span class="chip">SOAR</span><span class="chip">Threat Intel</span>
        </div>
      </section>

      <section class="card" aria-labelledby="toc">
        <h2 id="toc" class="section-title">Table of Content</h2>
        <ol class="list">
          <li>Alert analysis & data sources</li>
          <li>Core platforms: SIEM, EDR</li>
          <li>Prevention & investigation tools</li>
          <li>Threat intelligence & enrichment</li>
          <li>SOAR & automation</li>
        </ol>
      </section>

      <section class="card long-read" aria-labelledby="alertanalysis">
        <h2 id="alertanalysis" class="section-title">3.1 Alert Analysis and Data Sources (The Raw Materials)</h2>
        <p>
          The effectiveness of any SOC depends on the quantity and quality of log data ingested. Logs are the digital footprints left by system, user, and network activity. Robust detection requires comprehensive coverage across primary categories of log data.
        </p>

        <h3>3.1.1 Key Data Sources</h3>
        <p class="small muted">Below are primary data sources, their purpose, and the types of detections they enable.</p>

        <h4>Endpoint / System Logs</h4>
        <p>Purpose: Deep visibility into user activity and system changes on workstations and servers. Best use: threat lifecycle analysis once perimeter is breached.<br>
        Key detections: unauthorized process execution, installation of new services, persistence mechanisms (registry changes, scheduled tasks).</p>

        <h4>Authentication Logs (Active Directory / SSO)</h4>
        <p>Purpose: Monitor access control and identity management. Best use: track user access and anomalous login behavior.<br>
        Key detections: brute-force attacks, impossible travel, lateral movement using compromised credentials.</p>

        <h4>Network Flow Data (NetFlow / IPFIX)</h4>
        <p>Purpose: Summarized metadata about network connections ‚Äî who talked to whom, when, and how much data moved.<br>
        Key detections: C2 communication, large-scale data exfiltration, internal reconnaissance.</p>

        <h4>Proxy / Web Gateway Logs</h4>
        <p>Purpose: Track internal and outbound web activity ‚Äî destinations and request types.<br>
        Key detections: successful connections to malicious domains, phishing callbacks, anomalous user agents.</p>

        <h4>Cloud Infrastructure Logs</h4>
        <p>Purpose: Record configuration changes, provisioning, and administrative actions in cloud platforms (CloudTrail, Azure Monitor).<br>
        Key detections: unauthorized resource access, public exposure of storage, cloud IAM privilege escalation.</p>

        <h3>3.1.2 Anatomy of a Security Alert</h3>
        <p>
          A security alert is typically the result of correlating multiple raw events into a single actionable item for an analyst.
        </p>
        <ul class="list">
          <li><strong>Raw Event:</strong> Single log entry (e.g., auth failure).</li>
          <li><strong>Correlation:</strong> SIEM links multiple events to reveal a pattern (e.g., many failed logins then a successful execution).</li>
          <li><strong>Alert Generation:</strong> Final correlated event flagged with a severity rating for analyst review.</li>
        </ul>
      </section>

      <section class="card long-read" aria-labelledby="platforms">
        <h2 id="platforms" class="section-title">3.2 Core Platforms and Tools (Detection, Prevention, and Response)</h2>
        <p>The data sources above are ingested and acted upon by a suite of tools categorized by their role in the SOC workflow.</p>

        <h3>3.2.1 Foundational SOC Platforms (The Central Nervous System)</h3>
        <p><strong>Security Information and Event Management (SIEM):</strong> Central log aggregator ‚Äî normalizes, correlates, and analyzes data to detect patterns across systems. Provides a single pane of glass for security events.</p>
        <p><strong>Endpoint Detection and Response (EDR):</strong> Agents on endpoints provide continuous monitoring (processes, files, memory). EDR is essential for deep forensics and rapid containment (isolate host, kill process).</p>

        <h3>3.2.2 Prevention, Perimeter, and Investigation Tools</h3>
        <ul class="list">
          <li><strong>Vulnerability Scanners (Nessus, Qualys):</strong> Proactively discover known weaknesses and misconfigurations to feed vulnerability management.</li>
          <li><strong>Web Application Firewalls (WAF):</strong> Filter malicious Layer 7 traffic to block SQLi, XSS and other web attacks.</li>
          <li><strong>Packet & Network Analysis (Wireshark):</strong> Deep packet inspection used by advanced analysts to reconstruct attack traffic when logs aren‚Äôt enough.</li>
        </ul>

        <h3>3.2.3 Threat Intelligence and Context</h3>
        <p><strong>IoC Enrichment Services (VirusTotal, etc.):</strong> Validate file hashes, IPs, domains against global databases to provide external context during triage.</p>
        <p><strong>OSINT:</strong> Use public information to enrich investigations and validate external indicators.</p>

        <h3>3.2.4 Security Orchestration, Automation, and Response (SOAR)</h3>
        <p>
          <strong>SOAR:</strong> Connects tools using playbooks to automate repetitive response tasks‚Äîblocking IPs, isolating hosts‚Äîreducing alert fatigue and MTTR.
        </p>
      </section>

      <section class="card long-read" aria-labelledby="closing">
        <h2 id="closing" class="section-title">Closing Notes</h2>
        <p>
          Chapter 3 emphasizes that quality detection depends on high-fidelity data sources, well-tuned correlation rules, and integrated tooling. SIEM + EDR + TI + SOAR form the backbone of modern SOC capabilities. Keep data coverage broad, normalize consistently, and iterate on detection rules as threats evolve.
        </p>
      </section>

      <section class="card" aria-labelledby="download">
        <h2 id="download" class="section-title">Download / Export</h2>
        <p class="small muted">Download chapter notes or copy Markdown for your LMS.</p>
        <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
          <button class="btn primary" id="downloadNotes">üì• Download Notes (Text)</button>
          <button class="btn" id="copyMarkdown">üìã Copy Markdown</button>
        </div>
      </section>

    </article>

    <footer class="container">
      <p>¬© Learning Playground ‚Äì SOC 3 ‚Ä¢ Chapter 3: Security Tools, Data Analysis & Log Aggregation</p>
    </footer>
  </main>

  <!-- Mobile Back button (mobile & tablet only) -->
  <a href="cyber-index.html" class="mobile-back-btn" aria-label="Back to lessons (mobile)">
    <span class="mobile-back-icon" aria-hidden="true">‚óÄ</span>
    <span class="mobile-back-text">Lessons</span>
  </a>

  <!-- TTS Bar (responsive + collapsible) -->
  <div id="ttsBar" class="tts-bar" aria-hidden="false" data-compact="false" role="region" aria-label="Text to Speech Controls">
    <button id="ttsCollapse" title="Collapse/Expand TTS">‚â°</button>

    <div class="tts-controls" aria-hidden="false">
      <button id="ttsPlay" title="Play">‚ñ∂</button>
      <button id="ttsPause" class="small" title="Pause">‚è∏</button>
      <button id="ttsStop" class="small" title="Stop">‚èπ</button>

      <span class="label">Voice</span>
      <select id="ttsVoices" aria-label="Select voice"></select>

      <span class="label">Rate</span>
      <input id="ttsRate" type="range" min="0.6" max="2" step="0.1" value="1" />

      <span class="label">Pitch</span>
      <input id="ttsPitch" type="range" min="0.6" max="2" step="0.1" value="1" />

      <button id="ttsToggleAuto" class="small" title="Auto-read on load">A</button>
    </div>
  </div>

  <script>
    /* Theme toggle */
    (function () {
      const themeBtn = document.getElementById('toggleTheme');
      const keyTheme = 'soc3-theme';
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const applyTheme = (mode) => {
        if (mode === 'light') {
          document.documentElement.style.setProperty('--bg','#f7f9ff');
          document.documentElement.style.setProperty('--card','#ffffff');
          document.documentElement.style.setProperty('--text','#0b1220');
          document.documentElement.style.setProperty('--muted','#4a5875');
        } else {
          document.documentElement.style.setProperty('--bg','#0b1220');
          document.documentElement.style.setProperty('--card','#111a2e');
          document.documentElement.style.setProperty('--text','#e7eefc');
          document.documentElement.style.setProperty('--muted','#8aa0c3');
        }
      };
      const storedTheme = localStorage.getItem(keyTheme) || (prefersDark ? 'dark' : 'light');
      applyTheme(storedTheme);
      themeBtn.addEventListener('click', () => {
        const cur = localStorage.getItem(keyTheme) || storedTheme;
        const next = cur === 'dark' ? 'light' : 'dark';
        localStorage.setItem(keyTheme, next);
        applyTheme(next);
      });
    })();

    /* Download notes */
    document.getElementById('downloadNotes').addEventListener('click', () => {
      const title = 'soc3_chapter3_tools_data_logs.txt';
      const nodes = document.querySelectorAll('.lesson-content h1, .lesson-content h2, .lesson-content p, .lesson-content li, .lesson-content pre, .lesson-content h3, .lesson-content h4');
      const lines = [];
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h1' || tag === 'h2') lines.push('\n' + n.innerText + '\n');
        else lines.push(n.innerText);
      });
      const content = lines.join('\n');
      const blob = new Blob([content], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = title; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
    });

    /* Copy Markdown */
    document.getElementById('copyMarkdown').addEventListener('click', async () => {
      const nodes = document.querySelectorAll('.lesson-content h1, .lesson-content h2, .lesson-content h3, .lesson-content h4, .lesson-content p, .lesson-content li, .lesson-content pre');
      let md = '';
      nodes.forEach(n => {
        const tag = n.tagName.toLowerCase();
        if (tag === 'h1') md += `# ${n.innerText}\n\n`;
        else if (tag === 'h2') md += `## ${n.innerText}\n\n`;
        else if (tag === 'h3') md += `### ${n.innerText}\n\n`;
        else if (tag === 'h4') md += `#### ${n.innerText}\n\n`;
        else if (tag === 'li') md += `- ${n.innerText}\n`;
        else if (tag === 'pre') md += '```\n' + n.innerText + '\n```\n\n';
        else md += `${n.innerText}\n\n`;
      });
      try { await navigator.clipboard.writeText(md); alert('Copied chapter content as Markdown to clipboard.'); }
      catch(e){ alert('Could not copy to clipboard.'); }
    });

    /* Enhanced responsive TTS for SOC 3 */
    (function () {
      const HOME = 'cyber-index.html';
      const STORAGE_PREFIX = 'soc3';
      const AUTO_KEY = STORAGE_PREFIX + '.tts.auto';
      const COMPACT_KEY = STORAGE_PREFIX + '.ttsCompact';
      const RESUME_KEY = STORAGE_PREFIX + '.tts.index';
      const HINT_KEY = STORAGE_PREFIX + '.hint';
      const MOBILE_BREAK = 820;

      const ttsBar = document.getElementById('ttsBar');
      const playBtn = document.getElementById('ttsPlay');
      const pauseBtn = document.getElementById('ttsPause');
      const stopBtn = document.getElementById('ttsStop');
      const voicesSelect = document.getElementById('ttsVoices');
      const rateInput = document.getElementById('ttsRate');
      const pitchInput = document.getElementById('ttsPitch');
      const autoBtn = document.getElementById('ttsToggleAuto');
      const collapseBtn = document.getElementById('ttsCollapse');
      const lesson = document.querySelector('.lesson-content') || document.body;

      if (!('speechSynthesis' in window)) {
        console.warn('TTS not available; hiding TTS bar.');
        if (ttsBar) ttsBar.style.display = 'none';
        return;
      }

      /* inject desktop back button (non-invasive) */
      (function injectDesktopBack(){
        if (document.querySelector('.desktop-back-btn')) return;
        const btn = document.createElement('button');
        btn.className = 'desktop-back-btn';
        btn.title = 'Back to lessons';
        btn.setAttribute('aria-label','Back to lessons');
        btn.innerText = '‚óÄ Lessons';
        Object.assign(btn.style, {
          position: 'fixed',
          left: '18px',
          top: '18px',
          zIndex: 9999,
          padding: '8px 12px',
          borderRadius: '10px',
          border: '1px solid rgba(255,255,255,0.06)',
          background: 'rgba(255,255,255,0.02)',
          color: 'var(--text)',
          fontWeight: 700,
          cursor: 'pointer',
          backdropFilter: 'blur(6px)'
        });
        document.body.appendChild(btn);
        function update() { btn.style.display = window.innerWidth <= MOBILE_BREAK ? 'none' : 'inline-flex'; }
        update();
        window.addEventListener('resize', update);
        btn.addEventListener('click', () => { window.location.href = HOME; });
      })();

      /* internal state */
      const S = {
        voices: [],
        sentences: [],
        idx: parseInt(localStorage.getItem(RESUME_KEY) || '0', 10) || 0,
        utterance: null,
        auto: localStorage.getItem(AUTO_KEY) === 'true',
        compact: (localStorage.getItem(COMPACT_KEY) === 'true') || (window.matchMedia('(max-width:820px)').matches),
        readingOnScroll: false,
        muted: false
      };

      /* load voices */
      function loadVoices() {
        return new Promise((resolve) => {
          let v = speechSynthesis.getVoices();
          if (v.length) { S.voices = v; resolve(v); return; }
          speechSynthesis.onvoiceschanged = () => { v = speechSynthesis.getVoices(); S.voices = v; resolve(v); };
          setTimeout(() => { v = speechSynthesis.getVoices(); S.voices = v; resolve(v); }, 1200);
        });
      }
      async function populateVoices() {
        const voices = await loadVoices();
        if (!voicesSelect) return;
        voicesSelect.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.voiceURI || v.name;
          opt.textContent = `${v.name} (${v.lang})${v.default ? ' ‚Äî default' : ''}`;
          voicesSelect.appendChild(opt);
        });
        const stored = localStorage.getItem('tts.voice');
        if (stored) voicesSelect.value = stored;
      }
      populateVoices();

      /* build sentence objects pointing to nodes */
      function buildSentences() {
        const nodes = lesson.querySelectorAll('h1,h2,h3,p,li,pre');
        const arr = [];
        nodes.forEach(n => {
          const txt = n.innerText.trim();
          if (!txt) return;
          const parts = txt.split(/(?<=[.?!])\s+/);
          parts.forEach(p => { if (p && p.trim()) arr.push({ text: p.trim(), node: n }); });
        });
        S.sentences = arr;
      }

      /* highlighting helpers */
      function clearHighlights() {
        const els = lesson.querySelectorAll('.tts-highlight');
        els.forEach(el => el.classList.remove('tts-highlight'));
      }
      function highlightNode(node) {
        clearHighlights();
        if (!node) return;
        node.classList.add('tts-highlight');
        try { node.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) {}
      }

      /* device-aware default rate */
      function deviceDefaultRate() {
        const w = window.innerWidth;
        if (w <= 420) return 0.95;
        if (w <= 820) return 1.0;
        return 1.08;
      }

      /* speaking */
      function speakObj(obj) {
        if (!obj || !obj.text) { S.idx++; return; }
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(obj.text);
        const voiceURI = (voicesSelect && voicesSelect.value) || localStorage.getItem('tts.voice') || '';
        const selected = S.voices.find(v => v.voiceURI === voiceURI) || S.voices.find(v => v.default) || S.voices[0];
        if (selected) u.voice = selected;
        u.rate = rateInput ? parseFloat(rateInput.value) : deviceDefaultRate();
        u.pitch = pitchInput ? parseFloat(pitchInput.value) : 1.0;
        u.volume = S.muted ? 0 : 1;
        u.onstart = () => highlightNode(obj.node);
        u.onend = () => {
          S.idx++;
          localStorage.setItem(RESUME_KEY, String(S.idx));
          if (S.idx < S.sentences.length) {
            setTimeout(() => speakObj(S.sentences[S.idx]), 110);
          } else {
            S.idx = 0;
            localStorage.setItem(RESUME_KEY, '0');
            clearHighlights();
          }
        };
        S.utterance = u;
        speechSynthesis.speak(u);
      }

      /* controls */
      function play(index) {
        if (!S.sentences.length) buildSentences();
        if (typeof index === 'number') S.idx = index;
        if (S.idx >= S.sentences.length) S.idx = 0;
        if (speechSynthesis.paused) return speechSynthesis.resume();
        speakObj(S.sentences[S.idx]);
      }
      function pauseToggle() {
        if (speechSynthesis.speaking && !speechSynthesis.paused) speechSynthesis.pause();
        else if (speechSynthesis.paused) speechSynthesis.resume();
      }
      function stop() {
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
        S.idx = 0;
        localStorage.setItem(RESUME_KEY, '0');
        clearHighlights();
      }
      function speakText(text) {
        if (!text || !text.trim()) return;
        if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        const voiceURI = (voicesSelect && voicesSelect.value) || localStorage.getItem('tts.voice') || '';
        const selected = S.voices.find(v => v.voiceURI === voiceURI) || S.voices[0];
        if (selected) u.voice = selected;
        u.rate = rateInput ? parseFloat(rateInput.value) : deviceDefaultRate();
        u.pitch = pitchInput ? parseFloat(pitchInput.value) : 1.0;
        speechSynthesis.speak(u);
      }
      function toggleAuto() {
        S.auto = !S.auto;
        localStorage.setItem(AUTO_KEY, S.auto ? 'true' : 'false');
        if (autoBtn) autoBtn.style.opacity = S.auto ? '1' : '0.6';
      }
      function setCompact(flag) {
        if (!ttsBar) return;
        ttsBar.setAttribute('data-compact', flag ? 'true' : 'false');
        localStorage.setItem(COMPACT_KEY, flag ? 'true' : 'false');
      }

      /* attach UI */
      playBtn && playBtn.addEventListener('click', () => { play(0); });
      pauseBtn && pauseBtn.addEventListener('click', pauseToggle);
      stopBtn && stopBtn.addEventListener('click', stop);
      voicesSelect && voicesSelect.addEventListener('change', () => localStorage.setItem('tts.voice', voicesSelect.value));
      rateInput && rateInput.addEventListener('input', () => localStorage.setItem('tts.rate', rateInput.value));
      pitchInput && pitchInput.addEventListener('input', () => localStorage.setItem('tts.pitch', pitchInput.value));
      if (autoBtn) { autoBtn.style.opacity = S.auto ? '1' : '0.6'; autoBtn.addEventListener('click', toggleAuto); }
      if (collapseBtn) collapseBtn.addEventListener('click', () => { const cur = ttsBar.getAttribute('data-compact') === 'true'; setCompact(!cur); });

      /* initial compact & restore settings */
      (function init() {
        const storedCompact = localStorage.getItem(COMPACT_KEY);
        const shouldDefault = window.matchMedia('(max-width:820px)').matches;
        const compact = storedCompact === null ? shouldDefault : (storedCompact === 'true');
        setCompact(compact);

        const r = localStorage.getItem('tts.rate');
        const p = localStorage.getItem('tts.pitch');
        const v = localStorage.getItem('tts.voice');
        if (r && rateInput) rateInput.value = r;
        if (p && pitchInput) pitchInput.value = p;
        if (v && voicesSelect) setTimeout(()=> { try { voicesSelect.value = v; } catch(e){} }, 600);
      })();

      /* responsive adjustments */
      function handleResize() {
        const narrow = window.matchMedia('(max-width:420px)').matches;
        const tablet = window.matchMedia('(max-width:820px)').matches && !narrow;
        const userSet = localStorage.getItem(COMPACT_KEY);
        if (userSet === null) {
          if (narrow) setCompact(true);
          else setCompact(false);
        }
        if (voicesSelect) {
          if (narrow) voicesSelect.style.maxWidth = '120px';
          else if (tablet) voicesSelect.style.maxWidth = '180px';
          else voicesSelect.style.maxWidth = '240px';
        }
        const desktopBtn = document.querySelector('.desktop-back-btn');
        if (desktopBtn) desktopBtn.style.display = window.innerWidth <= MOBILE_BREAK ? 'none' : 'inline-flex';
      }
      window.addEventListener('resize', handleResize);
      window.addEventListener('orientationchange', () => setTimeout(handleResize, 260));
      handleResize();

      /* keyboard shortcuts */
      window.addEventListener('keydown', (e) => {
        const tag = (e.target && e.target.tagName || '').toLowerCase();
        if (tag === 'input' || tag === 'textarea' || e.target.isContentEditable) return;
        if (e.code === 'Space') { e.preventDefault(); if (speechSynthesis.speaking && !speechSynthesis.paused) pauseToggle(); else if (speechSynthesis.paused) pauseToggle(); else play(S.idx || 0); }
        else if (e.key === 's' || e.key === 'S') stop();
        else if (e.key === 'b' || e.key === 'B') window.location.href = HOME;
        else if (e.key === '+' || e.key === '=') { if (rateInput) { rateInput.value = Math.min(parseFloat(rateInput.value) + 0.1, parseFloat(rateInput.max)); localStorage.setItem('tts.rate', rateInput.value); } }
        else if (e.key === '-') { if (rateInput) { rateInput.value = Math.max(parseFloat(rateInput.value) - 0.1, parseFloat(rateInput.min)); localStorage.setItem('tts.rate', rateInput.value); } }
        else if (e.key === 'm' || e.key === 'M') { S.muted = !S.muted; }
        else if (e.key === 'r' || e.key === 'R') { const sel = window.getSelection().toString().trim(); if (sel) speakText(sel); }
        else if (e.key === 'a' || e.key === 'A') toggleAuto();
        else if (e.key === 't' || e.key === 'T') { S.readingOnScroll = !S.readingOnScroll; alert('Read-on-scroll: ' + (S.readingOnScroll ? 'ON' : 'OFF')); }
      });

      /* double-tap to toggle play/pause on mobile */
      (function doubleTap() {
        let last = 0;
        document.addEventListener('touchend', (ev) => {
          const now = Date.now();
          if (now - last < 350) {
            if (speechSynthesis.speaking && !speechSynthesis.paused) pauseToggle();
            else play(S.idx || 0);
            last = 0;
            return;
          }
          last = now;
        }, { passive: true });
      })();

      /* read-on-scroll using IntersectionObserver */
      (function readOnScroll() {
        if (!('IntersectionObserver' in window)) return;
        const io = new IntersectionObserver((entries) => {
          if (!S.readingOnScroll) return;
          entries.forEach(en => {
            if (en.isIntersecting && en.intersectionRatio > 0.6) {
              const node = en.target;
              const idx = S.sentences.findIndex(s => s.node === node);
              if (idx >= 0) { S.idx = idx; play(idx); }
            }
          });
        }, { threshold: [0.6] });
        function observe() {
          const nodes = lesson.querySelectorAll('h1,h2,h3,p,li,pre');
          nodes.forEach(n => io.observe(n));
        }
        observe();
        const mo = new MutationObserver(observe);
        mo.observe(lesson, { childList: true, subtree: true });
      })();

      /* expose small API */
      window.CyberEnh = {
        play: () => play(0),
        pause: () => pauseToggle(),
        stop: () => stop(),
        speakText: (t) => speakText(t),
        toggleAutoRead: () => toggleAuto(),
        selectVoice: (nameOrURI) => {
          if (!voicesSelect || !nameOrURI) return;
          const opt = Array.from(voicesSelect.options).find(o => o.value === nameOrURI || o.textContent.includes(nameOrURI));
          if (opt) { voicesSelect.value = opt.value; localStorage.setItem('tts.voice', opt.value); }
        },
        getState: () => ({ idx: S.idx, auto: S.auto, muted: S.muted })
      };

      /* auto-play if allowed */
      window.addEventListener('load', () => {
        buildSentences();
        if (S.auto) {
          try { play(S.idx || 0); } catch (e) { console.warn('Auto TTS blocked by browser, user must press Play to start.'); }
        }
      });

      /* quick hint for first-time visitors */
      if (!localStorage.getItem(HINT_KEY)) {
        setTimeout(()=> console.info('TTS shortcuts: Space play/pause ‚Ä¢ S stop ‚Ä¢ B back ‚Ä¢ +/- speed ‚Ä¢ R read selection ‚Ä¢ A toggle auto'), 1000);
        localStorage.setItem(HINT_KEY, '1');
      }

    })();
  </script>
</body>
</html>
